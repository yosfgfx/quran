<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>البحث في القرآن الكريم</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Yousef';
      src: url('./yousef-regular.woff2') format('woff2'),
           url('./yousef-regular.woff') format('woff'),
           url('./yousef-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Yousef';
      src: url('./yousef-Bold.woff2') format('woff2'),
           url('./yousef-Bold.woff') format('woff'),
           url('./yousef-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    body { font-family: 'Yousef', sans-serif; }
    h1, h2 { font-weight: 700; }
    mark { background:#fcd34d; padding:0 4px; border-radius:4px; }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 text-gray-800 min-h-screen">
  <section class="py-12 text-center">
    <h1 class="text-4xl mb-6">بحث القرآن الكريم</h1>
    <input id="searchInput" type="text" placeholder="اكتب كلمة للبحث" autocomplete="off" class="w-11/12 max-w-xl mx-auto rounded-full border border-gray-300 py-3 px-6 focus:outline-none focus:ring" />
  </section>
  <div id="results" class="max-w-3xl mx-auto px-4 grid gap-4"></div>

  <div id="overlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center" aria-hidden="true">
    <div class="bg-white rounded-xl p-6 w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto relative" role="dialog" aria-modal="true">
      <button id="closeBtn" class="absolute top-4 left-4 text-2xl font-bold">&times;</button>
      <h2 id="expandedSurahName" class="text-xl font-bold mb-4"></h2>
      <div id="expandedAyahText" class="space-y-4 leading-loose text-lg"></div>
      <audio id="player" class="w-full mt-4" controls></audio>
    </div>
  </div>

<script>
  const apiBase = 'https://api.alquran.cloud/v1';
  const searchInput = document.getElementById('searchInput');
  const resultsDiv = document.getElementById('results');
  const overlay = document.getElementById('overlay');
  const expandedSurahName = document.getElementById('expandedSurahName');
  const expandedAyahText = document.getElementById('expandedAyahText');
  const player = document.getElementById('player');
  const closeBtn = document.getElementById('closeBtn');

  let searchDelay;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchDelay);
    const query = searchInput.value.trim();
    if (!query) {
      resultsDiv.innerHTML = '<p class="text-center">الرجاء كتابة كلمة للبحث.</p>';
      return;
    }
    resultsDiv.innerHTML = '<p class="text-center">جار البحث...</p>';
    searchDelay = setTimeout(() => search(query), 300);
  });

  async function search(query) {
    try {
      const res = await fetch(`${apiBase}/search/${encodeURIComponent(query)}/all/ar`);
      const data = await res.json();
      if (!data.data || !data.data.matches.length) {
        resultsDiv.innerHTML = '<p class="text-center">لا توجد نتائج.</p>';
        return;
      }
      const html = data.data.matches.map(m => `
        <div class="result bg-white/80 shadow rounded-lg p-4 cursor-pointer hover:shadow-lg transition" data-surah="${m.surah.number}" data-ayah="${m.numberInSurah}">
          <div class="font-bold mb-2">${m.surah.name} - آية ${m.numberInSurah}</div>
          <p>${highlight(m.text, query)}</p>
        </div>`).join('');
      resultsDiv.innerHTML = html;
      addCardEvents();
    } catch(e){
      resultsDiv.innerHTML = '<p class="text-center">حدث خطأ أثناء البحث.</p>';
    }
  }

  function highlight(text, query) {
    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    return text.replace(regex, (m) => `<mark>${m}</mark>`);
  }

  function addCardEvents() {
    document.querySelectorAll('.result').forEach(card => {
      card.addEventListener('click', () => openSurah(card.dataset.surah, card.dataset.ayah));
    });
  }

  async function openSurah(surahNum, ayahNum) {
    overlay.classList.remove('hidden');
    overlay.setAttribute('aria-hidden', 'false');
    expandedSurahName.textContent = 'جار التحميل...';
    expandedAyahText.innerHTML = '';
    player.src = '';
    try {
      const res = await fetch(`${apiBase}/surah/${surahNum}/ar.asad`);
      const data = await res.json();
      if(!data.data){
        expandedSurahName.textContent = 'حدث خطأ';
        return;
      }
      expandedSurahName.textContent = `${data.data.name}`;
      expandedAyahText.innerHTML = data.data.ayahs.map(a => {
        const hl = a.numberInSurah == ayahNum ? 'bg-yellow-100' : '';
        return `<p class="${hl}">${a.text}</p>`;
      }).join('');
      player.src = `https://cdn.islamic.network/quran/audio-surah/128/ar.mahermuaiqly/${surahNum}.mp3`;
    } catch(e){
      expandedSurahName.textContent = 'حدث خطأ';
    }
  }

  function closeOverlay(){
    overlay.classList.add('hidden');
    overlay.setAttribute('aria-hidden', 'true');
    player.pause();
  }

  closeBtn.addEventListener('click', closeOverlay);
  overlay.addEventListener('click', e => { if(e.target === overlay) closeOverlay(); });
  document.addEventListener('keydown', e => { if(e.key === 'Escape' && !overlay.classList.contains('hidden')) closeOverlay(); });
</script>
</body>
</html>
