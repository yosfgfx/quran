<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>بحث متقدم في القرآن الكريم</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- خط Inter لواجهة المستخدم -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* خط Yousef للاستخدام في الواجهة */
    @font-face {
      font-family: 'Yousef';
      src: url('./yousef-regular.woff2') format('woff2'),
           url('./yousef-regular.woff') format('woff'),
           url('./yousef-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Yousef';
      src: url('./yousef-Bold.woff2') format('woff2'),
           url('./yousef-Bold.woff') format('woff'),
           url('./yousef-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    /* تعريف خط Kitab المحلي */
    @font-face {
      font-family: 'Kitab';
      src: url('./kitab-base.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Kitab';
      src: url('./kitab-base-b.woff2') format('woff2');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    body {
      font-family: 'Inter', 'Yousef', ui-sans-serif, system-ui, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', 'Yousef', ui-sans-serif, system-ui, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      font-weight: 700;
    }
    
    .font-quran { 
      font-family: 'Kitab', 'Yousef', serif; 
      font-size: 1.9rem;  
      line-height: 3;    
      direction: rtl; 
      text-align: justify; 
      letter-spacing: normal !important; /* التأكد من عدم تأثير Tailwind */
    }
    .font-quran-sm { 
        font-family: 'Kitab', 'Yousef', serif; 
        font-size: 1.5rem; 
        line-height: 2.8; 
        direction: rtl;
        text-align: right; 
        letter-spacing: normal !important; /* التأكد من عدم تأثير Tailwind */
    }
    
    .font-quran .text-amber-400,
    .font-quran-sm .text-amber-400 { 
        font-family: 'Kitab', sans-serif; 
        font-size: 1.1rem; 
        font-weight: normal;
        display: inline-block;
        vertical-align: middle; 
        padding: 0 0.2em; 
        line-height: 1; 
    }

    /* CSS من الكود الأصلي (Overlay, Expanded Card, etc.) */
    .overlay {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    .overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .expanded-card {
      background: rgba(30, 41, 59, 0.85);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(51, 65, 85, 0.5);
      color: #cbd5e1;
      border-radius: 1rem;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 20px 40px -20px rgba(0,0,0,0.5);
      max-height: 85vh;
      overflow-y: auto;
    }
    .close-btn {
      color: #94a3b8;
      transition: color 0.2s ease;
    }
    .close-btn:hover {
      color: #f59e0b;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(51, 65, 85, 0.3);
      border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }
    mark {
      background-color: rgba(251, 191, 36, 0.3);
      color: #fde68a;
      padding: 0.1em 0.25em;
      border-radius: 4px;
    }
    .ayah-highlight-active {
      background-color: rgba(251, 191, 36, 0.2);
      transition: background-color 0.3s ease;
    }
    .btn-icon svg {
        width: 1.25em;
        height: 1.25em;
        margin-left: 0.5em;
    }
    [dir="rtl"] .btn-icon svg {
        margin-left: 0;
        margin-right: 0.5em;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: #FFC107;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
        color: #f87171; /* red-400 */
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-300 min-h-screen p-4 sm:p-6 antialiased custom-scrollbar">
  <div class="max-w-4xl mx-auto">
    <header class="my-8 text-center">
      <h1 class="text-4xl sm:text-5xl font-bold text-amber-400 tracking-tight">نور البيان</h1>
      <p class="mt-2 text-lg text-slate-400">بحث في آيات القرآن الكريم</p>
    </header>

    <div class="mb-8 sticky top-4 z-40">
      <input type="text" id="searchInput" placeholder="ابحث عن كلمة أو جزء من آية..." autocomplete="off"
             class="w-full max-w-2xl mx-auto block rounded-lg border-2 border-slate-700 bg-slate-800/80
                    py-4 px-6 text-lg text-slate-100 placeholder-slate-500
                    focus:bg-slate-800 focus:ring-2 focus:ring-amber-500 focus:border-amber-500
                    outline-none backdrop-blur-sm shadow-xl transition-all duration-300" />
      <div class="mt-4 flex flex-wrap items-center gap-4 justify-center text-sm text-slate-300">
        <label class="flex items-center space-x-2 space-x-reverse">
          <span>القارئ:</span>
          <select id="reciterSelect" class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-slate-100">
            <option value="ar.almuaiqly">ماهر المعيقلي</option>
            <option value="ar.alafasy">مشاري العفاسي</option>
            <option value="ar.husary">محمود الحصري</option>
          </select>
        </label>
        <label class="flex items-center space-x-2 space-x-reverse">
          <span>التفسير:</span>
          <select id="tafsirSelect" class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-slate-100">
            <option value="1">السعدي</option>
            <option value="2">ابن كثير</option>
            <option value="3">البغوي</option>
          </select>
        </label>
      </div>
    </div>

    <div id="resultsSummary" class="text-center mb-6 text-slate-400"></div>
    <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <p id="initialMessage" class="col-span-full text-center text-slate-500 py-10">
        ...جار تحميل كامل القرآن، انتظر قليلاً
      </p>
    </div>
  </div>

  <!-- Quick Ayah View Modal -->
  <div id="overlay" class="overlay fixed inset-0 z-50 flex items-center justify-center bg-slate-900/70 backdrop-blur-sm p-4" aria-hidden="true" tabindex="-1">
    <div id="expandedCard" class="expanded-card relative w-full max-w-xl" role="dialog" aria-modal="true" aria-labelledby="expandedSurahName" aria-describedby="expandedAyahText">
      <button id="closeBtn" class="close-btn absolute top-4 left-4 p-2" aria-label="إغلاق">×</button>
      <div class="p-6 sm:p-8">
        <h2 id="expandedSurahName" class="text-xl sm:text-2xl font-bold text-amber-400 mb-3"></h2>
        <p id="expandedAyahText" class="font-quran text-slate-100 leading-relaxed mb-4"></p>
        <div class="flex flex-col items-center space-y-2">
            <button id="expandedPlayAyahBtn" class="btn-icon flex items-center justify-center w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm sm:text-base">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                استمع للآية
            </button>
            <p id="expandedAudioError" class="error-message text-center" style="display: none;"></p>
            <button id="expandedTafsirBtn" class="btn-icon flex items-center justify-center w-full bg-sky-600 hover:bg-sky-500 text-white py-2.5 px-4 rounded-lg transition-colors duration-200 text-sm sm:text-base">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C2.057 15.71 3.245 16 4.5 16h1.053c.256.162.527.296.806.399V4.804zM11 16.399c.279-.103.55-.237.806-.399H12.5c1.255 0 2.443-.29 3.5-.804V4.804C14.943 4.29 13.755 4 12.5 4S10.057 4.29 9 4.804v11.595zM10.5 18c-.256-.162-.527-.296-.806-.399V2.399c.279.103.55.237.806.399V18z"></path></svg>
                عرض التفسير
            </button>
            <p id="expandedTafsirContent" class="text-slate-100 leading-relaxed mt-4 text-sm" style="display:none;"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Full Surah View Modal -->
  <div id="surahViewModal" class="fixed inset-0 z-[60] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-2 sm:p-4 opacity-0 pointer-events-none transition-opacity duration-300" aria-hidden="true">
    <div class="bg-slate-800 w-full max-w-4xl h-[95vh] sm:h-[90vh] rounded-xl shadow-2xl flex flex-col relative border border-slate-700/70">
      <div class="p-4 sm:p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
        <h2 id="surahViewTitle" class="text-xl sm:text-2xl font-bold text-amber-400"></h2>
        <button id="closeSurahViewBtn" class="text-slate-400 hover:text-amber-400 text-3xl sm:text-4xl p-1">×</button>
      </div>
      <div id="surahViewContentWrapper" class="flex-grow overflow-hidden relative">
        <div id="surahViewContent" class="p-4 sm:p-6 space-y-2 overflow-y-auto h-full custom-scrollbar">
          <!-- Ayahs will be loaded here -->
        </div>
      </div>
      <div id="surahAudioPlayerControls" class="p-3 sm:p-4 border-t border-slate-700 flex-shrink-0">
        <div class="flex items-center space-x-3 space-x-reverse">
          <button id="playPauseSurahBtn" class="text-amber-400 hover:text-amber-300 p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-slate-800">
            <svg id="playIconSurah" class="w-7 h-7 sm:w-8 sm:h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
            <svg id="pauseIconSurah" class="w-7 h-7 sm:w-8 sm:h-8 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
          </button>
          <div class="flex-grow bg-slate-700 rounded-full h-2.5 sm:h-3 relative">
            <div id="surahProgressBar" class="bg-amber-500 h-full rounded-full transition-all duration-100" style="width: 0%"></div>
            <input type="range" id="surahSeekSlider" value="0" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          </div>
        </div>
        <div id="currentPlayingAyahInfo" class="text-xs sm:text-sm text-slate-400 mt-2 text-center"></div>
      </div>
    </div>
  </div>

<div id="loadingSpinner" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm" style="display: none;">
  <div class="loader"></div>
</div>

<audio id="globalAudioPlayer" preload="metadata"></audio>

<script>
  // ... (JavaScript code remains the same as the previous version) ...
  // The JavaScript part doesn't need to change for this font update,
  // as the font application is handled purely by CSS.
  // Make sure the JavaScript from the "previous working version for audio" is here.

  const searchInput = document.getElementById('searchInput');
  const resultsDiv = document.getElementById('results');
  const resultsSummaryDiv = document.getElementById('resultsSummary');
  const initialMessage = document.getElementById('initialMessage');
  const reciterSelect = document.getElementById('reciterSelect');
  const tafsirSelect = document.getElementById('tafsirSelect');

  const API_BASE_URL = 'https://api.alquran.cloud/v1';
  const QURAN_TEXT_EDITION = 'ar.quran-uthmani';
  let currentAudioEdition = 'ar.almuaiqly';
  let currentTafsirId = '1';

  reciterSelect.addEventListener('change', () => {
    currentAudioEdition = reciterSelect.value;
  });

  tafsirSelect.addEventListener('change', () => {
    currentTafsirId = tafsirSelect.value;
  });

  let allAyahs = [];

  const loadingSpinner = document.getElementById('loadingSpinner');
  const showLoading = () => loadingSpinner.style.display = 'flex';
  const hideLoading = () => loadingSpinner.style.display = 'none';

  const globalAudioPlayer = document.getElementById('globalAudioPlayer');
  let currentPlayingAyahElement = null;
  let currentPlayingAyahGlobalNumber = null; 
  
  const surahPlayIcon = document.getElementById('playIconSurah');
  const surahPauseIcon = document.getElementById('pauseIconSurah');
  const surahProgressBar = document.getElementById('surahProgressBar');
  const surahSeekSlider = document.getElementById('surahSeekSlider');
  const currentPlayingAyahInfo = document.getElementById('currentPlayingAyahInfo');
  let surahAyahsDataForView = [];
  let currentSurahAyahIdx = 0;
  let isSurahPlaying = false;

  let ayahDataForViewOnError = null; 

  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function removeTashkeel(text) {
    if (typeof text !== 'string') return '';
    return text
      .replace(/[\u064B-\u0652]/g, '')
      .replace(/ٱ|[أإآ]/g, 'ا')
      .replace(/ى/g, 'ي')
      .replace(/ة/g, 'ه');
  }

  function highlight(text, query) {
    if (!query || typeof text !== 'string') return text;
    try {
        const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        return text.replace(regex, (match) => `<mark>${match}</mark>`);
    } catch (e) {
        console.warn("Highlighting regex error:", e);
        return text;
    }
  }

  async function loadQuran() {
    initialMessage.textContent = "...جار تحميل كامل القرآن، انتظر قليلاً";
    try {
      // We fetch `ar.quran-uthmani` as it usually has better text for display and global ayah numbers.
      const response = await fetch(`${API_BASE_URL}/quran/${QURAN_TEXT_EDITION}`); 
      const data = await response.json();

      if (data.code !== 200 || !data.data || !data.data.surahs) {
        initialMessage.innerHTML = '<p class="text-red-400">حدث خطأ في تحميل القرآن.</p>';
        return;
      }

      allAyahs = [];
      data.data.surahs.forEach(surah => {
        surah.ayahs.forEach(ayah => {
          allAyahs.push({
            surahNumber: surah.number,
            surahName: surah.name,
            numberInSurah: ayah.numberInSurah,
            text: ayah.text,
            ayahGlobalNumber: ayah.number // Crucial for audio and detailed view
          });
        });
      });
      
      initialMessage.innerHTML = '<p class="text-green-400">تم تحميل القرآن. ابدأ بالبحث!</p>';
      setTimeout(() => {
          if (initialMessage.parentNode === resultsDiv && searchInput.value.length === 0) {
              initialMessage.remove();
          }
      }, 3000);

    } catch (error) {
      initialMessage.innerHTML = `<p class="text-red-400">حدث خطأ أثناء تحميل القرآن: ${error.message}</p>`;
      console.error(error);
    }
  }

  function performLocalSearch(originalQuery) {
    if (initialMessage && initialMessage.parentNode === resultsDiv) {
      initialMessage.remove();
    }

    if (originalQuery.length === 0) {
      resultsDiv.innerHTML = '<p class="col-span-full text-center text-slate-500 py-10">الرجاء كتابة كلمة أو حرف للبحث.</p>';
      resultsSummaryDiv.textContent = '';
      return;
    }

    const normalizedQuery = removeTashkeel(originalQuery);
    const searchResults = allAyahs.filter(ayah => removeTashkeel(ayah.text).includes(normalizedQuery));

    if (searchResults.length === 0) {
      resultsDiv.innerHTML = `<p class="col-span-full text-center text-slate-400 py-10">لا توجد نتائج مطابقة لـ "${originalQuery}".</p>`;
      resultsSummaryDiv.textContent = '';
      return;
    }

    let html = '';
    searchResults.forEach(ayah => {
      html += `
        <div class="result-card bg-slate-800/70 backdrop-blur-md p-5 rounded-xl shadow-lg hover:shadow-amber-500/20 transition-all duration-300 flex flex-col space-y-3"
             data-surah-number="${ayah.surahNumber}"
             data-ayah-number-in-surah="${ayah.numberInSurah}"
             data-ayah-global-number="${ayah.ayahGlobalNumber}"
             data-surah-name="${ayah.surahName}"
             data-ayah-text-raw="${ayah.text.replace(/"/g, '"')}">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-amber-400">${ayah.surahName} - آية ${ayah.numberInSurah}</h3>
            <span class="text-xs text-slate-500">الآية ${ayah.ayahGlobalNumber} في المصحف</span>
          </div>
          <p class="font-quran-sm text-slate-200 leading-relaxed ayah-text-container">${highlight(ayah.text, originalQuery)}</p>
          <div class="flex flex-col space-y-2 pt-3 border-t border-slate-700/50 mt-auto">
            <div class="flex space-x-3 space-x-reverse">
                <button class="btn-play-ayah btn-icon flex items-center justify-center flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                استماع
                </button>
                <button class="btn-view-surah btn-icon flex items-center justify-center flex-1 bg-sky-600 hover:bg-sky-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C2.057 15.71 3.245 16 4.5 16h1.053c.256.162.527.296.806.399V4.804zM11 16.399c.279-.103.55-.237.806-.399H12.5c1.255 0 2.443-.29 3.5-.804V4.804C14.943 4.29 13.755 4 12.5 4S10.057 4.29 9 4.804v11.595zM10.5 18c-.256-.162-.527-.296-.806-.399V2.399c.279.103.55.237.806.399V18z"></path></svg>
                عرض السورة
                </button>
                <button class="btn-quick-view btn-icon flex items-center justify-center flex-1 bg-violet-600 hover:bg-violet-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.18l.879-.585A1.734 1.734 0 002.6 8.22c.312-.449.74-.832 1.208-1.142a11.247 11.247 0 0011.384 0c.468.31.896.693 1.208 1.142a1.734 1.734 0 001.057.585l.879.585a1.651 1.651 0 010 1.18l-.879.585a1.734 1.734 0 00-1.057.585c-.312.449-.74.832-1.208 1.142a11.247 11.247 0 00-11.384 0c-.468-.31-.896-.693-1.208-1.142a1.734 1.734 0 00-1.057-.585l-.879-.585zM10 14a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"></path></svg>
                نظرة سريعة
                </button>
            </div>
            <p class="audio-error-placeholder error-message text-center" style="display: none;"></p>
          </div>
        </div>
      `;
    });
    resultsDiv.innerHTML = html;
    resultsSummaryDiv.textContent = `تم العثور على ${searchResults.length} آية مطابقة.`;
    addResultCardListeners();
  }

  searchInput.addEventListener('input', debounce(() => {
    const query = searchInput.value.trim();
    performLocalSearch(query);
  }, 300));

  const overlay = document.getElementById('overlay');
  const expandedCard = document.getElementById('expandedCard');
  const closeBtn = document.getElementById('closeBtn');
  const expandedSurahName = document.getElementById('expandedSurahName');
  const expandedAyahText = document.getElementById('expandedAyahText');
  const expandedPlayAyahBtn = document.getElementById('expandedPlayAyahBtn');
  const expandedAudioError = document.getElementById('expandedAudioError');
  const expandedTafsirBtn = document.getElementById('expandedTafsirBtn');
  const expandedTafsirContent = document.getElementById('expandedTafsirContent');
  let expandedAyahGlobalNum = null;
  let expandedSurahNumber = null;
  let expandedAyahNumberInSurah = null;

  function openExpandedCard(surahName, ayahText, ayahGlobalNumber) {
    expandedSurahName.textContent = surahName;
    expandedAyahText.innerHTML = ayahText;
    expandedAyahGlobalNum = ayahGlobalNumber;
    expandedAudioError.style.display = 'none';
    expandedTafsirContent.style.display = 'none';
    expandedTafsirContent.textContent = '';
    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');
    closeBtn.focus();
  }
  function closeExpandedCard() {
    searchInput.focus();
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden', 'true');
    stopAudio();
  }
  closeBtn.addEventListener('click', closeExpandedCard);
  overlay.addEventListener('click', (e) => { if (e.target === overlay) closeExpandedCard(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && overlay.classList.contains('active')) closeExpandedCard(); });
  
  expandedPlayAyahBtn.addEventListener('click', () => {
    if (expandedAyahGlobalNum) {
      expandedAudioError.style.display = 'none';
      playAyahAudio(expandedAyahGlobalNum, null, expandedPlayAyahBtn, expandedAudioError)
        .catch(err => { /* UI handled in playAyahAudio */ });
    }
  });

  expandedTafsirBtn.addEventListener('click', async () => {
    if (!expandedSurahNumber || !expandedAyahNumberInSurah) return;
    expandedTafsirBtn.disabled = true;
    expandedTafsirContent.style.display = 'block';
    expandedTafsirContent.textContent = '...جاري جلب التفسير';
    try {
      const verseKey = `${expandedSurahNumber}:${expandedAyahNumberInSurah}`;
      const resp = await fetch(`https://api.quran.com/api/v4/tafsirs/${currentTafsirId}?verse_key=${verseKey}`);
      const data = await resp.json();
      const tafsirText = data.tafsir ? data.tafsir.text : (data.tafsirs && data.tafsirs[0] ? data.tafsirs[0].text : '');
      expandedTafsirContent.textContent = tafsirText || 'تعذر جلب التفسير';
    } catch (err) {
      expandedTafsirContent.textContent = 'تعذر جلب التفسير';
    }
    expandedTafsirBtn.disabled = false;
  });

  const surahViewModal = document.getElementById('surahViewModal');
  const surahViewTitle = document.getElementById('surahViewTitle');
  const surahViewContent = document.getElementById('surahViewContent');
  const closeSurahViewBtn = document.getElementById('closeSurahViewBtn');

  async function displayFullSurah(surahNumber, surahName, ayahToHighlightGlobalNum) {
    showLoading();
    surahViewTitle.textContent = surahName;
    surahViewContent.innerHTML = '<div class="text-center p-10 text-slate-400">جاري تحميل السورة...</div>';
    surahViewModal.classList.remove('opacity-0', 'pointer-events-none');
    surahViewModal.classList.add('opacity-100', 'pointer-events-auto');
    surahViewModal.setAttribute('aria-hidden', 'false');
    closeSurahViewBtn.focus();

    try {
      const response = await fetch(`${API_BASE_URL}/surah/${surahNumber}/${QURAN_TEXT_EDITION}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();

      if (data.code !== 200 || !data.data || !data.data.ayahs) {
        surahViewContent.innerHTML = `<p class="text-center text-red-400 p-10">خطأ في تحميل بيانات السورة.</p>`;
        hideLoading();
        return;
      }

      surahAyahsDataForView = data.data.ayahs.map((ayah, index) => ({
        ...ayah,
        localIndex: index,
        elementId: `surah-ayah-${surahNumber}-${ayah.numberInSurah}`
      }));

      let ayahsHtml = '';
      surahAyahsDataForView.forEach(ayah => {
        ayahsHtml += `
          <div id="${ayah.elementId}" class="surah-ayah-item p-3 rounded-md hover:bg-slate-700/50 transition-colors duration-150" data-ayah-local-idx="${ayah.localIndex}">
            <p class="font-quran text-slate-100 mb-1">${ayah.text}
              <span class="text-amber-400 text-lg select-none">﴿${ayah.numberInSurah}﴾</span>
            </p>
          </div>
        `;
      });
      surahViewContent.innerHTML = ayahsHtml;
      
      currentSurahAyahIdx = 0;
      isSurahPlaying = false;
      updateSurahPlayPauseIcons();
      surahProgressBar.style.width = '0%';
      currentPlayingAyahInfo.textContent = '';

      if (ayahToHighlightGlobalNum) {
        const targetAyahData = surahAyahsDataForView.find(a => a.number === ayahToHighlightGlobalNum);
        if (targetAyahData) {
            const targetElement = document.getElementById(targetAyahData.elementId);
            if (targetElement) {
                targetElement.classList.add('bg-amber-500/10', 'ring-1', 'ring-amber-500/30');
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentSurahAyahIdx = targetAyahData.localIndex;
            }
        }
      } else {
         surahViewContent.scrollTop = 0;
      }

    } catch (error) {
      surahViewContent.innerHTML = `<p class="text-center text-red-400 p-10">حدث خطأ أثناء تحميل السورة: ${error.message}</p>`;
      console.error("Error in displayFullSurah:", error);
    } finally {
      hideLoading();
    }
  }

  function closeSurahView() {
    searchInput.focus();
    surahViewModal.classList.add('opacity-0', 'pointer-events-none');
    surahViewModal.classList.remove('opacity-100', 'pointer-events-auto');
    surahViewModal.setAttribute('aria-hidden', 'true');
    stopAudio();
  }
  closeSurahViewBtn.addEventListener('click', closeSurahView);
  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape' && surahViewModal.classList.contains('opacity-100')) {
        closeSurahView(); 
    }
  });

  function addResultCardListeners() {
    document.querySelectorAll('.result-card').forEach(card => {
      const surahNum = card.dataset.surahNumber;
      const surahName = card.dataset.surahName;
      const ayahGlobalNum = parseInt(card.dataset.ayahGlobalNumber);
      const highlightedAyahHTML = card.querySelector('.ayah-text-container').innerHTML;
      const playButton = card.querySelector('.btn-play-ayah');
      const errorPlaceholder = card.querySelector('.audio-error-placeholder');

      playButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if(errorPlaceholder) errorPlaceholder.style.display = 'none';
        playAyahAudio(ayahGlobalNum, card.querySelector('.ayah-text-container'), playButton, errorPlaceholder)
            .catch(err => { /* Individual card click error is handled by playAyahAudio UI updates */ });
      });
      card.querySelector('.btn-view-surah').addEventListener('click', (e) => {
        e.stopPropagation();
        displayFullSurah(surahNum, surahName, ayahGlobalNum);
      });
      card.querySelector('.btn-quick-view').addEventListener('click', (e) => {
        e.stopPropagation();
        expandedSurahNumber = surahNum;
        expandedAyahNumberInSurah = card.dataset.ayahNumberInSurah;
        openExpandedCard(`${surahName} - آية ${card.dataset.ayahNumberInSurah}`, highlightedAyahHTML, ayahGlobalNum);
      });
    });
  }

  function playAyahAudio(ayahGlobalNumToPlay, textElementToHighlight, buttonElement, errorElement) {
    const prevEndedHandler = globalAudioPlayer._handleAudioEnded;
    const prevErrorHandler = globalAudioPlayer._handleAudioError;
    if (prevEndedHandler) globalAudioPlayer.removeEventListener('ended', prevEndedHandler);
    if (prevErrorHandler) globalAudioPlayer.removeEventListener('error', prevErrorHandler);

    return new Promise((resolve, reject) => {
        stopAudio(); 
        if (errorElement) errorElement.style.display = 'none';

        currentPlayingAyahGlobalNumber = ayahGlobalNumToPlay;
        
        if (!currentPlayingAyahGlobalNumber && currentPlayingAyahGlobalNumber !== 0) { // Allow 0 if it's a valid number for some reason
             console.error("playAyahAudio called with invalid ayahGlobalNum:", currentPlayingAyahGlobalNumber);
             if(errorElement) {
                errorElement.textContent = "خطأ: رقم الآية غير صحيح.";
                errorElement.style.display = 'block';
             }
             cleanupAfterAudio(true, buttonElement, errorElement);
             return reject(new Error("Invalid Ayah Number"));
        }
        
        const handleAudioEnded = () => {
            cleanupAfterAudio(false, buttonElement, errorElement);
            if (isSurahPlaying) {
                currentSurahAyahIdx++;
                playNextAyahInSurah();
            }
            resolve();
        };

        const handleAudioError = (event) => {
            const audioError = event && event.target && event.target.error ? event.target.error : {name: "UnknownError", message: "Unknown audio error"};
            const errorName = audioError.name || "Error"; // Provide default if name is undefined
            const errorMessageText = audioError.message || "Unknown audio error"; // Provide default if message is undefined
            console.error(`Audio error for Ayah ${currentPlayingAyahGlobalNumber}: ${errorName} ${errorMessageText}`);
            
            const userErrorMessage = "عفواً، الملف الصوتي لهذه الآية غير متاح حالياً.";
            if (errorElement) {
                errorElement.textContent = userErrorMessage;
                errorElement.style.display = 'block';
            } else if (buttonElement && buttonElement.id === 'expandedPlayAyahBtn') {
                expandedAudioError.textContent = userErrorMessage;
                expandedAudioError.style.display = 'block';
            } else if (isSurahPlaying) {
                currentPlayingAyahInfo.textContent = `خطأ: ${userErrorMessage} (آية ${ayahDataForViewOnError?.numberInSurah || currentPlayingAyahGlobalNumber})`;
            }
            
            cleanupAfterAudio(true, buttonElement, errorElement);
            reject(audioError); 
        };

        globalAudioPlayer._handleAudioEnded = handleAudioEnded;
        globalAudioPlayer._handleAudioError = handleAudioError;

        fetch(`${API_BASE_URL}/ayah/${currentPlayingAyahGlobalNumber}/${currentAudioEdition}`)
          .then(resp => resp.json())
          .then(data => {
            if (!data || !data.data || !data.data.audio) {
              throw new Error('no_audio');
            }
            globalAudioPlayer.src = data.data.audio;
            globalAudioPlayer.addEventListener('ended', handleAudioEnded, { once: true });
            globalAudioPlayer.addEventListener('error', handleAudioError, { once: true });

            const playPromise = globalAudioPlayer.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    if (textElementToHighlight) {
                        currentPlayingAyahElement = textElementToHighlight;
                        currentPlayingAyahElement.classList.add('ayah-highlight-active');
                    } else if (overlay.classList.contains('active')) {
                        currentPlayingAyahElement = expandedAyahText;
                        if (currentPlayingAyahElement) currentPlayingAyahElement.classList.add('ayah-highlight-active');
                    }
                    if (buttonElement) {
                        buttonElement.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg> جار التشغيل...`;
                        buttonElement.disabled = true;
                    }
                })
                .catch(error => {
                    console.warn(`play() promise rejected for Ayah ${currentPlayingAyahGlobalNumber}: ${error.name || 'Error'} ${error.message || 'No message'}`);
                    const syntheticErrorEvent = { target: { error: error }};
                    handleAudioError(syntheticErrorEvent);
                });
            } else {
                const oldBrowserError = new Error('Playback initiation not supported by promise.');
                handleAudioError({target: {error: oldBrowserError}});
            }
          })
          .catch(err => {
            handleAudioError({target: {error: err}});
          });
    });
  }
  
  function stopAudio() {
    globalAudioPlayer.pause();
    if (globalAudioPlayer.src) {
        globalAudioPlayer.src = ""; 
    }
    if (globalAudioPlayer._handleAudioEnded) {
        globalAudioPlayer.removeEventListener('ended', globalAudioPlayer._handleAudioEnded);
        delete globalAudioPlayer._handleAudioEnded;
    }
    if (globalAudioPlayer._handleAudioError) {
        globalAudioPlayer.removeEventListener('error', globalAudioPlayer._handleAudioError);
        delete globalAudioPlayer._handleAudioError;
    }

    cleanupAfterAudio(); 
    if (isSurahPlaying) {
        isSurahPlaying = false;
        updateSurahPlayPauseIcons();
    }
  }

  function cleanupAfterAudio(isError = false, specificButton = null, specificErrorElement = null) {
    if (currentPlayingAyahElement) {
      currentPlayingAyahElement.classList.remove('ayah-highlight-active');
      currentPlayingAyahElement = null;
    }

    if (specificButton) {
        specificButton.disabled = false;
        const defaultText = specificButton.id === 'expandedPlayAyahBtn' ? 'استمع للآية' : 'استماع';
        specificButton.innerHTML = `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg> ${defaultText}`;
        if (specificErrorElement && !isError) { 
            specificErrorElement.style.display = 'none';
        }
    } else { 
        document.querySelectorAll('.btn-play-ayah[disabled], #expandedPlayAyahBtn[disabled]').forEach(btn => {
            btn.disabled = false;
            const defaultText = btn.id === 'expandedPlayAyahBtn' ? 'استمع للآية' : 'استماع';
            btn.innerHTML = `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg> ${defaultText}`;
            
            const card = btn.closest('.result-card');
            if (card) {
                const errPlc = card.querySelector('.audio-error-placeholder');
                if (errPlc) errPlc.style.display = 'none'; 
            }
            if (btn.id === 'expandedPlayAyahBtn') {
                expandedAudioError.style.display = 'none';
            }
        });
    }
    currentPlayingAyahGlobalNumber = null;
  }

  function updateSurahPlayPauseIcons() {
    if (isSurahPlaying) {
      surahPlayIcon.classList.add('hidden');
      surahPauseIcon.classList.remove('hidden');
    } else {
      surahPlayIcon.classList.remove('hidden');
      surahPauseIcon.classList.add('hidden');
    }
  }

  async function playNextAyahInSurah() {
    if (!isSurahPlaying || currentSurahAyahIdx >= surahAyahsDataForView.length) {
      isSurahPlaying = false;
      updateSurahPlayPauseIcons();
      if (currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
      currentPlayingAyahInfo.textContent = surahAyahsDataForView.length > 0 ? "انتهت تلاوة السورة" : "لا توجد آيات لتلاوتها";
      surahProgressBar.style.width = surahAyahsDataForView.length > 0 ? '100%' : '0%';
      ayahDataForViewOnError = null;
      return;
    }

    const ayahData = surahAyahsDataForView[currentSurahAyahIdx];
    ayahDataForViewOnError = ayahData; 
    const ayahElement = document.getElementById(ayahData.elementId);

    if (currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
    if (ayahElement) {
        ayahElement.classList.add('ayah-highlight-active');
        ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        currentPlayingAyahElement = ayahElement;
    }
    
    currentPlayingAyahInfo.textContent = `جاري تلاوة: ${surahViewTitle.textContent} - الآية ${ayahData.numberInSurah}`;
    
    try {
        await playAyahAudio(ayahData.number, null, null, null); 
        // If successful, 'ended' handler in playAyahAudio will have incremented currentSurahAyahIdx and called playNextAyahInSurah
    } catch (error) {
        console.log(`Error caught by playNextAyahInSurah for Ayah ${ayahData.numberInSurah} (Global: ${ayahData.number}). isSurahPlaying: ${isSurahPlaying}. Error: ${error.message || error}`);
        if (isSurahPlaying) { 
            currentPlayingAyahInfo.textContent = `خطأ في الآية ${ayahData.numberInSurah}, محاولة الانتقال للتالية...`;
            currentSurahAyahIdx++; 
            setTimeout(playNextAyahInSurah, 1000); 
        } else {
            updateSurahPlayPauseIcons(); 
            ayahDataForViewOnError = null;
        }
    }

    globalAudioPlayer.ontimeupdate = () => {
        if (globalAudioPlayer.duration && surahAyahsDataForView.length > 0 && isSurahPlaying) {
            const currentAyahProgress = globalAudioPlayer.currentTime / globalAudioPlayer.duration;
            const validCurrentSurahAyahIdx = Math.min(currentSurahAyahIdx, surahAyahsDataForView.length - 1);
            const overallProgress = ((validCurrentSurahAyahIdx + currentAyahProgress) / surahAyahsDataForView.length) * 100;
            
            surahProgressBar.style.width = `${Math.min(100, Math.max(0, overallProgress))}%`;
            surahSeekSlider.value = Math.min(100, Math.max(0, overallProgress));
        }
    };
  }

  document.getElementById('playPauseSurahBtn').addEventListener('click', () => {
    if (surahAyahsDataForView.length === 0) return;
    
    if (isSurahPlaying) { 
        isSurahPlaying = false;
        globalAudioPlayer.pause(); 
        currentPlayingAyahInfo.textContent = "التلاوة متوقفة مؤقتاً";
    } else { 
        isSurahPlaying = true;
        if (globalAudioPlayer.paused && globalAudioPlayer.src && 
            currentPlayingAyahGlobalNumber === surahAyahsDataForView[currentSurahAyahIdx]?.number) {
            
            const resumePromise = globalAudioPlayer.play();
            if (resumePromise !== undefined) {
                resumePromise.catch(err => {
                    console.error("Resume error:", err);
                    isSurahPlaying = false; 
                    currentPlayingAyahInfo.textContent = "خطأ عند استئناف التلاوة.";
                    updateSurahPlayPauseIcons(); 
                });
            }
        } else {
            playNextAyahInSurah();
        }
    }
    updateSurahPlayPauseIcons();
  });

  document.getElementById('surahSeekSlider').addEventListener('input', (e) => {
      if (surahAyahsDataForView.length === 0) return;
      
      const wasPlaying = isSurahPlaying; 
      isSurahPlaying = false; 
      stopAudio(); 

      const seekPercentage = parseFloat(e.target.value);
      const targetAyahAbsoluteIdx = (seekPercentage / 100) * surahAyahsDataForView.length;
      let newAyahIdx = Math.floor(targetAyahAbsoluteIdx);
      
      if (newAyahIdx >= surahAyahsDataForView.length) newAyahIdx = surahAyahsDataForView.length - 1;
      if (newAyahIdx < 0) newAyahIdx = 0;

      currentSurahAyahIdx = newAyahIdx;
      
      if(currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
      const ayahDataSeeked = surahAyahsDataForView[currentSurahAyahIdx];
      if (ayahDataSeeked) {
          const ayahElement = document.getElementById(ayahDataSeeked.elementId);
          if (ayahElement) {
              ayahElement.classList.add('ayah-highlight-active');
              currentPlayingAyahElement = ayahElement; 
          }
          currentPlayingAyahInfo.textContent = `متوقف عند: ${surahViewTitle.textContent} - الآية ${ayahDataSeeked.numberInSurah}`;
      }
      surahProgressBar.style.width = `${seekPercentage}%`;

      if (wasPlaying) { 
          isSurahPlaying = true;
          playNextAyahInSurah();
      }
      updateSurahPlayPauseIcons(); 
  });

  loadQuran();
  hideLoading();
</script>
</body>
</html>
