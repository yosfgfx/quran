<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>القرآن الكريم</title>
  <link rel="icon" type="image/png" sizes="16x16" href="/icon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32x32.png">
  <link rel="icon" type="image/png" sizes="64x64" href="/icon-64x64.png">
  <link rel="icon" type="image/png" sizes="128x128" href="/icon-128x128.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-256x256.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="yosfgfx.github.io/quran/"> <!-- استبدل هذا برابط موقعك الفعلي -->
  <meta property="og:title" content="القرآن الكريم - إِنْ هُوَ إِلَّا وَحْيٌ يُوحَى"> <!-- عنوان جذاب يظهر عند المشاركة -->
  <meta property="og:description" content="ابحث في آيات القرآن الكريم واستمع إليها. موقع متكامل لتصفح وقراءة القرآن الكريم مع ميزات بحث متقدمة واستماع للآيات."> <!-- وصف موجز للموقع -->
  <meta property="og:image" content="yosfgfx.github.io/quran/meta.jpeg"> <!-- المسار الكامل لصورة meta.jpeg -->
  <meta property="og:image:width" content="1200"> <!-- العرض الموصى به للصورة -->
  <meta property="og:image:height" content="630"> <!-- الارتفاع الموصى به للصورة -->
  <meta property="og:locale" content="ar_AR"> <!-- لغة الموقع -->

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image"> <!-- نوع البطاقة (صورة كبيرة) -->
  <meta name="twitter:url" content="yosfgfx.github.io/quran/"> <!-- استبدل هذا برابط موقعك الفعلي -->
  <meta name="twitter:title" content="القرآن الكريم - إِنْ هُوَ إِلَّا وَحْيٌ يُوحَى">
  <meta name="twitter:description" content="ابحث في آيات القرآن الكريم واستمع إليها. موقع متكامل لتصفح وقراءة القرآن الكريم.">
  <meta name="twitter:image" content="https://yosfgfx.github.io/quran/meta.jpeg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Kitab'; 
      src: url('./kitab-base.woff2') format('woff2'),
           url('./kitab-base.woff') format('woff'),
           url('./kitab-base.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Kitab';
      src: url('./kitab-base-b.woff2') format('woff2'),
           url('./kitab-base-b.woff') format('woff'),
           url('./kitab-base-b.ttf') format('truetype');
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Kitab';
      src: url('./kitab-base.woff2') format('woff2'); 
      font-weight: normal;
      font-style: normal;
      font-display: swap; 
    }
    @font-face {
      font-family: 'Yousef'; 
      src: url('./yousef-regular.woff2') format('woff2'),
           url('./yousef-regular.woff') format('woff'),
           url('./yousef-regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Yousef-bold';
      src: url('./yousef-bold.woff2') format('woff2'),
           url('./yousef-bold.woff') format('woff'),
           url('./yousef-bold.ttf') format('truetype');
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }

    body {
      font-family: 'Inter', 'Kitab', ui-sans-serif, system-ui, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Inter', 'Yousef-bold', ui-sans-serif, system-ui, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      font-weight: 700; /* Using Inter's heavier weights */
    }
    
    #animatedInstructionText {
      font-weight: 400;
      font-family: 'Yousef';
      font-size: 1rem;
      line-height: 1.7;
      text-align: center;
      position: relative;
      background: linear-gradient(
        270deg,
        rgba(203, 213, 225, 0.2) 0%,
        rgba(226, 232, 240, 0.6) 25%,
        #f1f5f990 50%,
        rgba(226, 232, 240, 0.6) 75%,
        rgba(203, 213, 225, 0.2) 100%
      );
      background-size: 300% 100%;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer-text 6s linear infinite;
      letter-spacing: 0px;
    }

    @keyframes shimmer-text {
      0% { background-position: -150% 0; }
      100% { background-position: 150% 0; }
    }
    
    .font-quran { 
      font-family: 'Kitab', 'Yousef', serif; 
      font-size: clamp(1.7rem, 4.5vw, 2.1rem); /* Responsive font size */
      line-height: 2.8; /* Adjusted for better readability */
      direction: rtl; 
      text-align: justify; 
      letter-spacing: normal !important;
      word-spacing: 0.1em; /* Slightly increased word spacing */
    }
    .font-quran-sm { 
        font-family: 'Kitab', 'Yousef', serif; 
        font-size: clamp(1.3rem, 4vw, 1.6rem); /* Responsive font size */
        line-height: 2.6; /* Adjusted */
        direction: rtl;
        text-align: right; 
        letter-spacing: normal !important;
        word-spacing: 0.05em;
    }
    
    .font-quran .text-amber-400,
    .font-quran-sm .text-amber-400 { 
        font-family: 'Kitab', 'Yousef', serif; 
        font-size: 0.8em; 
        font-weight: normal;
        color: #f59e0b; 
        display: inline-block;
        vertical-align: middle; 
        padding: 0 0.15em; 
        line-height: 1; 
        margin: 0 0.1em;
    }

    .overlay { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
    .overlay.active { opacity: 1; pointer-events: auto; }
    .expanded-card {
      background: rgba(23, 37, 58, 0.8); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
      border: 1px solid rgba(51, 65, 85, 0.6); color: #e2e8f0; border-radius: 1rem; 
      box-shadow: 0 20px 30px -10px rgba(0,0,0,0.4), 0 15px 25px -15px rgba(0,0,0,0.6);
      max-height: 90vh; overflow-y: auto;
    }
    .close-btn { color: #94a3b8; transition: color 0.2s ease, transform 0.2s ease; padding: 0.5rem; border-radius: 9999px; }
    .close-btn:hover { color: #fbbf24; background-color: rgba(251, 191, 36, 0.1); transform: scale(1.1); }
    .custom-scrollbar::-webkit-scrollbar { width: 12px; height: 12px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    mark { background-color: rgba(251, 191, 36, 0.25); color: #fef3c7; padding: 0.1em 0.3em; border-radius: 0.25rem; }
    .ayah-highlight-active { background-color: rgba(251, 191, 36, 0.15); transition: background-color 0.3s ease; border-radius: 0.5rem; margin: -0.25rem -0.5rem; padding: 0.25rem 0.5rem; }
    .btn-icon svg { width: 1.2em; height: 1.2em; }
    [dir="rtl"] .btn-icon svg:not(.pause-icon):not(.play-icon) { margin-left: 0; margin-right: 0.6em; }
    .loader { width: 56px; height: 56px; border: 6px solid #cbd5e1; border-bottom-color: #f59e0b; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 0.8s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message { color: #fca5a5; font-size: 0.875rem; margin-top: 0.5rem; }
    .focusable:focus-visible { outline: 2px solid #fbbf24; outline-offset: 2px; }
    .btn-base { @apply py-2.5 px-5 rounded-lg font-medium transition-all duration-200 ease-in-out focusable; }
    .btn-primary { @apply btn-base bg-amber-500 hover:bg-amber-400 text-slate-900 shadow-md hover:shadow-lg; }
    .btn-secondary { @apply btn-base bg-sky-600 hover:bg-sky-500 text-white shadow-md hover:shadow-lg; }
     .btn-emerald { @apply btn-base bg-emerald-600 hover:bg-emerald-500 text-white shadow-md hover:shadow-lg; }
    .btn-icon-only { @apply p-2.5 rounded-full transition-colors duration-200 focusable; }
    .basmalah { font-family: 'Kitab', 'Yousef', serif; font-size: clamp(1.5rem, 4vw, 1.8rem); text-align: center; color: #f59e0b; padding: 1rem 0 1.5rem 0; line-height: 1.5; }

    /* Microphone button specific styles */
#voiceSearchBtn {
      transition: color 0.3s ease, transform 0.2s ease;
    }
    #voiceSearchBtn.recording svg {
      color: #ef4444; /* Red-500 for recording */
      transform: scale(1.1);
    }
     #voiceSearchBtn:hover svg:not(.recording) {
      color: #f59e0b; /* Amber-500 for hover */
    }
/* ----- بداية كود حركة صورة القرآن ----- */
#animatedQuranImageContainer {
  position: absolute; /* لتتموضع خلف العناصر الأخرى */
  top: 70px; /* تعديل لرفع الصورة فوق العنوان الرئيسي. اضبط هذه القيمة حسب الحاجة */
  left: 50%;
  transform: translateX(-50%); /* لتوسيط الصورة أفقياً */
  z-index: 0; /* لجعلها خلف العناصر الأخرى ذات z-index أعلى */
  width: 200px; /* اضبط عرض الصورة حسب الحاجة */
  height: auto; /* للحفاظ على نسبة العرض إلى الارتفاع */
  animation: floatAnimation 6s ease-in-out infinite;
  opacity: 0.3; /* يمكنك تعديل درجة الشفافية هنا */
}

#animatedQuranImageContainer img {
  display: block;
  width: 100%;
  max-height: 300px;
}

@keyframes floatAnimation {
  0% {
    transform: translate(-50%, 0px);
  }
  50% {
    transform: translate(-50%, -10px); /* زيادة طفيفة في الحركة لتكون 10px إجمالاً (5px لأعلى و 5px لأسفل) */
  }
  100% {
    transform: translate(-50%, 0px);
  }
}
/* ----- نهاية كود حركة صورة القرآن ----- */

  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-950 text-slate-300 min-h-screen antialiased custom-scrollbar pt-28 sm:pt-32 pb-12 flex flex-col">
<!-- حاوية صورة القرآن المتحركة -->
<div id="animatedQuranImageContainer">
  <img src="quran.png" alt="صورة قرآن مزخرفة">
</div>
<!-- Hero/Search Section -->
<section class="flex flex-col items-center justify-start w-full pt-28 sm:pt-32 pb-12 relative z-10"> 
  <!--                                                       ^^^^^^^^^^^^^^ تم زيادة هذه القيم -->
  <div class="w-full max-w-3xl mx-auto text-center px-4">
    <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-amber-400 mb-5 tracking-tight">
      إِنْ هُوَ إِلَّا وَحْيٌ يُوحَى
    </h1>
    <p class="text-lg sm:text-xl text-slate-400 mb-10">
      ابحث في آيات القرآن الكريم واستمع إليها
    </p>
    <div class="relative">
  <input type="text" id="searchInput" placeholder="ابحث عن كلمة، رقم آية، أو اسم سورة..." autocomplete="off"
        class="w-full rounded-xl border-2 border-slate-700 bg-slate-800/70
               py-4 pl-16 pr-6 text-lg text-slate-100 placeholder-slate-500
               focus:bg-slate-800 focus:ring-2 focus:ring-amber-500 focus:border-amber-500
               outline-none backdrop-blur-sm shadow-xl transition-all duration-300 focusable" />
      <button id="voiceSearchBtn" title="البحث الصوتي" aria-label="البحث الصوتي"
              class="absolute left-3 top-1/2 transform -translate-y-1/2 p-2 text-slate-400 hover:text-amber-500 focusable rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
      </button>
    </div>
    <div class="relative z-10 mb-8 sm:mb-10 mt-8">
      <p id="animatedInstructionText" class="text-lg sm:text-xl md:text-2xl text-slate-200 max-w-xl md:max-w-2xl mx-auto leading-relaxed px-2">
    ابحث في القرآن الكريم عن آية او يمكنك النقر مباشرة زر الميكروفون لبدء التسجيل
      </p>
    </div>  
    <div id="resultsSummary" class="text-center mt-6 mb-3 text-slate-400 text-sm"></div>
    
    <div class="w-full mt-8">
      <div id="results" class="grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-6">
        <p id="initialMessage" class="col-span-full text-center text-slate-500 py-16 text-lg">
          ...جار تحميل بيانات القرآن الكريم، يرجى الانتظار قليلاً
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Quick Ayah View Modal -->
<div id="overlay" class="overlay fixed inset-0 z-50 flex items-center justify-center bg-slate-950/80 backdrop-blur-md p-4" aria-hidden="true" tabindex="-1">
  <div id="expandedCard" class="expanded-card relative w-full max-w-2xl custom-scrollbar" role="dialog" aria-modal="true" aria-labelledby="expandedSurahName" aria-describedby="expandedAyahText">
    <button id="closeBtn" class="close-btn absolute top-3 right-3 sm:top-4 sm:right-4 p-2 z-10" aria-label="إغلاق">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
    </button>
    <div class="p-6 pt-10 sm:p-8 sm:pt-12">
      <h2 id="expandedSurahName" class="text-2xl sm:text-3xl font-bold text-amber-400 mb-4 text-center"></h2>
      <p id="expandedAyahText" class="font-quran text-slate-100 leading-relaxed mb-6"></p>
      <div class="flex flex-col items-center space-y-3 mt-6">
          <button id="expandedPlayAyahBtn" class="btn-icon btn-emerald flex items-center justify-center w-full max-w-xs text-base sm:text-lg">
              <svg class="play-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
              <svg class="pause-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
              <span class="button-text ml-2 rtl:ml-0 rtl:mr-2">استمع لهذه الآية</span>
          </button>
          <p id="expandedAudioError" class="error-message text-center" style="display: none;"></p>
      </div>
    </div>
  </div>
</div>

<!-- Full Surah View Modal -->
<div id="surahViewModal" class="fixed inset-0 z-[60] bg-slate-900/85 backdrop-blur-lg flex items-center justify-center p-2 sm:p-4 opacity-0 pointer-events-none transition-opacity duration-300" aria-hidden="true">
  <div class="bg-slate-800/90 border border-slate-700/70 w-full max-w-5xl h-[95vh] sm:h-[92vh] rounded-xl shadow-2xl flex flex-col relative">
    <div class="p-4 sm:p-5 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
      <h2 id="surahViewTitle" class="text-2xl sm:text-3xl font-bold text-amber-400"></h2>
      <button id="closeSurahViewBtn" aria-label="إغلاق عرض السورة" class="text-slate-400 hover:text-amber-400 p-1 rounded-full transition-colors focusable">
        <svg class="w-8 h-8 sm:w-9 sm:h-9" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <div id="surahViewContentWrapper" class="flex-grow overflow-hidden relative">
      <div id="surahViewContent" class="p-4 sm:p-6 lg:p-8 space-y-3 overflow-y-auto h-full custom-scrollbar">
      </div>
    </div>
    <div id="surahAudioPlayerControls" class="p-3 sm:p-4 border-t border-slate-700 flex-shrink-0 bg-slate-800/50 rounded-b-xl">
      <div class="flex items-center space-x-3 rtl:space-x-reverse">
        <button id="playPauseSurahBtn" class="btn-icon-only text-amber-400 hover:text-amber-300 bg-slate-700 hover:bg-slate-600" aria-label="تشغيل/إيقاف السورة">
          <svg id="playIconSurah" class="w-6 h-6 sm:w-7 sm:h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
          <svg id="pauseIconSurah" class="w-6 h-6 sm:w-7 sm:h-7 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
        </button>
        <div class="flex-grow bg-slate-700 rounded-full h-3 sm:h-3.5 relative">
          <div id="surahProgressBar" class="bg-amber-500 h-full rounded-full transition-all duration-150" style="width: 0%"></div>
          <input type="range" id="surahSeekSlider" value="0" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer focusable" aria-label="شريط التقدم للسورة">
        </div>
      </div>
      <div id="currentPlayingAyahInfo" class="text-xs sm:text-sm text-slate-400 mt-2.5 text-center" aria-live="polite"></div>
    </div>
  </div>
</div>

<div id="loadingSpinner" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/70 backdrop-blur-sm" style="display: none;">
  <div class="loader"></div>
</div>

<audio id="globalAudioPlayer" preload="metadata"></audio>

<script>
  const searchInput = document.getElementById('searchInput');
  const resultsDiv = document.getElementById('results');
  const resultsSummaryDiv = document.getElementById('resultsSummary');
  const initialMessage = document.getElementById('initialMessage');
  const API_BASE_URL = 'https://api.alquran.cloud/v1';
  const QURAN_TEXT_EDITION = 'ar.quran-uthmani';
  const AUDIO_EDITION = 'ar.alafasy';
  const AUDIO_BITRATE = 128;

  let allAyahs = [];
  let currentPlayingAudioInfo = null; 

  const loadingSpinner = document.getElementById('loadingSpinner');
  const showLoading = () => loadingSpinner.style.display = 'flex';
  const hideLoading = () => loadingSpinner.style.display = 'none';

  const globalAudioPlayer = document.getElementById('globalAudioPlayer');
  let currentPlayingAyahElement = null; 
  
  const surahPlayIcon = document.getElementById('playIconSurah');
  const surahPauseIcon = document.getElementById('pauseIconSurah');
  const surahProgressBar = document.getElementById('surahProgressBar');
  const surahSeekSlider = document.getElementById('surahSeekSlider');
  const surahViewCurrentPlayingAyahInfo = document.getElementById('currentPlayingAyahInfo'); 
  let surahAyahsDataForView = [];
  let currentSurahAyahIdx = 0;
  let isSurahPlaying = false;

  const overlay = document.getElementById('overlay');
  const expandedCard = document.getElementById('expandedCard');
  const closeBtn = document.getElementById('closeBtn');
  const expandedSurahName = document.getElementById('expandedSurahName');
  const expandedAyahText = document.getElementById('expandedAyahText');
  const expandedPlayAyahBtn = document.getElementById('expandedPlayAyahBtn');
  const expandedAudioError = document.getElementById('expandedAudioError');
  let expandedAyahGlobalNum = null;

  const surahViewModal = document.getElementById('surahViewModal');
  const surahViewTitle = document.getElementById('surahViewTitle');
  const surahViewContent = document.getElementById('surahViewContent');
  const closeSurahViewBtn = document.getElementById('closeSurahViewBtn');

  const voiceSearchBtn = document.getElementById('voiceSearchBtn');
  let originalSearchPlaceholder = searchInput.placeholder;


  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function removeTashkeel(text) {
    if (typeof text !== 'string') return '';
    return text
      .replace(/[\u064B-\u0652]/g, '')
      .replace(/ٱ|[أإآ]/g, 'ا')
      .replace(/ى/g, 'ي')
      .replace(/ة/g, 'ه');
  }

  function highlight(text, query) {
    if (!query || typeof text !== 'string') return text;
    try {
        const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        return text.replace(regex, (match) => `<mark>${match}</mark>`);
    } catch (e) {
        console.warn("Highlighting regex error:", e);
        return text;
    }
  }

  async function loadQuran() {
    initialMessage.textContent = "...جار تحميل كامل القرآن، انتظر قليلاً";
    try {
      const response = await fetch(`${API_BASE_URL}/quran/${QURAN_TEXT_EDITION}`); 
      const data = await response.json();

      if (data.code !== 200 || !data.data || !data.data.surahs) {
        initialMessage.innerHTML = '<p class="text-red-400">حدث خطأ في تحميل القرآن.</p>';
        return;
      }

      allAyahs = [];
      data.data.surahs.forEach(surah => {
        surah.ayahs.forEach(ayah => {
          allAyahs.push({
            surahNumber: surah.number,
            surahName: surah.name,
            numberInSurah: ayah.numberInSurah,
            text: ayah.text,
            ayahGlobalNumber: ayah.number
          });
        });
      });
      
      initialMessage.innerHTML = '<p class="text-green-400">تم تحميل القرآن. ابدأ بالبحث!</p>';
      setTimeout(() => {
          if (initialMessage && initialMessage.parentNode === resultsDiv && searchInput.value.length === 0) {
              initialMessage.remove();
          }
      }, 3000);

    } catch (error) {
      initialMessage.innerHTML = `<p class="text-red-400">حدث خطأ أثناء تحميل القرآن: ${error.message}</p>`;
      console.error(error);
    }
  }

  function performLocalSearch(originalQuery) {
    if (initialMessage && initialMessage.parentNode === resultsDiv) {
      initialMessage.remove();
    }

    if (originalQuery.length === 0) {
      resultsDiv.innerHTML = '<p class="col-span-full text-center text-slate-500 py-10">الرجاء كتابة كلمة أو حرف للبحث.</p>';
      resultsSummaryDiv.textContent = '';
      return;
    }

    const normalizedQuery = removeTashkeel(originalQuery);
    const searchResults = allAyahs.filter(ayah => removeTashkeel(ayah.text).includes(normalizedQuery));

    if (searchResults.length === 0) {
      resultsDiv.innerHTML = `<p class="col-span-full text-center text-slate-400 py-10">لا توجد نتائج مطابقة لـ "${originalQuery}".</p>`;
      resultsSummaryDiv.textContent = '';
      return;
    }

    let html = '';
    searchResults.forEach(ayah => {
      html += `
        <div class="result-card bg-slate-800/70 backdrop-blur-md p-5 rounded-xl shadow-lg hover:shadow-amber-500/20 transition-all duration-300 flex flex-col space-y-3"
             data-surah-number="${ayah.surahNumber}"
             data-ayah-number-in-surah="${ayah.numberInSurah}"
             data-ayah-global-number="${ayah.ayahGlobalNumber}"
             data-surah-name="${ayah.surahName}"
             data-ayah-text-raw="${ayah.text.replace(/"/g, '"')}">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-semibold text-amber-400">${ayah.surahName} - آية ${ayah.numberInSurah}</h3>
            <span class="text-xs text-slate-500">الآية ${ayah.ayahGlobalNumber} في المصحف</span>
          </div>
          <p class="font-quran-sm text-slate-200 leading-relaxed ayah-text-container">${highlight(ayah.text, originalQuery)}</p>
          
          <div class="flex flex-col space-y-2 pt-3 border-t border-slate-700/50 mt-auto">
            <div class="flex space-x-3 rtl:space-x-reverse">
                <button class="btn-play-toggle-ayah btn-icon flex items-center justify-center flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm"
                        data-ayah-global-number="${ayah.ayahGlobalNumber}">
                    <svg class="play-icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                    <svg class="pause-icon w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    <span class="button-text ml-2 rtl:ml-0 rtl:mr-2">استماع</span>
                </button>
                <button class="btn-view-surah btn-icon flex items-center justify-center flex-1 bg-sky-600 hover:bg-sky-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C2.057 15.71 3.245 16 4.5 16h1.053c.256.162.527.296.806.399V4.804zM11 16.399c.279-.103.55-.237.806-.399H12.5c1.255 0 2.443-.29 3.5-.804V4.804C14.943 4.29 13.755 4 12.5 4S10.057 4.29 9 4.804v11.595zM10.5 18c-.256-.162-.527-.296-.806-.399V2.399c.279.103.55.237.806.399V18z"></path></svg>
                    عرض السورة
                </button>
                <button class="btn-quick-view btn-icon flex items-center justify-center flex-1 bg-violet-600 hover:bg-violet-500 text-white py-2 px-3 rounded-md transition-colors duration-200 text-sm">
                    <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path><path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.18l.879-.585A1.734 1.734 0 002.6 8.22c.312-.449.74-.832 1.208-1.142a11.247 11.247 0 0011.384 0c.468.31.896.693 1.208 1.142a1.734 1.734 0 001.057.585l.879.585a1.651 1.651 0 010 1.18l-.879.585a1.734 1.734 0 00-1.057.585c-.312.449-.74.832-1.208 1.142a11.247 11.247 0 00-11.384 0c-.468-.31-.896.693-1.208-1.142a1.734 1.734 0 00-1.057-.585l-.879-.585zM10 14a4 4 0 100-8 4 4 0 000 8z" clip-rule="evenodd"></path></svg>
                    نظرة سريعة
                </button>
            </div>
            <div class="ayah-progress-track bg-slate-600 rounded-full h-1.5 overflow-hidden mt-2" style="display: none;">
                <div class="ayah-progress-fill bg-emerald-400 h-full rounded-full" style="width: 0%;"></div>
            </div>
            <p class="audio-error-placeholder error-message text-center" style="display: none;"></p>
          </div>
        </div>
      `;
    });
    resultsDiv.innerHTML = html;
    resultsSummaryDiv.textContent = `تم العثور على ${searchResults.length} آية مطابقة.`;
    addResultCardListeners();
  }

  searchInput.addEventListener('input', debounce(() => {
    const query = searchInput.value.trim();
    performLocalSearch(query);
  }, 300));
  
  function openExpandedCard(surahName, ayahText, ayahGlobalNumber) {
    expandedSurahName.textContent = surahName;
    expandedAyahText.innerHTML = ayahText; 
    expandedAyahGlobalNum = ayahGlobalNumber;
    expandedAudioError.style.display = 'none';
    expandedPlayAyahBtn.querySelector('.play-icon').classList.remove('hidden');
    expandedPlayAyahBtn.querySelector('.pause-icon').classList.add('hidden');
    expandedPlayAyahBtn.querySelector('.button-text').textContent = 'استمع لهذه الآية';

    overlay.classList.add('active');
    overlay.setAttribute('aria-hidden', 'false');
    closeBtn.focus(); 
  }

  function closeExpandedCard() {
    stopCurrentAudioPlaybackAndResetUI();
    searchInput.focus();
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden', 'true');
  }
  closeBtn.addEventListener('click', closeExpandedCard);
  overlay.addEventListener('click', (e) => { if (e.target === overlay) closeExpandedCard(); });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && overlay.classList.contains('active')) closeExpandedCard(); });
  
  expandedPlayAyahBtn.addEventListener('click', () => {
    if (expandedAyahGlobalNum) {
        expandedAudioError.style.display = 'none';
        const playIcon = expandedPlayAyahBtn.querySelector('.play-icon');
        const pauseIcon = expandedPlayAyahBtn.querySelector('.pause-icon');
        const buttonText = expandedPlayAyahBtn.querySelector('.button-text');

        if (currentPlayingAudioInfo && currentPlayingAudioInfo.ayahGlobalNum === expandedAyahGlobalNum && currentPlayingAudioInfo.type === 'expanded') {
            if (globalAudioPlayer.paused) {
                globalAudioPlayer.play();
            } else {
                globalAudioPlayer.pause();
            }
        } else {
            stopCurrentAudioPlaybackAndResetUI();
            currentPlayingAudioInfo = {
                ayahGlobalNum: expandedAyahGlobalNum,
                type: 'expanded',
                element: expandedPlayAyahBtn,
                uiElements: { playIcon, pauseIcon, buttonText, errorPlaceholder: expandedAudioError },
                originalText: 'استمع لهذه الآية'
            };
            globalAudioPlayer.src = getAyahAudioUrl(expandedAyahGlobalNum);
            const playPromise = globalAudioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(err => {
                    if (currentPlayingAudioInfo && currentPlayingAudioInfo.element === expandedPlayAyahBtn) {
                        currentPlayingAudioInfo.uiElements.errorPlaceholder.textContent = "لا يمكن تشغيل الصوت.";
                        currentPlayingAudioInfo.uiElements.errorPlaceholder.style.display = 'block';
                        resetButtonUI(currentPlayingAudioInfo.uiElements, currentPlayingAudioInfo.originalText);
                        currentPlayingAudioInfo = null; 
                    }
                });
            }
        }
    }
  });
  
  async function displayFullSurah(surahNumber, surahName, ayahToHighlightGlobalNum) {
    showLoading();
    surahViewTitle.textContent = surahName;
    surahViewContent.innerHTML = '<div class="text-center p-10 text-slate-400">جاري تحميل السورة...</div>';
    surahViewModal.classList.remove('opacity-0', 'pointer-events-none');
    surahViewModal.classList.add('opacity-100', 'pointer-events-auto');
    surahViewModal.setAttribute('aria-hidden', 'false');
    closeSurahViewBtn.focus();

    try {
      const response = await fetch(`${API_BASE_URL}/surah/${surahNumber}/${QURAN_TEXT_EDITION}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();

      if (data.code !== 200 || !data.data || !data.data.ayahs) {
        surahViewContent.innerHTML = `<p class="text-center text-red-400 p-10">خطأ في تحميل بيانات السورة.</p>`;
        hideLoading();
        return;
      }
      
      const surahData = data.data;
      surahAyahsDataForView = surahData.ayahs.map((ayah, index) => ({
        ...ayah,
        localIndex: index,
        elementId: `surah-ayah-${surahData.number}-${ayah.numberInSurah}`
      }));

      let ayahsHtml = '';
      if (surahData.number !== 9 && surahData.number !== 1) { 
          ayahsHtml += `<div class="basmalah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>`;
      }

      surahAyahsDataForView.forEach(ayah => {
        let ayahTextToDisplay = ayah.text;
        if (surahData.number !== 1 && surahData.number !== 9 && ayah.numberInSurah === 1 && ayahTextToDisplay.startsWith("بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ")) {
            ayahTextToDisplay = ayahTextToDisplay.replace(/^بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ\s*/, '');
        }
        if (surahData.number === 1 && ayah.numberInSurah === 1 && !ayahTextToDisplay.startsWith("بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ") && ayahTextToDisplay !== "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ") {
             // This is to ensure Basmalah is shown for Al-Fatiha if not part of the first ayah's text from API
             // but only if it's not already "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ" which implies Basmalah might be separate.
             // The API `ar.quran-uthmani` usually includes it in the first ayah of Al-Fatiha.
             // This logic path might be redundant with that specific API.
        }


        ayahsHtml += `
          <div id="${ayah.elementId}" class="surah-ayah-item p-3 rounded-md hover:bg-slate-700/50 transition-colors duration-150" data-ayah-local-idx="${ayah.localIndex}">
            <p class="font-quran text-slate-100 mb-1">${ayahTextToDisplay}
              <span class="text-amber-400 text-lg select-none">﴿${ayah.numberInSurah}﴾</span>
            </p>
          </div>
        `;
      });
      surahViewContent.innerHTML = ayahsHtml;
      
      currentSurahAyahIdx = 0;
      isSurahPlaying = false;
      updateSurahPlayPauseIcons();
      surahProgressBar.style.width = '0%';
      surahSeekSlider.value = 0;
      surahViewCurrentPlayingAyahInfo.textContent = '';

      if (ayahToHighlightGlobalNum) {
        const targetAyahData = surahAyahsDataForView.find(a => a.number === ayahToHighlightGlobalNum);
        if (targetAyahData) {
            const targetElement = document.getElementById(targetAyahData.elementId);
            if (targetElement) {
                targetElement.classList.add('bg-amber-500/10', 'ring-1', 'ring-amber-500/30');
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentSurahAyahIdx = targetAyahData.localIndex;
            }
        }
      } else {
         surahViewContent.scrollTop = 0;
      }

    } catch (error) {
      surahViewContent.innerHTML = `<p class="text-center text-red-400 p-10">حدث خطأ أثناء تحميل السورة: ${error.message}</p>`;
      console.error("Error in displayFullSurah:", error);
    } finally {
      hideLoading();
    }
  }

  function closeSurahView() {
    stopCurrentAudioPlaybackAndResetUI();
    searchInput.focus();
    surahViewModal.classList.add('opacity-0', 'pointer-events-none');
    surahViewModal.classList.remove('opacity-100', 'pointer-events-auto');
    surahViewModal.setAttribute('aria-hidden', 'true');
  }
  closeSurahViewBtn.addEventListener('click', closeSurahView);
  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape' && surahViewModal.classList.contains('opacity-100')) {
        closeSurahView(); 
    }
  });

  function addResultCardListeners() {
    document.querySelectorAll('.result-card').forEach(card => {
      const surahNum = card.dataset.surahNumber;
      const surahName = card.dataset.surahName;
      const ayahGlobalNum = parseInt(card.dataset.ayahGlobalNumber);
      const rawAyahText = card.dataset.ayahTextRaw; 
      const highlightedAyahHTML = card.querySelector('.ayah-text-container').innerHTML;

      const playButton = card.querySelector('.btn-play-toggle-ayah');
      if (playButton) {
          playButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const clickedAyahGlobalNum = parseInt(playButton.dataset.ayahGlobalNumber);
            const currentCard = playButton.closest('.result-card');
            const playIcon = playButton.querySelector('.play-icon');
            const pauseIcon = playButton.querySelector('.pause-icon');
            const buttonText = playButton.querySelector('.button-text');
            const progressTrack = currentCard.querySelector('.ayah-progress-track');
            const progressFill = currentCard.querySelector('.ayah-progress-fill');
            const errorPlaceholder = currentCard.querySelector('.audio-error-placeholder');

            if (errorPlaceholder) errorPlaceholder.style.display = 'none';

            if (currentPlayingAudioInfo && currentPlayingAudioInfo.ayahGlobalNum === clickedAyahGlobalNum && currentPlayingAudioInfo.element === playButton) {
                if (globalAudioPlayer.paused) {
                    globalAudioPlayer.play();
                } else {
                    globalAudioPlayer.pause();
                }
            } else {
                stopCurrentAudioPlaybackAndResetUI(); 
                currentPlayingAudioInfo = {
                    ayahGlobalNum: clickedAyahGlobalNum,
                    type: 'card',
                    element: playButton,
                    uiElements: { playIcon, pauseIcon, buttonText, progressTrack, progressFill, errorPlaceholder },
                    originalText: 'استماع'
                };
                globalAudioPlayer.src = getAyahAudioUrl(clickedAyahGlobalNum);
                const playPromise = globalAudioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(err => {
                        if (currentPlayingAudioInfo && currentPlayingAudioInfo.element === playButton) {
                            currentPlayingAudioInfo.uiElements.errorPlaceholder.textContent = "لا يمكن تشغيل الصوت.";
                            currentPlayingAudioInfo.uiElements.errorPlaceholder.style.display = 'block';
                            resetButtonUI(currentPlayingAudioInfo.uiElements, currentPlayingAudioInfo.originalText); 
                            currentPlayingAudioInfo = null;
                        }
                    });
                }
            }
        });
      }
      
      card.querySelector('.btn-view-surah').addEventListener('click', (e) => {
        e.stopPropagation();
        displayFullSurah(surahNum, surahName, ayahGlobalNum);
      });
      card.querySelector('.btn-quick-view').addEventListener('click', (e) => {
        e.stopPropagation();
        const query = searchInput.value.trim();
        openExpandedCard(`${surahName} - آية ${card.dataset.ayahNumberInSurah}`, query ? highlightedAyahHTML : rawAyahText, ayahGlobalNum);
      });
    });
  }

  function getAyahAudioUrl(ayahGlobalNum) {
    return `https://cdn.islamic.network/quran/audio/${AUDIO_BITRATE}/${AUDIO_EDITION}/${ayahGlobalNum}.mp3`;
  }
  
  function stopCurrentAudioPlaybackAndResetUI(isError = false, errorMessage = "") {
    const wasSurahPlaying = isSurahPlaying;
    globalAudioPlayer.pause();
    if (!isError || (currentPlayingAudioInfo && currentPlayingAudioInfo.type !== 'surah')) {
        globalAudioPlayer.removeAttribute('src');
        try { globalAudioPlayer.load(); } catch (e) { /* ignore */ }
    }

    if (currentPlayingAudioInfo) {
        const { type, uiElements, originalText } = currentPlayingAudioInfo;
        
        if (type === 'card' && uiElements) {
            resetButtonUI(uiElements, originalText);
            if (uiElements.progressTrack) uiElements.progressTrack.style.display = 'none';
            if (uiElements.progressFill) uiElements.progressFill.style.width = '0%';
            if (isError && uiElements.errorPlaceholder) {
                uiElements.errorPlaceholder.textContent = errorMessage || "حدث خطأ في تشغيل الصوت.";
                uiElements.errorPlaceholder.style.display = 'block';
            } else if (uiElements.errorPlaceholder) {
                 uiElements.errorPlaceholder.style.display = 'none';
            }
        } else if (type === 'expanded' && uiElements) {
            resetButtonUI(uiElements, originalText);
            if (isError && uiElements.errorPlaceholder) {
                uiElements.errorPlaceholder.textContent = errorMessage || "حدث خطأ في تشغيل الصوت.";
                uiElements.errorPlaceholder.style.display = 'block';
            } else if (uiElements.errorPlaceholder) {
                uiElements.errorPlaceholder.style.display = 'none';
            }
        } else if (type === 'surah') {
            isSurahPlaying = false; 
            updateSurahPlayPauseIcons();
            if (currentPlayingAyahElement) {
                currentPlayingAyahElement.classList.remove('ayah-highlight-active');
                currentPlayingAyahElement = null; 
            }
            if (!wasSurahPlaying && isError) { 
                 surahViewCurrentPlayingAyahInfo.textContent = errorMessage;
            } else if (!isError && !globalAudioPlayer.ended) { 
                 surahViewCurrentPlayingAyahInfo.textContent = "التلاوة متوقفة";
            }
        }
    }
    currentPlayingAudioInfo = null;
  }

  function resetButtonUI(uiElements, originalText) {
    if (!uiElements) return;
    uiElements.playIcon?.classList.remove('hidden');
    uiElements.pauseIcon?.classList.add('hidden');
    if (uiElements.buttonText) uiElements.buttonText.textContent = originalText;
  }

  globalAudioPlayer.addEventListener('play', () => {
    if (currentPlayingAudioInfo) {
        const { type, uiElements } = currentPlayingAudioInfo;
        if (type === 'card' && uiElements) {
            uiElements.playIcon?.classList.add('hidden');
            uiElements.pauseIcon?.classList.remove('hidden');
            uiElements.buttonText.textContent = 'إيقاف مؤقت';
            if (uiElements.progressTrack) uiElements.progressTrack.style.display = 'block';
            if (uiElements.errorPlaceholder) uiElements.errorPlaceholder.style.display = 'none';
        } else if (type === 'expanded' && uiElements) {
            uiElements.playIcon.classList.add('hidden');
            uiElements.pauseIcon.classList.remove('hidden');
            uiElements.buttonText.textContent = 'إيقاف مؤقت';
            if (uiElements.errorPlaceholder) uiElements.errorPlaceholder.style.display = 'none';
        } else if (type === 'surah') {
            isSurahPlaying = true;
            updateSurahPlayPauseIcons();
        }
    }
  });

  globalAudioPlayer.addEventListener('pause', () => {
    if (currentPlayingAudioInfo && !globalAudioPlayer.ended && globalAudioPlayer.src) { 
        const { type, uiElements, originalText } = currentPlayingAudioInfo;
            if (type === 'card' && uiElements) {
            resetButtonUI(uiElements, 'استئناف');
        } else if (type === 'expanded' && uiElements) {
            resetButtonUI(uiElements, 'استئناف');
        } else if (type === 'surah') {
            isSurahPlaying = false; 
            updateSurahPlayPauseIcons();
            if (!globalAudioPlayer.ended) { 
                 surahViewCurrentPlayingAyahInfo.textContent = "التلاوة متوقفة مؤقتاً";
            }
        }
    } else if (currentPlayingAudioInfo) { 
        const { type, uiElements, originalText } = currentPlayingAudioInfo;
        if (type === 'card' && uiElements) resetButtonUI(uiElements, originalText);
        if (type === 'expanded' && uiElements) resetButtonUI(uiElements, originalText);
        if (type === 'surah') {
            if(!globalAudioPlayer.ended && !globalAudioPlayer.error){
                 isSurahPlaying = false;
                 updateSurahPlayPauseIcons();
            }
        }
    }
  });

  globalAudioPlayer.addEventListener('ended', () => {
    if (currentPlayingAudioInfo && currentPlayingAudioInfo.type === 'surah' && isSurahPlaying) {
        currentSurahAyahIdx++;
        playNextAyahInSurah();
    } else {
        stopCurrentAudioPlaybackAndResetUI();
    }
  });

  globalAudioPlayer.addEventListener('error', (e) => {
    console.error('Global Audio Player Error:', e, globalAudioPlayer.error);
    const errorMessage = "عفواً، الملف الصوتي غير متاح حالياً.";
    
    if (currentPlayingAudioInfo && currentPlayingAudioInfo.type === 'surah' && isSurahPlaying) {
        const ayahData = surahAyahsDataForView[currentSurahAyahIdx];
        surahViewCurrentPlayingAyahInfo.textContent = `خطأ في الآية ${ayahData ? ayahData.numberInSurah : ' الحالية'}. محاولة الانتقال للتالية...`;
        
        globalAudioPlayer.removeAttribute('src');
        try { globalAudioPlayer.load(); } catch (ex) { /* ignore */ }

        currentSurahAyahIdx++; 
        setTimeout(playNextAyahInSurah, 1000); 
    } else {
        stopCurrentAudioPlaybackAndResetUI(true, errorMessage);
    }
  });

  globalAudioPlayer.addEventListener('timeupdate', () => {
    if (currentPlayingAudioInfo && globalAudioPlayer.duration > 0 && !globalAudioPlayer.paused) {
        const percentage = (globalAudioPlayer.currentTime / globalAudioPlayer.duration) * 100;
        if (currentPlayingAudioInfo.type === 'card' && currentPlayingAudioInfo.uiElements.progressFill) {
            currentPlayingAudioInfo.uiElements.progressFill.style.width = percentage + '%';
        } else if (currentPlayingAudioInfo.type === 'surah' && isSurahPlaying) {
            if (surahAyahsDataForView.length > 0) {
                const currentAyahProgress = globalAudioPlayer.currentTime / globalAudioPlayer.duration;
                const validCurrentSurahAyahIdx = Math.max(0, Math.min(currentSurahAyahIdx, surahAyahsDataForView.length - 1));
                if (surahAyahsDataForView[validCurrentSurahAyahIdx]) { 
                    const overallProgress = ((validCurrentSurahAyahIdx + currentAyahProgress) / surahAyahsDataForView.length) * 100;
                    surahProgressBar.style.width = `${Math.min(100, Math.max(0, overallProgress))}%`;
                    surahSeekSlider.value = Math.min(100, Math.max(0, overallProgress));
                }
            }
        }
    }
  });

  function updateSurahPlayPauseIcons() {
    if (isSurahPlaying) {
      surahPlayIcon.classList.add('hidden');
      surahPauseIcon.classList.remove('hidden');
    } else {
      surahPlayIcon.classList.remove('hidden');
      surahPauseIcon.classList.add('hidden');
    }
  }

  async function playNextAyahInSurah() {
    if (!isSurahPlaying || currentSurahAyahIdx >= surahAyahsDataForView.length) {
      isSurahPlaying = false;
      updateSurahPlayPauseIcons();
      if (currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
      surahViewCurrentPlayingAyahInfo.textContent = surahAyahsDataForView.length > 0 ? "انتهت تلاوة السورة" : "لا توجد آيات لتلاوتها";
      surahProgressBar.style.width = surahAyahsDataForView.length > 0 ? '100%' : '0%';
      surahSeekSlider.value = surahAyahsDataForView.length > 0 ? 100 : 0;
      return;
    }

    const ayahData = surahAyahsDataForView[currentSurahAyahIdx];
    const ayahElement = document.getElementById(ayahData.elementId);

    if (currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
    if (ayahElement) {
        ayahElement.classList.add('ayah-highlight-active');
        ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        currentPlayingAyahElement = ayahElement;
    }
    
    surahViewCurrentPlayingAyahInfo.textContent = `جاري تلاوة: ${surahViewTitle.textContent} - الآية ${ayahData.numberInSurah}`;
    
    if (!currentPlayingAudioInfo || currentPlayingAudioInfo.type !== 'surah' || currentPlayingAudioInfo.ayahGlobalNum !== ayahData.number) {
        stopCurrentAudioPlaybackAndResetUI(); 
        currentPlayingAudioInfo = {
            ayahGlobalNum: ayahData.number,
            type: 'surah',
            element: document.getElementById('playPauseSurahBtn'),
            uiElements: { }, 
            originalText: '' 
        };
    }
    
    globalAudioPlayer.src = getAyahAudioUrl(ayahData.number);
    try {
        await globalAudioPlayer.play(); 
    } catch (error) {
        console.error(`Error initiating play for surah ayah ${ayahData.number}:`, error);
    }
  }

  document.getElementById('playPauseSurahBtn').addEventListener('click', () => {
    if (surahAyahsDataForView.length === 0) return;
    
    if (isSurahPlaying) { 
        globalAudioPlayer.pause(); 
    } else { 
        const currentAyahData = surahAyahsDataForView[currentSurahAyahIdx];
        if (currentAyahData && globalAudioPlayer.src && currentPlayingAudioInfo && currentPlayingAudioInfo.type === 'surah' && currentPlayingAudioInfo.ayahGlobalNum === currentAyahData.number && globalAudioPlayer.paused) {
            const resumePromise = globalAudioPlayer.play(); 
            if (resumePromise !== undefined) {
                resumePromise.catch(err => {
                    console.error("Resume error (Surah):", err);
                    isSurahPlaying = false; 
                    updateSurahPlayPauseIcons();
                    surahViewCurrentPlayingAyahInfo.textContent = "خطأ عند استئناف التلاوة.";
                    currentPlayingAudioInfo = null;
                });
            }
        } else {
            isSurahPlaying = true; 
            playNextAyahInSurah(); 
        }
    }
  });

  document.getElementById('surahSeekSlider').addEventListener('input', (e) => {
    if (surahAyahsDataForView.length === 0) return;
    
    const wasPlaying = isSurahPlaying; 
    globalAudioPlayer.pause(); 

    const seekPercentage = parseFloat(e.target.value);
    const targetAyahAbsoluteIdx = (seekPercentage / 100) * surahAyahsDataForView.length;
    let newAyahIdx = Math.floor(targetAyahAbsoluteIdx);
    
    if (newAyahIdx >= surahAyahsDataForView.length) newAyahIdx = surahAyahsDataForView.length - 1;
    if (newAyahIdx < 0) newAyahIdx = 0;

    currentSurahAyahIdx = newAyahIdx;
    
    if(currentPlayingAyahElement) currentPlayingAyahElement.classList.remove('ayah-highlight-active');
    const ayahDataSeeked = surahAyahsDataForView[currentSurahAyahIdx];
    if (ayahDataSeeked) {
        const ayahElement = document.getElementById(ayahDataSeeked.elementId);
        if (ayahElement) {
            ayahElement.classList.add('ayah-highlight-active');
            currentPlayingAyahElement = ayahElement; 
            ayahElement.scrollIntoView({ behavior: 'auto', block: 'center', inline: 'nearest' });
        }
        surahViewCurrentPlayingAyahInfo.textContent = `متوقف عند: ${surahViewTitle.textContent} - الآية ${ayahDataSeeked.numberInSurah}`;
    }
    surahProgressBar.style.width = `${seekPercentage}%`;

    if (wasPlaying) { 
        isSurahPlaying = true; 
        playNextAyahInSurah(); 
    } else {
        if (ayahDataSeeked) {
             currentPlayingAudioInfo = {
                ayahGlobalNum: ayahDataSeeked.number,
                type: 'surah',
                element: document.getElementById('playPauseSurahBtn'),
                uiElements: { }, 
                originalText: '' 
            };
            globalAudioPlayer.src = getAyahAudioUrl(ayahDataSeeked.number); 
            try { globalAudioPlayer.load(); } catch(er) {} 
        }
        updateSurahPlayPauseIcons(); 
    }
});

  // Voice Search Functionality
  if (voiceSearchBtn) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'ar-SA'; // Arabic - Saudi Arabia. Change if needed.
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      voiceSearchBtn.addEventListener('click', () => {
        if (voiceSearchBtn.classList.contains('recording')) {
          recognition.stop();
          // UI reset will be handled in onend
        } else {
          try {
            recognition.start();
            voiceSearchBtn.classList.add('recording');
            searchInput.placeholder = '... جاري الاستماع';
          } catch (e) {
            console.error("Speech recognition start error:", e);
            alert("لا يمكن بدء البحث الصوتي. قد يكون الميكروفون غير متاح أو غير مدعوم.");
            voiceSearchBtn.classList.remove('recording');
            searchInput.placeholder = originalSearchPlaceholder;
          }
        }
      });

      recognition.onresult = (event) => {
        const speechResult = event.results[0][0].transcript;
        searchInput.value = speechResult;
        // Trigger search
        performLocalSearch(speechResult);
      };

      recognition.onspeechend = () => {
        recognition.stop();
        // UI reset handled in onend
      };
      
      recognition.onend = () => {
        voiceSearchBtn.classList.remove('recording');
        searchInput.placeholder = originalSearchPlaceholder;
      };

      recognition.onerror = (event) => {
        voiceSearchBtn.classList.remove('recording');
        searchInput.placeholder = originalSearchPlaceholder;
        if (event.error === 'no-speech') {
      alert('لم يتم اكتشاف أي كلام. الرجاء المحاولة مرة أخرى.');
        } else if (event.error === 'audio-capture') {
          alert('مشكلة في التقاط الصوت. تأكد من أن الميكروفون يعمل ومسموح به.');
        } else if (event.error === 'not-allowed') {
          alert('تم رفض الإذن باستخدام الميكروفون. يرجى السماح بالوصول للمتابعة.');
        } else {
          alert(`حدث خطأ في التعرف على الكلام: ${event.error}`);
        }
        console.error(`Speech recognition error: ${event.error}`, event);
      };

    } else {
      voiceSearchBtn.style.display = 'none'; // Hide button if API not supported
      console.warn('Speech Recognition API not supported in this browser.');
    }
  }


  loadQuran();
  hideLoading();
</script>
</body>
</html>
