<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>القرآن الكريم - التطبيق الشامل</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📖</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- إضافة manifest.json للدعم PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#f59e0b">
  <meta name="description" content="تطبيق متكامل للقرآن الكريم مع البحث الذكي والتلاوة والأذكار">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="القرآن الكريم">
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.png">
  
  <!-- محرك البحث المتقدم للقرآن الكريم -->
  <script src="./assets/js/quran-search.js" defer></script>
  
  <!-- نظام الأذكار الجديد -->
  <script src="./assets/js/athkar-main.js" defer></script>
  <style>
    @font-face {
      font-family: 'Kitab'; 
      src: url('./assets/fonts/kitab-base.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap; 
    }
    @font-face {
      font-family: 'Yousef'; 
      src: url('./assets/fonts/yousef-regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    body {
      font-family: 'Inter', 'Kitab', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .font-quran { 
      font-family: 'Kitab', 'Yousef', serif; 
      font-size: clamp(1.7rem, 4.5vw, 2.1rem);
      line-height: 2.8;
      direction: rtl; 
      text-align: justify; 
    }
    .font-quran-sm { 
      font-family: 'Kitab', 'Yousef', serif; 
      font-size: clamp(1.3rem, 4vw, 1.6rem);
      line-height: 2.6;
      direction: rtl;
      text-align: right; 
    }
    
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    
    /* تعديل أنماط القائمة المنسدلة للبحث لتصبح بطاقات */
    .search-dropdown {
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid #374151;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 0.75rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 800px;
      z-index: 1000;
      padding: 1rem;
      transition: opacity 0.2s ease, transform 0.2s ease;
      will-change: transform, opacity;
    }
    
    /* أنماط بطاقات نتائج البحث في القائمة المنسدلة */
    .search-result-card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
      animation: fadeIn 0.2s ease-out forwards;
      animation-delay: calc(var(--animation-order, 0) * 0.05s);
      opacity: 0;
      transform: translateY(10px);
    }
    
    .search-result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border-color: rgba(245, 158, 11, 0.4);
    }
    
    /* أنماط لزر إغلاق القائمة المنسدلة */
    .search-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(100, 116, 139, 0.2);
    }
    
    .search-dropdown-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: all 0.2s ease;
    }
    
    .search-dropdown-close:hover {
      color: #f59e0b;
      background: rgba(100, 116, 139, 0.1);
    }
    
    /* تعديل الشبكة لعرض البطاقات */
    .search-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 0.75rem;
    }
    
    @media (max-width: 640px) {
      .search-results-grid {
        grid-template-columns: 1fr;
      }
      
      .search-dropdown {
        width: 95%;
        max-height: 70vh;
      }
    }
    
    .floating-nav {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 50px;
      padding: 0.5rem;
      display: flex;
      gap: 0.5rem;
      z-index: 1000;
    }
    
    .nav-item {
      padding: 0.75rem 1rem;
      border-radius: 25px;
      transition: all 0.3s ease;
      cursor: pointer;
      color: #94a3b8;
    }
    .nav-item:hover, .nav-item.active {
      background-color: #f59e0b;
      color: #1e293b;
    }
    
    .loader { 
      width: 40px; 
      height: 40px; 
      border: 4px solid #cbd5e1; 
      border-bottom-color: #f59e0b; 
      border-radius: 50%; 
      animation: rotation 1s linear infinite; 
    }
    @keyframes rotation { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .surah-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .surah-card {
      background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(71, 85, 105, 0.6) 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .surah-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(245, 158, 11, 0.5);
    }
    
    .modal {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(15, 23, 42, 0.8);
    }
    
    .voice-recording {
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    #reciter-selector {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(71, 85, 105, 0.5);
    }
    
    /* أنماط المحتوى القابل للتوسيع والطي */
    .collapse-content {
      max-height: 100px;
      overflow: hidden;
      position: relative;
      transition: max-height 0.3s ease;
      cursor: pointer;
    }
    
    .collapse-content::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(to bottom, rgba(30, 41, 59, 0) 0%, rgba(30, 41, 59, 0.8) 100%);
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .collapse-content.expanded {
      max-height: 1000px;
    }
    
    .collapse-content.expanded::after {
      opacity: 0;
    }
    
    /* أنماط بطاقات الأذكار */
    .zikr-card {
      background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(71, 85, 105, 0.6) 100%);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    
    .zikr-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(245, 158, 11, 0.5);
    }
    
    /* أنماط لبطاقات نتائج البحث */
    .result-card {
      border: 1px solid rgba(148, 163, 184, 0.1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    
    .result-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* تحديد ارتفاع للنص لعرض 3 أسطر فقط */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* تأثيرات الحركة */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    
    /* تحسينات للأجهزة المحمولة */
    @media (max-width: 640px) {
      #searchResultsContainer {
        grid-template-columns: 1fr;
      }
      
      .result-card {
        padding: 1rem;
      }
    }
    
    /* تنسيق عنصر التحميل الكسول */
    .load-more-trigger {
      width: 100%;
      height: 20px;
      margin: 10px 0;
      opacity: 0;
    }

    #animatedQuranImageContainer {
  position: absolute; /* لتتموضع خلف العناصر الأخرى */
  top: 70px; /* تعديل لرفع الصورة فوق العنوان الرئيسي. اضبط هذه القيمة حسب الحاجة */
  left: 50%;
  transform: translateX(-50%); /* لتوسيط الصورة أفقياً */
  z-index: 0; /* لجعلها خلف العناصر الأخرى ذات z-index أعلى */
  width: 200px; /* اضبط عرض الصورة حسب الحاجة */
  height: auto; /* للحفاظ على نسبة العرض إلى الارتفاع */
  animation: floatAnimation 6s ease-in-out infinite;
  opacity: 0.3; /* يمكنك تعديل درجة الشفافية هنا */
}

#animatedQuranImageContainer img {
  display: block;
  width: 100%;
  max-height: 300px;
}

@keyframes floatAnimation {
  0% {
    transform: translate(-50%, 0px);
  }
  50% {
    transform: translate(-50%, -10px); /* زيادة طفيفة في الحركة لتكون 10px إجمالاً (5px لأعلى و 5px لأسفل) */
  }
  100% {
    transform: translate(-50%, 0px);
  }
}
/* ----- نهاية كود حركة صورة القرآن ----- */

    /* تأثيرات الظهور والاختفاء */
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .fade-out {
      animation: fadeOut 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
    
    /* أنماط بطاقات القراء */
    #reciter-selector .grid {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) rgba(30, 41, 59, 0.7);
    }
    
    #reciter-selector .grid::-webkit-scrollbar {
      width: 6px;
    }
    
    #reciter-selector .grid::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 10px;
    }
    
    #reciter-selector .grid::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
    
    /* أنماط بطاقة القارئ المحددة */
    #reciter-selector [data-code].selected {
      box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
      transform: translateY(-2px);
    }
    
    /* أنماط بطاقات نتائج البحث */
    .search-result-card {
      animation: fadeInUp 0.5s ease forwards;
      opacity: 0;
      transform: translateY(20px);
      animation-delay: calc(var(--animation-order) * 0.1s);
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* تأثير تمييز نص البحث */
    mark {
      background-color: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      border-radius: 2px;
      padding: 0 2px;
    }
    
    /* تقليص النص الطويل */
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-950 text-slate-300 min-h-screen antialiased custom-scrollbar pt-28 sm:pt-32 pb-12 flex flex-col">
<!-- حاوية صورة القرآن المتحركة -->
<div id="animatedQuranImageContainer">
  <img src="./assets/images/quran.png" alt="صورة قرآن مزخرفة">
</div>
    <!-- Navigation -->
    <div class="floating-nav">
    <div class="nav-item" data-section="search">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="nav-item active" data-section="browse">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C2.057 15.71 3.245 16 4.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM6.5 15.5c.2 0 .398-.011.593-.032L7 15.5h-.5zM13.5 4c-1.255 0-2.443.29-3.5.804v10.392c1.057.514 2.245.804 3.5.804 1.255 0 2.443-.29 3.5-.804V4.804C15.943 4.29 14.755 4 13.5 4z"></path>
      </svg>
    </div>
    <div class="nav-item" data-section="athkar">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="nav-item" data-section="prayer">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
      </svg>
    </div>
    <div class="nav-item" data-section="settings">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
      </svg>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 pb-32">
    
    <!-- Search Section -->
    <section id="search-section" class="section hidden">
      <div class="text-center mb-12">
        <h1 class="text-5xl font-bold text-amber-400 mb-4">القرآن الكريم</h1>
        <p class="text-xl text-slate-400 mb-8">ابحث في آيات القرآن الكريم</p>
        
        <!-- Search Input -->
        <div class="relative max-w-2xl mx-auto mb-4">
          <input type="text" id="searchInput" 
             placeholder="ابحث عن آية، كلمة، أو معنى..." 
                 class="w-full rounded-xl border-2 border-slate-700 bg-slate-800/70 py-4 pl-16 pr-6 text-lg text-slate-100 placeholder-slate-500 focus:bg-slate-800 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none backdrop-blur-sm shadow-xl transition-all duration-300" />
          
          <!-- Voice Search -->
          <button id="voiceSearchBtn" class="absolute left-3 top-1/2 transform -translate-y-1/2 p-2 text-slate-400 hover:text-amber-500 rounded-full transition-colors" title="بحث صوتي">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          </button>
          
          <!-- Search Button -->
          <button id="searchBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 bg-amber-500 hover:bg-amber-600 text-slate-900 px-4 py-2 rounded-lg font-bold transition-colors" title="بحث">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </button>
          
          
          <!-- Search Dropdown - تم تعديله ليعرض البطاقات -->
          <div id="searchDropdown" class="search-results-container fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-800/95 p-6 rounded-xl border border-amber-500/30 z-50 backdrop-blur-md shadow-2xl hidden w-11/12 max-w-4xl max-h-[80vh] overflow-y-auto custom-scrollbar">
            <div class="search-dropdown-header flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-amber-400">نتائج البحث</h3>
              <button class="search-dropdown-close text-slate-400 hover:text-amber-400" title="إغلاق" aria-label="إغلاق نتائج البحث">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="loadMoreContainer" class="text-center mt-4 hidden">
              <button id="loadMoreButton" class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                عرض المزيد من النتائج
              </button>
            </div>
          </div>
        </div>
        
        <!-- Search Options -->
        <div class="flex justify-center space-x-4 rtl:space-x-reverse mb-8">
          <label class="flex items-center space-x-2 rtl:space-x-reverse">
            <input type="checkbox" id="exactMatchToggle" class="rounded border-slate-600 bg-slate-700 text-amber-500 focus:ring-amber-500">
            <span class="text-sm text-slate-400">مطابقة تامة</span>
          </label>
        </div>
        
        <!-- Results Summary -->
        <div id="resultsSummary" class="text-center text-slate-400 text-sm mb-4"></div>
        
              </button>
            </div>
          </div>
        </div>
        
        <!-- Search Results -->
        <div id="searchResultsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div id="initialMessage" class="col-span-full text-center text-slate-500 py-16">
            جار تحميل بيانات القرآن الكريم...
          </div>
        </div>
      </div>
    </section>

    <!-- Browse Section -->
    <section id="browse-section" class="section active">
      <div class="text-center mb-8">
        <h2 class="text-4xl font-bold text-amber-400 mb-4">تصفح السور</h2>
        <p class="text-lg text-slate-400">اختر سورة للقراءة والاستماع</p>
      </div>
      
      <!-- Surah Filter -->
      <div class="flex justify-center mb-8">
        <div class="flex space-x-4 rtl:space-x-reverse">
          <button class="surah-filter-btn active" data-filter="all">الكل</button>
          <button class="surah-filter-btn" data-filter="makkah">مكية</button>
          <button class="surah-filter-btn" data-filter="madinah">مدنية</button>
        </div>
      </div>
      
      <!-- Surahs Grid -->
      <div id="surahsGrid" class="surah-grid">
        <div class="text-center col-span-full">
          <div class="loader mx-auto"></div>
          <p class="mt-4 text-slate-400">جار تحميل السور...</p>
        </div>
      </div>
    </section>

    <!-- athkar Section -->
    <section id="athkar-section" class="section hidden">
      <!-- محتوى الأذكار سيتم حقنه هنا بواسطة JavaScript -->
  </section>
    <!-- Prayer Times Section -->
    <section id="prayer-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-4xl font-bold text-amber-400 mb-4">مواقيت الصلاة</h2>
        <p class="text-lg text-slate-400">أوقات الصلاة حسب موقعك</p>
      </div>
      
      <div class="max-w-md mx-auto">
        <div class="section-card rounded-xl p-6">
          <div id="prayerTimesContent">
            <div class="text-center">
              <div class="loader mx-auto mb-4"></div>
              <p class="text-slate-400">جار تحميل مواقيت الصلاة...</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings-section" class="section hidden">
      <div class="text-center mb-8">
        <h2 class="text-4xl font-bold text-amber-400 mb-4">الإعدادات</h2>
        <p class="text-lg text-slate-400">تخصيص تجربة الاستخدام</p>
      </div>
      
      <div class="max-w-2xl mx-auto space-y-6">
        <!-- Reciter Selection -->
        <div class="section-card rounded-xl p-6">
          <h3 class="text-xl font-semibold text-amber-400 mb-4">اختيار القارئ</h3>
          <div id="reciter-selector" class="w-full" title="اختيار القارئ">
            <!-- سيتم ملؤها بواسطة دالة updateReciterSelector -->
          </div>
        </div>
        
        <!-- Audio Settings -->
        <div class="section-card rounded-xl p-6">
          <h3 class="text-xl font-semibold text-amber-400 mb-4">إعدادات الصوت</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-slate-400 mb-2">مستوى الصوت</label>
              <input type="range" id="volumeSlider" min="0" max="100" value="80" class="w-full" title="مستوى الصوت">
            </div>
            <div>
              <label class="flex items-center space-x-2 rtl:space-x-reverse">
                <input type="checkbox" id="autoPlay" class="rounded border-slate-600 bg-slate-700 text-amber-500">
                <span class="text-sm text-slate-400">التشغيل التلقائي للآيات</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Display Settings -->
        <div class="section-card rounded-xl p-6">
          <h3 class="text-xl font-semibold text-amber-400 mb-4">إعدادات العرض</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-slate-400 mb-2">حجم الخط</label>
              <select id="fontSizeSelector" class="w-full rounded-lg p-2 bg-slate-700 text-slate-100" title="حجم الخط">
                <option value="small">صغير</option>
                <option value="medium" selected>متوسط</option>
                <option value="large">كبير</option>
                <option value="xlarge">كبير جداً</option>
              </select>
            </div>
            <div>
              <label class="flex items-center space-x-2 rtl:space-x-reverse">
                <input type="checkbox" id="darkMode" checked class="rounded border-slate-600 bg-slate-700 text-amber-500">
                <span class="text-sm text-slate-400">الوضع الليلي</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modals -->
  
  <!-- Surah View Modal -->
  <div id="surahModal" class="modal fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-slate-800 rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-slate-700">
          <h3 id="surahModalTitle" class="text-2xl font-semibold text-amber-400"></h3>
          <button id="closeSurahModal" class="text-slate-400 hover:text-amber-400" title="إغلاق">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="surahContent" class="flex-1 overflow-y-auto p-6 custom-scrollbar"></div>
        <div class="p-4 border-t border-slate-700">
          <div class="flex items-center space-x-4 rtl:space-x-reverse">
            <button id="playSurahBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg">
              تشغيل السورة
            </button>
            <div class="flex-1 bg-slate-700 rounded-full h-2">
              <div id="surahProgress" class="bg-amber-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio Player -->
  <audio id="audioPlayer" preload="metadata"></audio>

  <!-- Scripts -->
  <script>
    // متغيرات عامة وإعدادات
    const CONFIG = {
      QURAN_API: 'https://api.alquran.cloud/v1',
      ALQURAN_VIP_API: 'https://alquran.vip/APIs',
      QURAN_EDITION: 'ar.quran-uthmani',
      DEFAULT_RECITER: '4',
      SURAH_LIMIT: 114,
      RESULTS_PER_PAGE: 10,
      STORAGE_KEY: 'quranAppData'
    };

    // قائمة القراء الجديدة
    const QURAN_READERS = {
      "readers": [
        {"code": "ar.ahmedajamy",        "name": "احمد العجمي"},
        {"code": "ar.alafasy",           "name": "العفاسي"},
        {"code": "ar.alafasy-2",         "name": "العفاسي 2"},
        {"code": "ar.hudhaify",          "name": "الحذيفي"},
        {"code": "ar.hudhaify-2",        "name": "الحذيفي 2"},
        {"code": "ar.husary",            "name": "الحصري"},
        {"code": "ar.husary-2",          "name": "الحصري 2"},
        {"code": "ar.husarymujawwad",    "name": "الحصري المجود"},
        {"code": "ar.husarymujawwad-2",  "name": "الحصري المجود 2"},
        {"code": "ar.mahermuaiqly",      "name": "المعيقلي"},
        {"code": "ar.mahermuaiqly-2",    "name": "المعيقلي 2"},
        {"code": "ar.minshawi",          "name": "المنشاوي"},
        {"code": "ar.minshawi-2",        "name": "المنشاوي 2"},
        {"code": "ar.muhammadayyoub",    "name": "محمد أيوب"},
        {"code": "ar.muhammadayyoub-2",  "name": "محمد أيوب 2"},
        {"code": "ar.muhammadjibreel",   "name": "محمد جبريل"},
        {"code": "ar.muhammadjibreel-2", "name": "محمد جبريل 2"},
        {"code": "ar.shaatree",          "name": "الشاطري"},
        {"code": "ar.shaatree-2",        "name": "الشاطري 2"}
      ],
      "url_template": "https://cdn.islamic.network/quran/audio/128/{code}/{ayah_number}.mp3"
    };

    // متغيرات عامة
    let allAyahs = [];
    let allSurahs = [];
    let allSearchResults = [];
    let currentDisplayedResults = 0;
    let availableReciters = [];
    let currentReciter = localStorage.getItem('currentReciter') || 'ar.mahermuaiqly';
    let currentPlayingAudio = null;
    let currentKeyIndex = 0;
    let currentAyahElement = null;
    let db; // متغير قاعدة البيانات IndexedDB
    
    // متغيرات نظام التحميل الكسول
    const resultsPerPage = 5;
    let isLoadingMore = false;
    let searchResultsObserver = null;
    
    // متغيرات الصوت وDOM
    let audioPlayer;
    let searchInput, searchResults, voiceSearchBtn, exactMatchToggle, reciterSelector;
    
    // تهيئة المتغيرات عند تحميل الصفحة
    window.addEventListener('DOMContentLoaded', () => {
      // تهيئة متغيرات DOM
      audioPlayer = document.getElementById('audioPlayer');
      searchInput = document.getElementById('searchInput');
      searchResults = document.getElementById('searchResults');
      voiceSearchBtn = document.getElementById('voiceSearchBtn');
      exactMatchToggle = document.getElementById('exactMatchToggle');
      reciterSelector = document.getElementById('reciter-selector');
      
      // تهيئة أحداث العناصر
      initEventListeners();
    });

    // إعداد IndexedDB
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        if (!window.indexedDB) {
          console.log('⚠️ متصفحك لا يدعم IndexedDB، سيتم استخدام localStorage بدلاً من ذلك');
          resolve(false);
          return;
        }

        const request = window.indexedDB.open('QuranAppDB', 1);

        request.onerror = (event) => {
          console.error('❌ خطأ في فتح IndexedDB:', event.target.error);
          resolve(false);
        };

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // إنشاء مخزن للقرآن الكريم
          if (!db.objectStoreNames.contains('quran')) {
            const quranStore = db.createObjectStore('quran', { keyPath: 'id' });
            quranStore.createIndex('timestamp', 'timestamp', { unique: false });
          }
          
          // إنشاء مخزن للقراء
          if (!db.objectStoreNames.contains('reciters')) {
            const recitersStore = db.createObjectStore('reciters', { keyPath: 'id' });
            recitersStore.createIndex('timestamp', 'timestamp', { unique: false });
          }
          
          // إنشاء مخزن للإعدادات
          if (!db.objectStoreNames.contains('settings')) {
            db.createObjectStore('settings', { keyPath: 'id' });
          }
        };

        request.onsuccess = (event) => {
          db = event.target.result;
          console.log('✅ تم فتح IndexedDB بنجاح');
          
          // التعامل مع أخطاء الاتصال
          db.onerror = (event) => {
            console.error('❌ خطأ في IndexedDB:', event.target.error);
          };
          
          resolve(true);
        };
      });
    }

    // حفظ بيانات في IndexedDB
    function saveToIndexedDB(storeName, data, id = '1') {
      return new Promise((resolve, reject) => {
        if (!db) {
          console.warn('⚠️ IndexedDB غير متاح، يتم استخدام localStorage');
          try {
            localStorage.setItem(`quran-${storeName}-${id}`, JSON.stringify(data));
            localStorage.setItem(`quran-${storeName}-timestamp`, Date.now().toString());
            resolve(true);
          } catch (error) {
            console.error('❌ خطأ في حفظ البيانات في localStorage:', error);
            reject(error);
          }
          return;
        }

        try {
          const transaction = db.transaction([storeName], 'readwrite');
          const store = transaction.objectStore(storeName);
          
          const item = {
            id: id,
            data: data,
            timestamp: Date.now()
          };
          
          const request = store.put(item);
          
          request.onsuccess = () => {
            console.log(`✅ تم حفظ البيانات في ${storeName}`);
            resolve(true);
          };
          
          request.onerror = (event) => {
            console.error(`❌ خطأ في حفظ البيانات في ${storeName}:`, event.target.error);
            reject(event.target.error);
          };
        } catch (error) {
          console.error(`❌ خطأ في حفظ البيانات في ${storeName}:`, error);
          reject(error);
        }
      });
    }

    // استرجاع بيانات من IndexedDB
    function getFromIndexedDB(storeName, id = '1') {
      return new Promise((resolve, reject) => {
        if (!db) {
          console.warn('⚠️ IndexedDB غير متاح، يتم استخدام localStorage');
          try {
            const data = localStorage.getItem(`quran-${storeName}-${id}`);
            const timestamp = localStorage.getItem(`quran-${storeName}-timestamp`);
            
            if (data && timestamp) {
              resolve({
                data: JSON.parse(data),
                timestamp: parseInt(timestamp)
              });
            } else {
              resolve(null);
            }
          } catch (error) {
            console.error('❌ خطأ في استرجاع البيانات من localStorage:', error);
            reject(error);
          }
          return;
        }

        try {
          const transaction = db.transaction([storeName], 'readonly');
          const store = transaction.objectStore(storeName);
          const request = store.get(id);
          
          request.onsuccess = (event) => {
            const result = event.target.result;
            if (result) {
              console.log(`✅ تم استرجاع البيانات من ${storeName}`);
              resolve(result);
            } else {
              console.log(`⚠️ لا توجد بيانات في ${storeName}`);
              resolve(null);
            }
          };
          
          request.onerror = (event) => {
            console.error(`❌ خطأ في استرجاع البيانات من ${storeName}:`, event.target.error);
            reject(event.target.error);
          };
        } catch (error) {
          console.error(`❌ خطأ في استرجاع البيانات من ${storeName}:`, error);
          reject(error);
        }
      });
    }

    // Utility Functions
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function removeTashkeel(text) {
      if (typeof text !== 'string') return '';
      return text
        .replace(/[\u064B-\u0652]/g, '')
        .replace(/ٱ|[أإآ]/g, 'ا')
        .replace(/ى/g, 'ي')
        .replace(/ة/g, 'ه');
    }

    function highlight(text, query) {
      if (!query || typeof text !== 'string') return text;
      try {
        const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        return text.replace(regex, (match) => `<mark class="bg-amber-400/30 text-amber-100">${match}</mark>`);
      } catch (e) {
        return text;
      }
    }

    // تحميل بيانات القرآن الكريم
    async function loadQuranData() {
      // تحديث رسالة التحميل
      const initialMessage = document.getElementById('initialMessage');
      if (initialMessage) {
        initialMessage.innerHTML = '<div class="loader mx-auto mb-4"></div><p class="mt-2 text-slate-400">جار تحميل بيانات القرآن الكريم...</p>';
      }

      try {
        // محاولة استرجاع البيانات من IndexedDB أولاً
        const cachedData = await getFromIndexedDB('quran');
        
        // استخدام البيانات المخزنة إذا كانت موجودة وليست قديمة (أقل من 30 يوم)
        if (cachedData && cachedData.data) {
          const cacheAge = (Date.now() - cachedData.timestamp) / (1000 * 60 * 60 * 24);
          
          if (cacheAge < 30) {
            console.log('✅ استخدام بيانات القرآن من التخزين المحلي');
            
            if (Array.isArray(cachedData.data) && cachedData.data.length > 0) {
              allSurahs = cachedData.data;
              
              // استخراج جميع الآيات من جميع السور
              allAyahs = [];
              allSurahs.forEach(surah => {
                if (surah.ayahs && Array.isArray(surah.ayahs)) {
                  allAyahs.push(...surah.ayahs);
                }
              });
              
              if (initialMessage) {
                initialMessage.innerHTML = '<p class="text-green-400">تم تحميل البيانات بنجاح</p>';
                setTimeout(() => {
                }, 1500);
              }
              
              return allSurahs;
            }
          }
        }
        
        // محاولة استخدام ملف القرآن المحلي أولاً (للعمل بدون اتصال)
        try {
          console.log('🔄 محاولة تحميل بيانات القرآن من الملف المحلي...');
          if (initialMessage) {
            initialMessage.innerHTML = '<div class="loader mx-auto mb-4"></div><p class="mt-2 text-slate-400">جار تحميل بيانات القرآن المحلية...</p>';
          }
          
          const localResponse = await fetchWithRetry('/fallback-data/quran.json');
          
          if (localResponse.ok) {
            const localData = await localResponse.json();
            
            if (localData && localData.data && localData.data.surahs && Array.isArray(localData.data.surahs)) {
              console.log('✅ تم تحميل بيانات القرآن من الملف المحلي');
              allSurahs = localData.data.surahs;
              
              // استخراج جميع الآيات من جميع السور
              allAyahs = [];
              allSurahs.forEach(surah => {
                if (surah.ayahs && Array.isArray(surah.ayahs)) {
                  // إضافة رقم السورة لكل آية
                  surah.ayahs.forEach(ayah => {
                    ayah.surahNumber = surah.number;
                    ayah.ayahGlobalNumber = ayah.number;
                  });
                  
                  allAyahs.push(...surah.ayahs);
                }
              });
              
              // حفظ البيانات في IndexedDB
              try {
                await saveToIndexedDB('quran', allSurahs);
                console.log('✅ تم حفظ بيانات القرآن في التخزين المحلي');
              } catch (storageError) {
                console.warn('⚠️ لم يتم حفظ البيانات في التخزين المحلي:', storageError);
              }
              
              if (initialMessage) {
                initialMessage.innerHTML = '<p class="text-green-400">تم تحميل البيانات بنجاح</p>';
                setTimeout(() => {
                }, 1500);
              }
              
              return allSurahs;
            }
          }
          
          throw new Error('بيانات القرآن المحلية غير صالحة');
        } catch (localError) {
          console.warn('⚠️ لم يتم العثور على ملف القرآن المحلي، محاولة استخدام API:', localError);
        }
        
        // تحميل البيانات من الخادم
        console.log('🔄 تحميل بيانات القرآن من الخادم...');
        if (initialMessage) {
          initialMessage.innerHTML = '<div class="loader mx-auto mb-4"></div><p class="mt-2 text-slate-400">جار تحميل بيانات القرآن الكريم من الخادم...</p>';
        }
        
        // استخدام المصدر الرئيسي API
        const response = await fetchWithRetry(`${CONFIG.QURAN_API}/quran/${CONFIG.QURAN_EDITION}`);
        
        if (!response.ok) {
          throw new Error(`فشل تحميل بيانات القرآن: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.data && data.data.surahs && Array.isArray(data.data.surahs)) {
          allSurahs = data.data.surahs;
          
          // استخراج جميع الآيات من جميع السور
          allAyahs = [];
          allSurahs.forEach(surah => {
            if (surah.ayahs && Array.isArray(surah.ayahs)) {
              // إضافة رقم السورة لكل آية
              surah.ayahs.forEach(ayah => {
                ayah.surahNumber = surah.number;
                ayah.ayahGlobalNumber = ayah.number;
              });
              
              allAyahs.push(...surah.ayahs);
            }
          });
          
          // حفظ البيانات في IndexedDB
          try {
            await saveToIndexedDB('quran', allSurahs);
            console.log('✅ تم حفظ بيانات القرآن في التخزين المحلي');
          } catch (storageError) {
            console.warn('⚠️ لم يتم حفظ البيانات في التخزين المحلي:', storageError);
          }
          
          if (initialMessage) {
            initialMessage.innerHTML = '<p class="text-green-400">تم تحميل البيانات بنجاح</p>';
            setTimeout(() => {
            }, 1500);
          }
          
          return allSurahs;
        } else {
          throw new Error('بيانات القرآن غير صالحة');
        }
      } catch (error) {
        console.error('❌ خطأ في تحميل بيانات القرآن:', error);
        
        // محاولة استخدام المصدر البديل في حالة فشل المصدر الرئيسي
        try {
          console.log('🔄 محاولة استخدام المصدر البديل...');
          if (initialMessage) {
            initialMessage.innerHTML = '<div class="loader mx-auto mb-4"></div><p class="mt-2 text-slate-400">جار المحاولة باستخدام مصدر بديل...</p>';
          }
          
          const alternativeResponse = await fetchWithRetry('https://api.quran.com/api/v4/chapters?language=ar');
          
          if (!alternativeResponse.ok) {
            throw new Error(`فشل المصدر البديل: ${alternativeResponse.status}`);
          }
          
          const alternativeData = await alternativeResponse.json();
          
          if (alternativeData && alternativeData.chapters && Array.isArray(alternativeData.chapters)) {
            // تحويل البيانات إلى التنسيق المطلوب
            const formattedSurahs = [];
            
            // تحميل آيات كل سورة على حدة
            for (let i = 0; i < alternativeData.chapters.length; i++) {
              const chapter = alternativeData.chapters[i];
              
              try {
                if (initialMessage) {
                  initialMessage.innerHTML = `<div class="loader mx-auto mb-4"></div><p class="mt-2 text-slate-400">جار تحميل سورة ${chapter.name_arabic} (${i + 1}/${alternativeData.chapters.length})...</p>`;
                }
                
                const versesResponse = await fetchWithRetry(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${chapter.id}`);
                
                if (!versesResponse.ok) {
                  throw new Error(`فشل تحميل آيات السورة: ${versesResponse.status}`);
                }
                
                const versesData = await versesResponse.json();
                
                if (versesData && versesData.verses && Array.isArray(versesData.verses)) {
                  const formattedAyahs = versesData.verses.map((verse, index) => ({
                    number: (chapter.id - 1) * 1000 + (index + 1),
                    text: verse.text_uthmani,
                    numberInSurah: index + 1,
                    surahNumber: chapter.id,
                    ayahGlobalNumber: (chapter.id - 1) * 1000 + (index + 1)
                  }));
                  
                  formattedSurahs.push({
                    number: chapter.id,
                    name: chapter.name_arabic,
                    englishName: chapter.name_simple,
                    englishNameTranslation: chapter.translated_name.name,
                    revelationType: chapter.revelation_place === 'makkah' ? 'Meccan' : 'Medinan',
                    ayahs: formattedAyahs
                  });
                }
              } catch (verseError) {
                console.error(`❌ خطأ في تحميل آيات سورة ${chapter.name_arabic}:`, verseError);
                // استمرار للسورة التالية حتى في حالة حدوث خطأ
              }
            }
            
            if (formattedSurahs.length > 0) {
              allSurahs = formattedSurahs;
              
              // استخراج جميع الآيات من جميع السور
              allAyahs = [];
              allSurahs.forEach(surah => {
                if (surah.ayahs && Array.isArray(surah.ayahs)) {
                  allAyahs.push(...surah.ayahs);
                }
              });
              
              // حفظ البيانات في IndexedDB
              try {
                await saveToIndexedDB('quran', allSurahs);
                console.log('✅ تم حفظ بيانات القرآن من المصدر البديل في التخزين المحلي');
              } catch (storageError) {
                console.warn('⚠️ لم يتم حفظ البيانات في التخزين المحلي:', storageError);
              }
              
              if (initialMessage) {
                initialMessage.innerHTML = '<p class="text-green-400">تم تحميل البيانات بنجاح</p>';
                setTimeout(() => {
                }, 1500);
              }
              
              return allSurahs;
            } else {
              throw new Error('لم يتم تحميل أي سورة من المصدر البديل');
            }
          } else {
            throw new Error('بيانات المصدر البديل غير صالحة');
          }
        } catch (alternativeError) {
          console.error('❌ فشل المصدر البديل:', alternativeError);
          
          // تحميل بيانات احتياطية محدودة (السور الأكثر شيوعًا فقط)
          if (initialMessage) {
            initialMessage.innerHTML = '<div class="text-amber-400 mb-4">⚠️ استخدام بيانات محدودة</div><p class="text-slate-400">تعذر الاتصال بالخادم، سيتم استخدام بيانات محدودة</p>';
          }
          
          // استخدام بيانات احتياطية للسور الأكثر استخدامًا
          loadFallbackQuranData();
          
          return allSurahs;
        }
      }
    }
    
    // دالة مساعدة للطلبات مع إعادة المحاولة
    async function fetchWithRetry(url, options = {}, retries = 3, delay = 1000) {
      try {
        return await fetch(url, options);
      } catch (error) {
        if (retries <= 1) throw error;
        
        await new Promise(resolve => setTimeout(resolve, delay));
        return fetchWithRetry(url, options, retries - 1, delay * 1.5);
      }
    }
    
    // تحميل بيانات القرآن الاحتياطية (محدودة)
    function loadFallbackQuranData() {
      console.log('⚠️ استخدام بيانات القرآن الاحتياطية المحدودة');
      
      // بيانات احتياطية للسور القصيرة الشائعة
      const fallbackSurahs = [
        {
          number: 1,
          name: "الفاتحة",
          englishName: "Al-Fatiha",
          englishNameTranslation: "The Opening",
          revelationType: "Meccan",
          ayahs: [
            { number: 1, text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", numberInSurah: 1, surahNumber: 1, ayahGlobalNumber: 1 },
            { number: 2, text: "الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ", numberInSurah: 2, surahNumber: 1, ayahGlobalNumber: 2 },
            { number: 3, text: "الرَّحْمَٰنِ الرَّحِيمِ", numberInSurah: 3, surahNumber: 1, ayahGlobalNumber: 3 },
            { number: 4, text: "مَالِكِ يَوْمِ الدِّينِ", numberInSurah: 4, surahNumber: 1, ayahGlobalNumber: 4 },
            { number: 5, text: "إِيَّاكَ نَعْبُدُ وَإِيَّاكَ نَسْتَعِينُ", numberInSurah: 5, surahNumber: 1, ayahGlobalNumber: 5 },
            { number: 6, text: "اهْدِنَا الصِّرَاطَ الْمُسْتَقِيمَ", numberInSurah: 6, surahNumber: 1, ayahGlobalNumber: 6 },
            { number: 7, text: "صِرَاطَ الَّذِينَ أَنْعَمْتَ عَلَيْهِمْ غَيْرِ الْمَغْضُوبِ عَلَيْهِمْ وَلَا الضَّالِّينَ", numberInSurah: 7, surahNumber: 1, ayahGlobalNumber: 7 }
          ]
        },
        {
          number: 112,
          name: "الإخلاص",
          englishName: "Al-Ikhlas",
          englishNameTranslation: "Sincerity",
          revelationType: "Meccan",
          ayahs: [
            { number: 6222, text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", numberInSurah: 1, surahNumber: 112, ayahGlobalNumber: 6222 },
            { number: 6223, text: "قُلْ هُوَ اللَّهُ أَحَدٌ", numberInSurah: 1, surahNumber: 112, ayahGlobalNumber: 6223 },
            { number: 6224, text: "اللَّهُ الصَّمَدُ", numberInSurah: 2, surahNumber: 112, ayahGlobalNumber: 6224 },
            { number: 6225, text: "لَمْ يَلِدْ وَلَمْ يُولَدْ", numberInSurah: 3, surahNumber: 112, ayahGlobalNumber: 6225 },
            { number: 6226, text: "وَلَمْ يَكُنْ لَهُ كُفُوًا أَحَدٌ", numberInSurah: 4, surahNumber: 112, ayahGlobalNumber: 6226 }
          ]
        },
        {
          number: 113,
          name: "الفلق",
          englishName: "Al-Falaq",
          englishNameTranslation: "The Daybreak",
          revelationType: "Meccan",
          ayahs: [
            { number: 6227, text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", numberInSurah: 1, surahNumber: 113, ayahGlobalNumber: 6227 },
            { number: 6228, text: "قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ", numberInSurah: 1, surahNumber: 113, ayahGlobalNumber: 6228 },
            { number: 6229, text: "مِنْ شَرِّ مَا خَلَقَ", numberInSurah: 2, surahNumber: 113, ayahGlobalNumber: 6229 },
            { number: 6230, text: "وَمِنْ شَرِّ غَاسِقٍ إِذَا وَقَبَ", numberInSurah: 3, surahNumber: 113, ayahGlobalNumber: 6230 },
            { number: 6231, text: "وَمِنْ شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ", numberInSurah: 4, surahNumber: 113, ayahGlobalNumber: 6231 },
            { number: 6232, text: "وَمِنْ شَرِّ حَاسِدٍ إِذَا حَسَدَ", numberInSurah: 5, surahNumber: 113, ayahGlobalNumber: 6232 }
          ]
        },
        {
          number: 114,
          name: "الناس",
          englishName: "An-Nas",
          englishNameTranslation: "Mankind",
          revelationType: "Meccan",
          ayahs: [
            { number: 6233, text: "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ", numberInSurah: 1, surahNumber: 114, ayahGlobalNumber: 6233 },
            { number: 6234, text: "قُلْ أَعُوذُ بِرَبِّ النَّاسِ", numberInSurah: 1, surahNumber: 114, ayahGlobalNumber: 6234 },
            { number: 6235, text: "مَلِكِ النَّاسِ", numberInSurah: 2, surahNumber: 114, ayahGlobalNumber: 6235 },
            { number: 6236, text: "إِلَٰهِ النَّاسِ", numberInSurah: 3, surahNumber: 114, ayahGlobalNumber: 6236 },
            { number: 6237, text: "مِنْ شَرِّ الْوَسْوَاسِ الْخَنَّاسِ", numberInSurah: 4, surahNumber: 114, ayahGlobalNumber: 6237 },
            { number: 6238, text: "الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ", numberInSurah: 5, surahNumber: 114, ayahGlobalNumber: 6238 },
            { number: 6239, text: "مِنَ الْجِنَّةِ وَالنَّاسِ", numberInSurah: 6, surahNumber: 114, ayahGlobalNumber: 6239 }
          ]
        }
      ];
      
      allSurahs = fallbackSurahs;
      
      // استخراج جميع الآيات من جميع السور
      allAyahs = [];
      allSurahs.forEach(surah => {
        if (surah.ayahs && Array.isArray(surah.ayahs)) {
          allAyahs.push(...surah.ayahs);
        }
      });
    }

    function showLoading(element) {
      element.innerHTML = '<div class="text-center p-4"><div class="loader mx-auto"></div></div>';
    }

    function showError(element, message) {
      element.innerHTML = `<div class="text-center p-4 text-red-400">${message}</div>`;
    }

    // Load API configuration from server
    async function loadApiKeys() {
      try {
        const response = await fetch('/api/health');
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`✅ الخادم متصل - ${data.message}`);
        
        return true;
        
      } catch (error) {
        console.error('❌ خطأ في الاتصال بالخادم:', error);
        console.log('🔄 سيتم استخدام البحث التقليدي فقط');
        return false;
      }
    }

    
    
    // إجراء البحث الشامل
    async function performSearch(query, isRealTime = false) {
      if (!query || query.length < 2) {
        hideSearchDropdown();
        return;
      }
      
      // عرض القائمة المنسدلة فوراً
      showSearchDropdown();
      searchResults.innerHTML = '<div class="col-span-full text-center py-4"><div class="loader mx-auto"></div><p class="mt-2 text-slate-400">جار البحث...</p></div>';
      
      try {
        // استخدام نظام التخزين المؤقت للبحث
        const cacheKey = `search-${query}`;
        const cachedResults = sessionStorage.getItem(cacheKey);
        
        let results;
        if (cachedResults) {
          // استخدام النتائج المخزنة مؤقتًا
          results = JSON.parse(cachedResults);
          console.log('✅ استخدام نتائج البحث من التخزين المؤقت');
        } else {
          // بحث جديد
          results = await searchQuran(query);
          
          // تخزين النتائج مؤقتًا (لمدة الجلسة)
          sessionStorage.setItem(cacheKey, JSON.stringify(results));
        }
        
        // عرض ملخص النتائج
        if (resultsSummary) {
          resultsSummary.textContent = `تم العثور على ${results.length} نتيجة`;
          resultsSummary.classList.remove('hidden');
        }
        
        // تخزين النتائج في متغير عام للاستخدام لاحقاً
        allSearchResults = results;
        currentDisplayedResults = 0;
        
        // عرض النتائج كبطاقات
        displaySearchResultsCards(results, query);
        
      } catch (error) {
        console.error('❌ خطأ في البحث:', error);
        
        searchResults.innerHTML = `
          <div class="col-span-full text-center text-red-400 py-4">
            <p>${error.message || 'حدث خطأ أثناء البحث'}</p>
            <button id="retrySearch" class="mt-4 bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg">
              إعادة المحاولة
            </button>
          </div>
        `;
        
        // إضافة حدث إعادة المحاولة
        document.getElementById('retrySearch')?.addEventListener('click', () => performSearch(query));
      }
    }
    
    // عرض نتائج البحث في القائمة المنسدلة
    function displaySearchDropdownResults(results, query) {
      const grid = searchDropdown.querySelector('.search-results-grid');
      
      if (!grid) return;
      
      if (results.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-slate-400 py-4">لا توجد نتائج مطابقة</div>';
        return;
      }
      
      // تخزين النتائج في متغير عام للاستخدام لاحقاً
      allSearchResults = results;
      currentDisplayedResults = 0;
      
      // عرض أول 3 نتائج فقط للاستجابة السريعة
      const initialResults = results.slice(0, 3);
      
      // إنشاء الشبكة لعرض البطاقات
      grid.innerHTML = '';
      
      // إضافة البطاقات الأولية بشكل فوري
      initialResults.forEach((result, index) => {
        const card = createSearchResultCard(result, query, index);
        grid.appendChild(card);
      });
      
      // إضافة زر "تحميل المزيد" إذا كان هناك المزيد من النتائج
      if (results.length > 3) {
        const loadMoreContainer = document.createElement('div');
        loadMoreContainer.className = 'col-span-full text-center py-2';
        loadMoreContainer.innerHTML = `
          <button id="loadMoreDropdownResults" class="text-amber-400 hover:text-amber-300 text-sm">
            عرض المزيد من النتائج (${results.length - 3})
          </button>
        `;
        grid.appendChild(loadMoreContainer);
        
        // إضافة حدث لتحميل المزيد من النتائج
        document.getElementById('loadMoreDropdownResults')?.addEventListener('click', () => {
          loadMoreDropdownResults(results, query, 3);
        });
      }
    }
    
    // تحميل المزيد من نتائج البحث في القائمة المنسدلة
    function loadMoreDropdownResults(results, query, startIndex) {
      const grid = searchDropdown.querySelector('.search-results-grid');
      const loadMoreButton = document.getElementById('loadMoreDropdownResults');
      
      if (!grid || !loadMoreButton) return;
      
      // تحديد النتائج التي سيتم تحميلها
      const nextBatch = results.slice(startIndex, startIndex + 5);
      currentDisplayedResults = startIndex + nextBatch.length;
      
      // إزالة زر "تحميل المزيد"
      loadMoreButton.parentElement.remove();
      
      // إضافة البطاقات الجديدة
      nextBatch.forEach((result, index) => {
        const card = createSearchResultCard(result, query, startIndex + index);
        grid.appendChild(card);
      });
      
      // إضافة زر "تحميل المزيد" إذا كان هناك المزيد من النتائج
      if (currentDisplayedResults < results.length) {
        const loadMoreContainer = document.createElement('div');
        loadMoreContainer.className = 'col-span-full text-center py-2';
        loadMoreContainer.innerHTML = `
          <button id="loadMoreDropdownResults" class="text-amber-400 hover:text-amber-300 text-sm">
            عرض المزيد من النتائج (${results.length - currentDisplayedResults})
          </button>
        `;
        grid.appendChild(loadMoreContainer);
        
        // إضافة حدث لتحميل المزيد من النتائج
        document.getElementById('loadMoreDropdownResults')?.addEventListener('click', () => {
          loadMoreDropdownResults(results, query, currentDisplayedResults);
        });
      }
    }
    
    // إنشاء بطاقة نتيجة بحث للقائمة المنسدلة
    function createSearchResultCard(result, query, index) {
      const card = document.createElement('div');
      card.className = 'search-result-card p-3 cursor-pointer';
      card.style.setProperty('--animation-order', index);
      card.onclick = () => showSurahModal(result.surah_number, result.ayah_number);
      
      // استخدام النص المميز من محرك البحث إذا كان متاحاً
      const displayText = result.highlightedText || result.ayah_text;
      
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div>
            <span class="text-amber-400 font-semibold">سورة ${result.surah_name}</span>
            <span class="text-slate-400 text-sm mr-2">الآية ${result.ayah_number}</span>
          </div>
          <span class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded-full">${result.surah_number}:${result.ayah_number}</span>
        </div>
        <p class="text-slate-300 text-sm mt-2 font-quran-sm line-clamp-3">${displayText}</p>
        <div class="flex justify-between items-center mt-3">
          <button class="play-button bg-amber-600 hover:bg-amber-500 text-white text-xs px-2 py-1 rounded-lg flex items-center" onclick="event.stopPropagation(); playAyah(${result.ayah_key}, this)">
            <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
            </svg>
            استمع
          </button>
        </div>
      `;
      
      return card;
    }
    
    // البحث في القرآن باستخدام محرك البحث المتقدم
    async function searchQuran(query) {
      if (!query || query.length < 2) {
        return [];
      }
      
      // التأكد من تحميل بيانات القرآن أولاً
      if (allSurahs.length === 0) {
        await loadQuranData();
      }
      
      // إنشاء محرك البحث وتهيئته إذا لم يكن موجوداً
      if (!window.quranSearchEngine || !window.quranSearchEngine.isInitialized) {
        console.log('🔍 تهيئة محرك البحث المتقدم...');
        window.quranSearchEngine = new QuranSearchEngine();
        await window.quranSearchEngine.initialize(allSurahs);
      }
      
      // تنظيف الاستعلام
      const cleanQuery = query.trim();
      
      // التحقق من وجود البحث المطابق تماماً
      const exactMatch = document.getElementById('exactMatchToggle')?.checked || false;
      
      // استخدام محرك البحث المتقدم
      const searchOptions = {
        exactMatch: exactMatch,
        limit: 100,
        includeSurahInfo: true,
        includeText: true,
        sortByRelevance: true
      };
      
      console.log(`🔍 البحث عن: "${cleanQuery}" (مطابقة تامة: ${exactMatch ? 'نعم' : 'لا'})`);
      const searchResults = window.quranSearchEngine.search(cleanQuery, searchOptions);
      
      // تحويل النتائج إلى التنسيق المطلوب
      const formattedResults = searchResults.map(result => ({
        surah_number: result.surah,
        surah_name: result.surahName,
        ayah_number: result.ayah,
        ayah_text: result.text,
        ayah_key: result.globalNumber,
        score: result.score / 100, // تحويل الدرجة إلى نطاق 0-1
        highlightedText: result.highlightedText || result.text,
        matchType: result.matchType
      }));
      
      console.log(`✅ تم العثور على ${formattedResults.length} نتيجة`);
      return formattedResults;
    }
    
    // عرض نتائج البحث كبطاقات
    function displaySearchResultsCards(results, query) {
      if (!results || results.length === 0) {
        searchResults.innerHTML = '<div class="col-span-full text-center text-slate-400 py-4">لا توجد نتائج مطابقة</div>';
        return;
      }
      
      // عرض أول 6 نتائج فقط للاستجابة السريعة
      const initialResults = results.slice(0, 6);
      currentDisplayedResults = initialResults.length;
      
      // إنشاء البطاقات
      searchResults.innerHTML = '';
      
      initialResults.forEach((result, index) => {
        const card = createResultCard(result, query, index);
        searchResults.appendChild(card);
      });
      
      // إظهار زر "تحميل المزيد" إذا كان هناك المزيد من النتائج
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      if (loadMoreContainer) {
        if (results.length > initialResults.length) {
          loadMoreContainer.classList.remove('hidden');
          const loadMoreButton = document.getElementById('loadMoreButton');
          if (loadMoreButton) {
            loadMoreButton.textContent = `عرض المزيد من النتائج (${results.length - initialResults.length})`;
            
            // إضافة حدث لتحميل المزيد من النتائج
            loadMoreButton.onclick = () => loadMoreSearchResults(results, query);
          }
        } else {
          loadMoreContainer.classList.add('hidden');
        }
      }
    }
    
    // تحميل المزيد من نتائج البحث
    function loadMoreSearchResults(results, query) {
      const nextBatch = results.slice(currentDisplayedResults, currentDisplayedResults + 6);
      
      if (nextBatch.length === 0) return;
      
      nextBatch.forEach((result, index) => {
        const card = createResultCard(result, query, currentDisplayedResults + index);
        searchResults.appendChild(card);
      });
      
      currentDisplayedResults += nextBatch.length;
      
      // تحديث زر "تحميل المزيد"
      const loadMoreButton = document.getElementById('loadMoreButton');
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      
      if (loadMoreButton && loadMoreContainer) {
        if (currentDisplayedResults < results.length) {
          loadMoreButton.textContent = `عرض المزيد من النتائج (${results.length - currentDisplayedResults})`;
        } else {
          loadMoreContainer.classList.add('hidden');
        }
      }
    }
    
    // إنشاء بطاقة نتيجة البحث
    function createResultCard(result, query, index) {
      const card = document.createElement('div');
      card.className = 'search-result-card bg-slate-700 rounded-lg p-4 hover:bg-slate-600 transition-colors duration-200 cursor-pointer fade-in';
      card.style.setProperty('--animation-order', index);
      card.onclick = () => showSurahModal(result.surah_number, result.ayah_number);
      
      // استخدام النص المميز من محرك البحث إذا كان متاحاً
      let displayText = result.text || result.ayah_text;
      
      // تمييز مصطلح البحث في النص
      if (query && query.length > 2) {
        displayText = highlightSearchTerm(displayText, query);
      }
      
      card.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div>
            <span class="text-amber-400 font-semibold">سورة ${result.surah_name || result.surahName}</span>
            <span class="text-slate-400 text-sm mr-2">الآية ${result.ayah_number || result.numberInSurah}</span>
          </div>
          <span class="text-xs bg-slate-800 text-slate-300 px-2 py-1 rounded-full">${result.surah_number || result.surahNumber}:${result.ayah_number || result.numberInSurah}</span>
        </div>
        <p class="text-slate-300 text-sm mt-2 font-quran-sm line-clamp-3">${displayText}</p>
        <div class="flex justify-between items-center mt-3">
          <button class="play-button bg-amber-600 hover:bg-amber-500 text-white text-xs px-2 py-1 rounded-lg flex items-center" onclick="event.stopPropagation(); playAyah(${result.ayah_key || result.ayahGlobalNumber}, this)" title="استمع للآية" aria-label="استمع للآية">
            <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
            </svg>
            استمع
          </button>
        </div>
      `;
      
      return card;
    }
    
    // إعداد التحميل الكسول للنتائج
    function setupLazyLoading(results, query, startIndex) {
      const searchResultsContainer = document.getElementById('searchResultsContainer');
      
      // إنشاء عنصر مراقبة التمرير
      const loadMoreTrigger = document.createElement('div');
      loadMoreTrigger.className = 'load-more-trigger';
      loadMoreTrigger.style.height = '20px';
      searchResultsContainer.appendChild(loadMoreTrigger);
      
      let currentIndex = startIndex;
      const batchSize = 5; // عدد النتائج التي يتم تحميلها في كل مرة
      
      // إنشاء مراقب التقاطع
      const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && currentIndex < results.length) {
          // تحميل المزيد من النتائج
          const nextBatch = results.slice(currentIndex, currentIndex + batchSize);
          currentIndex += batchSize;
          
          // إضافة البطاقات الجديدة
          nextBatch.forEach((result, index) => {
            const card = createResultCard(result, query, currentIndex + index);
            searchResultsContainer.insertBefore(card, loadMoreTrigger);
          });
          
          // إذا تم تحميل جميع النتائج، إزالة المراقب
          if (currentIndex >= results.length) {
            observer.disconnect();
            searchResultsContainer.removeChild(loadMoreTrigger);
          }
        }
      }, { threshold: 0.1 });
      
      // بدء مراقبة عنصر التحميل
      observer.observe(loadMoreTrigger);
    }
    
    // دالة لإزالة التشكيل من النص العربي
    function removeTashkeel(text) {
      // الحركات والتشكيل في اللغة العربية
      const tashkeelChars = /[\u064B-\u065F\u0670]/g;
      return text.replace(tashkeelChars, '');
    }
    
    // دالة لحساب التشابه بين كلمتين (خوارزمية Levenshtein Distance)
    function calculateSimilarity(str1, str2) {
      if (str1 === str2) return 1.0;
      
      const len1 = str1.length;
      const len2 = str2.length;
      
      // مصفوفة لحساب المسافة بين الكلمتين
      const matrix = Array(len1 + 1).fill().map(() => Array(len2 + 1).fill(0));
      
      // تهيئة المصفوفة
      for (let i = 0; i <= len1; i++) matrix[i][0] = i;
      for (let j = 0; j <= len2; j++) matrix[0][j] = j;
      
      // حساب المسافة
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1, // حذف
            matrix[i][j - 1] + 1, // إضافة
            matrix[i - 1][j - 1] + cost // استبدال
          );
        }
      }
      
      // حساب التشابه (1 - المسافة المعيارية)
      const maxLen = Math.max(len1, len2);
      return maxLen > 0 ? 1 - matrix[len1][len2] / maxLen : 1;
    }
    
    // عرض القائمة المنسدلة للبحث
    function displaySearchDropdown(results, query) {
      const searchDropdown = document.getElementById('searchDropdown');
      
      if (!searchDropdown) {
        return;
      }

      // إنشاء محتوى القائمة المنسدلة
      searchDropdown.innerHTML = '';
      
      // إضافة رأس القائمة مع زر الإغلاق
      const header = document.createElement('div');
      header.className = 'search-dropdown-header';
      header.innerHTML = `
        <h3 class="text-lg font-semibold text-amber-400">نتائج البحث عن "${query}"</h3>
        <button class="search-dropdown-close" title="إغلاق">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      searchDropdown.appendChild(header);
      
      // إضافة مستمع حدث لزر الإغلاق
      header.querySelector('.search-dropdown-close').addEventListener('click', hideSearchDropdown);
      
      if (results.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'p-4 text-center text-slate-400';
        noResults.textContent = 'لا توجد نتائج';
        searchDropdown.appendChild(noResults);
      } else {
        // إضافة ملخص النتائج
        const summary = document.createElement('div');
        summary.className = 'text-slate-400 text-sm mb-4';
        summary.textContent = `تم العثور على ${results.length} نتيجة`;
        searchDropdown.appendChild(summary);
        
        // إنشاء شبكة لعرض البطاقات
        const grid = document.createElement('div');
        grid.className = 'search-results-grid';
        searchDropdown.appendChild(grid);
        
        // عرض أول 10 نتائج فقط للاستجابة السريعة
        const limitedResults = results.slice(0, 10);
        
        // إضافة البطاقات
        limitedResults.forEach((result, index) => {
          // استخدام النص الأصلي بدون تمييز لتجنب مشاكل الأخطاء الإملائية
          const displayText = result.ayah_text;
          
          const card = document.createElement('div');
          card.className = 'search-result-card';
          card.style.setProperty('--animation-order', index);
          card.onclick = () => showSurahModal(result.surah_number, result.ayah_number);
          
          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="text-amber-400 font-semibold">سورة ${result.surah_name}</span>
                <span class="text-slate-400 text-sm mr-2">الآية ${result.ayah_number}</span>
              </div>
              <span class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded-full">${result.surah_number}:${result.ayah_number}</span>
            </div>
            <p class="text-slate-300 text-sm mt-2 font-quran-sm line-clamp-3">${displayText}</p>
            <div class="flex justify-between items-center mt-3">
              <button class="play-button bg-amber-600 hover:bg-amber-500 text-white text-xs px-2 py-1 rounded-lg flex items-center" onclick="event.stopPropagation(); playAyah(${result.ayah_key}, this)">
                <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
                </svg>
                استمع
              </button>
              <span class="text-xs text-slate-500">${Math.round(result.score * 100)}% تطابق</span>
            </div>
          `;
          
          grid.appendChild(card);
        });
        
        // إعداد التحميل الكسول للنتائج الإضافية
        setupLazyLoading(results, query);
        
        // إضافة زر عرض المزيد من النتائج إذا كان هناك المزيد
        if (results.length > 10) {
          const showMoreButton = document.createElement('div');
          showMoreButton.className = 'text-center mt-4 pb-2';
          showMoreButton.innerHTML = `
            <button class="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg transition-colors">
              عرض جميع النتائج (${results.length})
            </button>
          `;
          showMoreButton.querySelector('button').onclick = () => {
            hideSearchDropdown();
            performSearch(query, false);
          };
          searchDropdown.appendChild(showMoreButton);
        }
      }
      
      // عرض القائمة المنسدلة
      searchDropdown.classList.remove('hidden');
    }
    
    // إظهار قائمة نتائج البحث
    function showSearchDropdown() {
      // إظهار القائمة المنسدلة بشكل فوري
      searchDropdown.classList.remove('hidden');
      
      // تحسين تأثير الظهور
      searchDropdown.style.opacity = '0';
      searchDropdown.style.transform = 'translate(-50%, -48%)';
      
      // تطبيق التأثير بعد فترة قصيرة جدًا
      setTimeout(() => {
        searchDropdown.style.opacity = '1';
        searchDropdown.style.transform = 'translate(-50%, -50%)';
      }, 10);
      
      // إضافة حدث للزر الإغلاق إذا لم يكن موجوداً
      const closeButton = searchDropdown.querySelector('.search-dropdown-close');
      if (closeButton && !closeButton._hasClickListener) {
        closeButton.addEventListener('click', hideSearchDropdown);
        closeButton._hasClickListener = true;
      }
    }
    
    // إخفاء قائمة نتائج البحث
    function hideSearchDropdown() {
      if (!searchDropdown) return;
      
      // إخفاء القائمة المنسدلة بتأثير انتقالي
      searchDropdown.style.opacity = '0';
      searchDropdown.style.transform = 'translate(-50%, -48%)';
      
      // إزالة القائمة بعد انتهاء التأثير
      setTimeout(() => {
        searchDropdown.classList.add('hidden');
        
        // إعادة تعيين التحويل لتجنب مشاكل عند إظهار القائمة مرة أخرى
        searchDropdown.style.transform = 'translate(-50%, -50%)';
      }, 200);
    }
    
    // عرض نتائج البحث في الصفحة
    function displaySearchResults(results, query) {
      const searchResults = document.getElementById('searchResults');
      
      if (!searchResults) {
        return;
      }
      
      // تنظيف مستمعات الأحداث السابقة
      cleanupSearchEvents();
      
      // تخزين النتائج في المتغير العام
      allSearchResults = results;
      currentDisplayedResults = 0;
      
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="p-6 text-center text-slate-400">لا توجد نتائج لهذا البحث</div>';
        return;
      }

      // إنشاء عنوان وملخص النتائج
      let html = `
        <div class="mb-6">
          <h2 class="text-2xl font-semibold text-amber-400 mb-2">نتائج البحث عن "${query}"</h2>
          <p class="text-slate-400">${results.length} نتيجة</p>
        </div>
        <div id="searchResultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div id="loadingIndicator" class="text-center p-4 hidden">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-amber-400"></div>
        </div>
        <div id="loadMoreContainer" class="text-center mt-6 hidden">
          <button id="loadMoreButton" class="bg-amber-600 hover:bg-amber-500 text-white px-6 py-3 rounded-lg transition-colors">
            تحميل المزيد من النتائج
          </button>
        </div>
      `;
      
      searchResults.innerHTML = html;
      
      // تحميل الدفعة الأولى من النتائج
      loadMoreResults();
      
      // إعداد مراقب التمرير باستخدام Intersection Observer
      setupScrollObserver();
      
      // إضافة مستمع لزر تحميل المزيد
      document.getElementById('loadMoreButton')?.addEventListener('click', loadMoreResults);
    }
    
    
    // تمييز مصطلح البحث في النص
    function highlightSearchTerm(text, query) {
      if (!query || query.length < 2 || !text) {
        return text;
      }
      
      // تنظيف النص والاستعلام
      const cleanQuery = query.trim()
        .replace(/[^\p{L}\p{N}\s]/gu, ' ')
        .replace(/\s+/g, ' ');
      
      // تقسيم الاستعلام إلى كلمات
      const queryWords = cleanQuery.split(' ').filter(word => word.length > 1);
      
      // إنشاء تعبير منتظم يطابق أي من الكلمات
      if (queryWords.length === 0) return text;
      
      // إنشاء نسخة من النص للتعديل
      let result = text;
      
      // تمييز كل كلمة على حدة
      queryWords.forEach(word => {
        // هروب الأحرف الخاصة في التعبير المنتظم
        const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // إنشاء تعبير منتظم للكلمة
        const regex = new RegExp(`(${escapedWord})`, 'gi');
        
        // استبدال الكلمة بنسخة مميزة
        result = result.replace(regex, '<mark>$1</mark>');
      });
      
      return result;
    }
    
    // دالة لتأخير تنفيذ الدالة (للبحث الفوري)
    function debounce(func, delay) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }



    // دالة مساعدة لحساب عدد مرات تطابق الكلمات
    function countMatches(text, query) {
      const normalizedText = removeTashkeel(text.toLowerCase());
      const normalizedQuery = removeTashkeel(query.toLowerCase());
      const queryWords = normalizedQuery.split(/\s+/);
      
      let matchCount = 0;
      queryWords.forEach(word => {
        if (word.length > 2 && normalizedText.includes(word)) {
          matchCount++;
        }
      });
      
      return matchCount;
    }

    function displaySearchResults(results, query, isRealTime) {
      if (isRealTime) {
        displayDropdownResults(results, query);
      } else {
        displayFullResults(results, query);
      }
    }

    function displayDropdownResults(results, query) {
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-slate-400 text-center">لا توجد نتائج</div>';
        showSearchDropdown();
        return;
      }

      const limitedResults = results.slice(0, 5);
      searchResults.innerHTML = limitedResults.map(result => `
        <div class="search-result-item p-3 cursor-pointer rounded-lg transition-colors" 
             data-ayah="${result.ayahGlobalNumber}">
          <div class="text-sm text-amber-400 mb-1">${result.surahName} - آية ${result.numberInSurah}</div>
          <div class="font-quran-sm text-slate-200">${highlight(result.text.substring(0, 100), query)}...</div>
        </div>
      `).join('');

      showSearchDropdown();
      addDropdownListeners();
    }

    function displayFullResults(results, query) {
      hideSearchDropdown();
      
      const container = document.getElementById('searchResultsContainer');
      const summary = document.getElementById('resultsSummary');
      
      if (results.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">لا توجد نتائج مطابقة</div>';
        summary.textContent = '';
        return;
      }

      summary.textContent = `تم العثور على ${results.length} نتيجة`;
      
      container.innerHTML = results.map(result => `
        <div class="section-card rounded-xl p-6 fade-in">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold text-amber-400">${result.surahName}</h3>
            <span class="text-sm text-slate-500">آية ${result.numberInSurah}</span>
          </div>
          <p class="font-quran-sm text-slate-200 mb-4 leading-relaxed">${highlight(result.text, query)}</p>
          <div class="flex space-x-3 rtl:space-x-reverse">
            <button class="play-ayah-btn bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg transition-colors" 
                    data-ayah="${result.ayahGlobalNumber}">
              <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
              </svg>
              استمع
            </button>
            <button class="view-surah-btn bg-sky-600 hover:bg-sky-500 text-white px-4 py-2 rounded-lg transition-colors" 
                    data-surah="${result.surahNumber}">
              عرض السورة
            </button>
          </div>
        </div>
      `).join('');

      addResultListeners();
    }

    function showSearchDropdown() {
      searchDropdown.classList.remove('hidden');
    }

    function hideSearchDropdown() {
      searchDropdown.classList.add('hidden');
    }

    function addDropdownListeners() {
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const ayahNum = item.dataset.ayah;
          const ayah = allAyahs.find(a => a.ayahGlobalNumber == ayahNum);
          if (ayah) {
            searchInput.value = ayah.text;
            performSearch(ayah.text, false);
          }
        });
      });
    }

    function addResultListeners() {
      document.querySelectorAll('.play-ayah-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const ayahNum = btn.dataset.ayah;
          playAyah(ayahNum, btn);
        });
      });

      document.querySelectorAll('.view-surah-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const surahNum = btn.dataset.surah;
          showSurahModal(surahNum);
        });
      });
    }

    // Audio Functions
    function playAyah(ayahNumber, buttonElement) {
      // الحصول على رمز القارئ الحالي
      const readerCode = currentReciter || 'ar.mahermuaiqly';
      
      // توليد عنوان الصوت باستخدام القالب الجديد
      const audioUrl = QURAN_READERS.url_template
        .replace('{code}', readerCode)
        .replace('{ayah_number}', ayahNumber);
      
      // تشغيل الصوت
      playAudioWithUrl(audioUrl, buttonElement, ayahNumber);
    }

    // دالة مساعدة لتشغيل الصوت باستخدام URL
    function playAudioWithUrl(audioUrl, buttonElement, ayahNumber) {
      // إيقاف الصوت الحالي إذا كان موجوداً
      if (currentPlayingAudio && currentPlayingAudio.player) {
        currentPlayingAudio.player.pause();
        resetPlayButton(currentPlayingAudio.buttonElement);
      }
      
      // إعداد الصوت الجديد
      audioPlayer.src = audioUrl;
      currentPlayingAudio = { 
        player: audioPlayer, 
        buttonElement: buttonElement,
        ayahNumber: ayahNumber 
      };
      
      setPlayButtonToLoading(buttonElement);
      
      // تحديد آية القرآن الحالية للمزامنة
      const currentAyah = allAyahs.find(a => a.ayahGlobalNumber == ayahNumber);
      if (currentAyah) {
        highlightCurrentAyah(currentAyah);
      }
      
      // تشغيل الصوت مع المحاولة ثلاث مرات
      let retryCount = 0;
      const maxRetries = 3;
      
      // قائمة بمصادر بديلة في حالة فشل التشغيل
      const alternativeUrls = [
        audioUrl,
        audioUrl.replace('128/', '64/'),
        QURAN_READERS.url_template.replace('{code}', 'ar.alafasy').replace('{ayah_number}', ayahNumber),
        `https://verse.mp3quran.net/arabic/mikhael_solomon/${ayahNumber}.mp3`
      ];
      
      function attemptPlayback(urlIndex = 0) {
        if (urlIndex >= alternativeUrls.length) {
          console.error('فشل في تشغيل الصوت بعد محاولة جميع المصادر البديلة');
          setPlayButtonToError(buttonElement);
          return;
        }
        
        audioPlayer.src = alternativeUrls[urlIndex];
        
      const playPromise = audioPlayer.play();
      
      if (playPromise !== undefined) {
        playPromise.then(() => {
            console.log(`✅ تم تشغيل الصوت من المصدر ${urlIndex + 1}`);
          setPlayButtonToPlaying(buttonElement);
        }).catch(error => {
            console.error(`محاولة تشغيل المصدر ${urlIndex + 1} فشلت:`, error);
            
            // المحاولة بالمصدر التالي
            attemptPlayback(urlIndex + 1);
        });
      }
    }

      // بدء المحاولة الأولى
      attemptPlayback();
      
      // إضافة مستمعات الأحداث
      audioPlayer.addEventListener('loadstart', () => {
        if (currentPlayingAudio && currentPlayingAudio.buttonElement) {
          setPlayButtonToLoading(currentPlayingAudio.buttonElement);
        }
      });

      audioPlayer.addEventListener('canplay', () => {
        if (currentPlayingAudio && currentPlayingAudio.buttonElement && !audioPlayer.paused) {
          setPlayButtonToPlaying(currentPlayingAudio.buttonElement);
        }
      });
      
      // مستمع حدث للتقدم في التشغيل (لتحديث تسليط الضوء على الآية)
      audioPlayer.addEventListener('timeupdate', () => {
        if (!currentAyah) return;
        
        // تحديث مؤشر التقدم إذا كان موجوداً
        const surahProgress = document.getElementById('surahProgress');
        if (surahProgress) {
          const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
          surahProgress.style.width = `${progress}%`;
        }
      });
      
      // عند انتهاء التشغيل
      audioPlayer.addEventListener('ended', () => {
        resetPlayButton(buttonElement);
        
        // إزالة تسليط الضوء عن الآية
        unhighlightCurrentAyah();
        
        // التشغيل التلقائي للآية التالية إذا كان مفعلاً
        const autoPlayToggle = document.getElementById('autoPlay');
        if (autoPlayToggle && autoPlayToggle.checked) {
          playNextAyah(ayahNumber);
        }
      });
    }
    
    // دالة لتسليط الضوء على الآية الحالية
    function highlightCurrentAyah(ayah) {
      // إزالة تسليط الضوء عن أي آية سابقة
      unhighlightCurrentAyah();
      
      // البحث عن عناصر الآية في الصفحة
      const ayahElements = document.querySelectorAll(`[data-ayah="${ayah.numberInSurah}"]`);
      
      ayahElements.forEach(element => {
        element.classList.add('bg-amber-500/20', 'rounded-lg', 'border-r-4', 'border-amber-500');
      });
      
      // البحث عن عنصر الآية داخل نافذة تفاصيل السورة
      const surahContent = document.getElementById('surahContent');
      if (surahContent) {
        const ayahInModal = surahContent.querySelector(`[data-ayah-number="${ayah.numberInSurah}"]`);
        if (ayahInModal) {
          ayahInModal.classList.add('bg-amber-500/20', 'rounded-lg', 'border-r-4', 'border-amber-500');
          
          // تمرير إلى الآية الحالية
          ayahInModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    
    // دالة لإزالة تسليط الضوء عن الآية الحالية
    function unhighlightCurrentAyah() {
      const highlightedElements = document.querySelectorAll('.bg-amber-500\\/20');
      highlightedElements.forEach(element => {
        element.classList.remove('bg-amber-500/20', 'rounded-lg', 'border-r-4', 'border-amber-500');
      });
    }
    
    // دالة لتشغيل الآية التالية
    function playNextAyah(currentAyahNumber) {
      const nextAyahNumber = parseInt(currentAyahNumber) + 1;
      
      // التحقق مما إذا كانت الآية التالية متاحة
      const nextAyah = allAyahs.find(a => a.ayahGlobalNumber == nextAyahNumber);
      
      if (nextAyah) {
        // البحث عن زر التشغيل للآية التالية
        let nextButton = document.querySelector(`[data-ayah="${nextAyahNumber}"]`);
        
        if (!nextButton) {
          // إذا لم يوجد زر، نقوم بإنشاء زر وهمي
          nextButton = document.createElement('button');
          nextButton.setAttribute('data-ayah', nextAyahNumber);
          nextButton.style.display = 'none';
          document.body.appendChild(nextButton);
        }
        
        // تشغيل الآية التالية بعد تأخير قصير
        setTimeout(() => {
          playAyah(nextAyahNumber, nextButton);
        }, 1000);
      }
    }
    
    // إنشاء قائمة القراء المضمنة
    function createInlineReciterSelector(buttonElement, ayahNumber) {
      // إنشاء عنصر القائمة المنسدلة
      const selectorContainer = document.createElement('div');
      selectorContainer.className = 'reciter-selector-inline fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-800/95 p-6 rounded-xl border border-amber-500/30 z-50 backdrop-blur-md shadow-2xl fade-in';
      selectorContainer.style.minWidth = '300px';
      
      // إضافة العنوان
      const title = document.createElement('h3');
      title.className = 'text-xl font-semibold text-amber-400 mb-4 text-center';
      title.textContent = 'اختر القارئ';
      selectorContainer.appendChild(title);
      
      // إنشاء قائمة القراء
      const select = document.createElement('select');
      select.className = 'w-full rounded-lg p-3 bg-slate-700 text-slate-100 mb-4';
      
      // إضافة القراء من قائمة QURAN_READERS
      QURAN_READERS.readers.forEach(reader => {
        const option = document.createElement('option');
        option.value = reader.code;
        option.textContent = reader.name;
        
        // تحديد القارئ الحالي
        if (reader.code === currentReciter) {
          option.selected = true;
        }
        
        select.appendChild(option);
      });
      
      selectorContainer.appendChild(select);
      
      // إضافة أزرار التأكيد والإلغاء
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'flex justify-between mt-2';
      
      const confirmButton = document.createElement('button');
      confirmButton.className = 'bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg';
      confirmButton.textContent = 'استماع';
      confirmButton.onclick = () => {
        // تحديث القارئ الحالي
        currentReciter = select.value;
        
        // حفظ الاختيار في الإعدادات
        saveUserSettings();
        
        // إزالة القائمة المنسدلة
        document.body.removeChild(selectorContainer);
        
        // تشغيل الصوت
        playAyah(ayahNumber, buttonElement);
      };
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'bg-slate-700 hover:bg-slate-600 text-slate-300 px-4 py-2 rounded-lg';
      cancelButton.textContent = 'إلغاء';
      cancelButton.onclick = () => {
        // إزالة القائمة المنسدلة
        document.body.removeChild(selectorContainer);
      };
      
      buttonsContainer.appendChild(cancelButton);
      buttonsContainer.appendChild(confirmButton);
      
      selectorContainer.appendChild(buttonsContainer);
      
      // إضافة القائمة إلى الصفحة
      document.body.appendChild(selectorContainer);
      
      // إضافة خيار حفظ الاختيار
      const saveOption = document.createElement('div');
      saveOption.className = 'mt-4 text-center';
      saveOption.innerHTML = `
        <label class="flex items-center justify-center space-x-2 rtl:space-x-reverse">
          <input type="checkbox" id="saveReciterChoice" checked class="rounded border-slate-600 bg-slate-700 text-amber-500">
          <span class="text-sm text-slate-400">حفظ هذا الاختيار</span>
        </label>
      `;
      selectorContainer.appendChild(saveOption);
    }

    // تطبيق إعدادات الصوت
    function applyAudioSettings() {
      // التحكم في مستوى الصوت
      const volumeSlider = document.getElementById('volumeSlider');
      if (volumeSlider) {
        audioPlayer.volume = volumeSlider.value / 100;
        
        volumeSlider.addEventListener('input', () => {
          audioPlayer.volume = volumeSlider.value / 100;
        });
      }
      
      // التشغيل التلقائي
      const autoPlayToggle = document.getElementById('autoPlay');
      if (autoPlayToggle) {
        audioPlayer.addEventListener('ended', () => {
          if (autoPlayToggle.checked && currentPlayingAudio) {
            // تشغيل الآية التالية
            const currentAyahNumber = parseInt(currentPlayingAudio.ayahNumber);
            const nextAyahNumber = currentAyahNumber + 1;
            
            // البحث عن زر الآية التالية في الصفحة
            const nextButton = document.querySelector(`[data-ayah="${nextAyahNumber}"]`);
            if (nextButton) {
              setTimeout(() => {
                playAyah(nextAyahNumber, nextButton);
              }, 1000);
            }
          }
        });
      }
    }
    
    // تطبيق إعدادات حجم الخط
    function applyFontSizeSettings() {
      const fontSizeSelector = document.getElementById('fontSizeSelector');
      if (fontSizeSelector) {
        const applyFontSize = (size) => {
          const quranFont = document.querySelectorAll('.font-quran');
          const quranFontSm = document.querySelectorAll('.font-quran-sm');
          
          switch(size) {
            case 'small':
              quranFont.forEach(el => el.style.fontSize = 'clamp(1.5rem, 4vw, 1.9rem)');
              quranFontSm.forEach(el => el.style.fontSize = 'clamp(1.1rem, 3.5vw, 1.4rem)');
              break;
            case 'medium':
              quranFont.forEach(el => el.style.fontSize = 'clamp(1.7rem, 4.5vw, 2.1rem)');
              quranFontSm.forEach(el => el.style.fontSize = 'clamp(1.3rem, 4vw, 1.6rem)');
              break;
            case 'large':
              quranFont.forEach(el => el.style.fontSize = 'clamp(1.9rem, 5vw, 2.3rem)');
              quranFontSm.forEach(el => el.style.fontSize = 'clamp(1.5rem, 4.5vw, 1.8rem)');
              break;
            case 'xlarge':
              quranFont.forEach(el => el.style.fontSize = 'clamp(2.1rem, 5.5vw, 2.5rem)');
              quranFontSm.forEach(el => el.style.fontSize = 'clamp(1.7rem, 5vw, 2rem)');
              break;
          }
        };
        
        // تطبيق الحجم الافتراضي
        applyFontSize(fontSizeSelector.value);
        
        // إضافة معالج الحدث للتغيير
        fontSizeSelector.addEventListener('change', (e) => {
          applyFontSize(e.target.value);
        });
      }
    }

    // دالة التهيئة الرئيسية للتطبيق
    async function init() {
      // تصحيح مشاكل CSS
      fixCSSIssues();
      
      // إعداد IndexedDB
      await initIndexedDB();
      
      // تحميل إعدادات المستخدم
      await loadUserSettings();
      
      // تحميل البيانات
      await loadApiKeys();
      await loadQuranData();
      await loadReciters();
      
      // تهيئة محرك البحث المتقدم
      try {
        console.log('🔍 تهيئة محرك البحث المتقدم...');
        window.quranSearchEngine = new QuranSearchEngine();
        const initResult = await window.quranSearchEngine.initialize(allSurahs);
        if (initResult) {
          console.log('✅ تم تهيئة محرك البحث المتقدم بنجاح');
        }
      } catch (error) {
        console.error('❌ خطأ في تهيئة محرك البحث المتقدم:', error);
      }
      
      // تهيئة المكونات
      initNavigation();
      initEventListeners();
      initVoiceSearch();
      
      // إضافة مستمع الحدث لزر اختيار القارئ العائم
      document.getElementById('floating-reciter-button')?.addEventListener('click', showReciterModal);
      
      // إضافة مستمع لحفظ الإعدادات عند إغلاق الصفحة
      window.addEventListener('beforeunload', (event) => {
        // استخدام localStorage مباشرة لأن الوعود غير المتزامنة لا تعمل مع beforeunload
        const settings = {
          darkMode: document.getElementById('darkMode')?.checked ?? true,
          fontSize: document.getElementById('fontSizeSelector')?.value ?? 'medium',
          volume: document.getElementById('volumeSlider')?.value ?? 80,
          autoPlay: document.getElementById('autoPlay')?.checked ?? false,
          reciter: currentReciter || 'ar.mahermuaiqly'
        };
        
        try {
          localStorage.setItem('quran-app-settings', JSON.stringify(settings));
        } catch (error) {
          console.error('❌ خطأ في حفظ الإعدادات قبل إغلاق الصفحة:', error);
        }
      });
      
      // تسجيل Service Worker للعمل بدون اتصال
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('✅ تم تسجيل Service Worker بنجاح، النطاق:', registration.scope);
        } catch (error) {
          console.error('❌ فشل تسجيل Service Worker:', error);
        }
      }
      
      console.log('تطبيق القرآن الكريم محمل بنجاح');
    }
    
    // تصحيح مشاكل CSS باستخدام JavaScript
    function fixCSSIssues() {
      // إضافة webkit-backdrop-filter للدعم في Safari
      const backdropFilterElements = document.querySelectorAll('.section-card, .floating-nav, .modal, .search-dropdown');
      backdropFilterElements.forEach(element => {
        const style = window.getComputedStyle(element);
        const backdropFilter = style.getPropertyValue('backdrop-filter');
        
        if (backdropFilter && !style.getPropertyValue('-webkit-backdrop-filter')) {
          element.style.webkitBackdropFilter = backdropFilter;
        }
      });
      
      // إضافة عناوين للأزرار التي تحتوي على أيقونات فقط
      const accessibilityIssues = [
        { selector: '#closeathkar', title: 'إغلاق' },
        { selector: '#closeSurahModal', title: 'إغلاق' },
        { selector: '#reciter-selector', title: 'اختيار القارئ' },
        { selector: '#volumeSlider', title: 'مستوى الصوت' },
        { selector: '#fontSizeSelector', title: 'حجم الخط' }
      ];
      
      accessibilityIssues.forEach(issue => {
        const element = document.querySelector(issue.selector);
        if (element && !element.getAttribute('title')) {
          element.setAttribute('title', issue.title);
        }
      });
    }
    
    // تهيئة التنقل
    function initNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      const sections = document.querySelectorAll('.section');
      
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const targetSection = item.getAttribute('data-section');
          
          // تحديث حالة العناصر النشطة
          navItems.forEach(navItem => navItem.classList.remove('active'));
          item.classList.add('active');
          
          // إخفاء جميع الأقسام وإظهار القسم المستهدف
          sections.forEach(section => {
            if (section.id === `${targetSection}-section`) {
              section.classList.remove('hidden');
              section.classList.add('active');
            } else {
              section.classList.add('hidden');
              section.classList.remove('active');
            }
          });
          
          // تحميل البيانات الخاصة بكل قسم عند الانتقال إليه
          if (targetSection === 'browse' && !document.querySelector('#surahsGrid .surah-card')) {
            loadSurahs();
          } 
          if (targetSection === 'prayer' && document.getElementById('prayerTimesContent').querySelector('.loader')) {
            loadPrayerTimes();
          }
          if (targetSection === 'athkar') { // تأكد أن 'athkar' هو data-section لزر الأذكار
            // استدعاء دالة تفعيل قسم الأذكار من athkar-main.js
            if (typeof window.activateathkarSection === 'function') {
                window.activateathkarSection();
            } else {
                console.warn("window.activateathkarSection is not defined. Ensure athkar-main.js is loaded correctly.");
            }
        } else {
            // إذا انتقلت إلى قسم آخر، أوقف صوت الأذكار إذا كان يعمل
            // هذا الجزء من الكود يعتمد على متغير activeZikrAudioPlayer المعرف في athkar-main.js
            // يجب التأكد من أن activeZikrAudioPlayer متاح عالميًا أو التعامل معه بطريقة أخرى
            if (typeof activeZikrAudioPlayer !== 'undefined' && activeZikrAudioPlayer && !activeZikrAudioPlayer.paused) {
                activeZikrAudioPlayer.pause();
                document.querySelectorAll('.play-zikr-audio-btn.playing').forEach(activeBtn => {
                     activeBtn.classList.remove('playing');
                     activeBtn.querySelector('.icon-play').classList.remove('hidden');
                     activeBtn.querySelector('.icon-pause').classList.add('hidden');
                     activeBtn.querySelector('.icon-loading').classList.add('hidden');
                     activeBtn.querySelector('.btn-text').textContent = "استماع";
                });
            }
        }
        });
      });
    }
    
    // تهيئة مستمعات الأحداث
    function initEventListeners() {
      // مستمعات أحداث البحث
      // استخدام المتغير العام
      // const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      
      if (searchInput) {
        // بحث فوري عند الكتابة (مع تأخير)
        searchInput.addEventListener('input', debounce((e) => {
          const query = e.target.value.trim();
          if (query.length > 2) {
            performSearch(query, true);
          } else {
            hideSearchDropdown();
          }
        }, 150)); // تأخير 150 مللي ثانية فقط للاستجابة السريعة جداً
    
        // بحث عند الضغط على Enter
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const query = e.target.value.trim();
            if (query) {
              performSearch(query, false);
            }
          }
        });
      }
      
      // زر البحث
      if (searchBtn) {
        searchBtn.addEventListener('click', () => {
          const query = searchInput.value.trim();
          if (query) {
            performSearch(query, false);
          }
        });
      }
      
      // إغلاق القائمة المنسدلة عند النقر خارجها
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#searchInput') && 
            !e.target.closest('#searchDropdown') && 
            !e.target.closest('#searchBtn')) {
          hideSearchDropdown();
        }
      });
      
      // إغلاق القائمة المنسدلة عند الضغط على Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideSearchDropdown();
        }
      });
      
      // أزرار إغلاق النوافذ
      const closeathkar = document.getElementById('closeathkar');
      const closeSurahModal = document.getElementById('closeSurahModal');
      const closeAiCard = document.getElementById('closeAiCard');
      
      if (closeathkar) {
        closeathkar.addEventListener('click', () => {
          document.getElementById('athkarContent').classList.add('hidden');
        });
      }
      
      if (closeSurahModal) {
        closeSurahModal.addEventListener('click', () => {
          document.getElementById('surahModal').classList.add('hidden');
          document.getElementById('surahModal').classList.add('opacity-0');
        });
      }
      
      if (closeAiCard) {
        closeAiCard.addEventListener('click', () => {
          document.getElementById('aiResponseCard').classList.add('hidden');
        });
      }
      
      // مستمعات أحداث الأذكار
      const athkarItems = document.querySelectorAll('[data-athkar-type]');
      athkarItems.forEach(item => {
        item.addEventListener('click', () => {
          const type = item.getAttribute('data-athkar-type');
          if (type) {
            loadathkar(type);
          }
        });
      });
      
      // مستمعات أحداث الإعدادات
      const reciterSelector = document.getElementById('reciter-selector');
      const volumeSlider = document.getElementById('volumeSlider');
      const autoPlayToggle = document.getElementById('autoPlay');
      const fontSizeSelector = document.getElementById('fontSizeSelector');
      const darkModeToggle = document.getElementById('darkMode');
      
      if (reciterSelector) {
        reciterSelector.addEventListener('change', async (e) => {
          currentReciter = e.target.value;
          console.log(`تم تغيير القارئ إلى: ${e.target.options[e.target.selectedIndex].text}`);
          await saveUserSettings();
        });
      }
      
      if (volumeSlider) {
        volumeSlider.addEventListener('input', async () => {
          audioPlayer.volume = volumeSlider.value / 100;
          await saveUserSettings();
        });
      }
      
      if (autoPlayToggle) {
        autoPlayToggle.addEventListener('change', async () => {
          await saveUserSettings();
        });
      }
      
      if (fontSizeSelector) {
        fontSizeSelector.addEventListener('change', async (e) => {
          applyFontSize(e.target.value);
          await saveUserSettings();
        });
      }
      
      if (darkModeToggle) {
        darkModeToggle.addEventListener('change', async (e) => {
          setTheme(e.target.checked);
          await saveUserSettings();
        });
      }
    }
    
    // تهيئة البحث الصوتي
    function initVoiceSearch() {
      const voiceSearchBtn = document.getElementById('voiceSearchBtn');
      
      if (!voiceSearchBtn) return;
      
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        recognition.lang = 'ar';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = () => {
          voiceSearchBtn.classList.add('voice-recording');
          voiceSearchBtn.innerHTML = `
            <svg class="w-6 h-6 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
            </svg>
          `;
        };
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          searchInput.value = transcript;
          performSearch(transcript, false);
        };
        
        recognition.onend = () => {
          voiceSearchBtn.classList.remove('voice-recording');
          voiceSearchBtn.innerHTML = `
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          `;
        };
        
        recognition.onerror = (event) => {
          console.error('Voice recognition error:', event.error);
          voiceSearchBtn.classList.remove('voice-recording');
          voiceSearchBtn.innerHTML = `
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          `;
        };
        
        voiceSearchBtn.addEventListener('click', () => {
          try {
            recognition.start();
          } catch (error) {
            console.error('Failed to start voice recognition:', error);
          }
        });
      } else {
        // إخفاء زر البحث الصوتي إذا لم يكن مدعومًا
        voiceSearchBtn.style.display = 'none';
      }
    }
    
    // تطبيق إعدادات الصوت
    function applyAudioSettings() {
      // التحكم في مستوى الصوت
      const volumeSlider = document.getElementById('volumeSlider');
      if (volumeSlider) {
        audioPlayer.volume = volumeSlider.value / 100;
        
        volumeSlider.addEventListener('input', () => {
          audioPlayer.volume = volumeSlider.value / 100;
        });
      }
      
      // التشغيل التلقائي
      const autoPlayToggle = document.getElementById('autoPlay');
      if (autoPlayToggle) {
        audioPlayer.addEventListener('ended', () => {
          if (autoPlayToggle.checked && currentPlayingAudio) {
            // تشغيل الآية التالية
            const currentAyahNumber = parseInt(currentPlayingAudio.ayahNumber);
            const nextAyahNumber = currentAyahNumber + 1;
            
            // البحث عن زر الآية التالية في الصفحة
            const nextButton = document.querySelector(`[data-ayah="${nextAyahNumber}"]`);
            if (nextButton) {
              setTimeout(() => {
                playAyah(nextAyahNumber, nextButton);
              }, 1000);
            }
          }
        });
      }
    }
    // تطبيق إعدادات حجم الخط
function applyFontSizeSettings() {
  const fontSizeSelector = document.getElementById('fontSizeSelector');
  if (fontSizeSelector) {
    applyFontSize(fontSizeSelector.value);
  }
}

// تطبيق حجم الخط المحدد
function applyFontSize(size) {
  const quranFont = document.querySelectorAll('.font-quran');
  const quranFontSm = document.querySelectorAll('.font-quran-sm');

  // ملاحظة: لتحسين أكبر، يمكن استخدام متغيرات CSS (CSS Custom Properties)
  // لتغيير حجم الخط. مثال:
  // document.documentElement.style.setProperty('--font-quran-base-size', '1.7rem');
  // وفي CSS: .font-quran { font-size: clamp(var(--font-quran-base-size), ...); }
  // هذا يجعل الكود هنا أبسط، لكن يتطلب تعديل CSS.

  let quranBaseSize, quranSmBaseSize;

  switch(size) {
    case 'small':
      quranBaseSize = { min: '1.5rem', preferred: '4vw', max: '1.9rem' };
      quranSmBaseSize = { min: '1.1rem', preferred: '3.5vw', max: '1.4rem' };
      break;
    case 'medium':
      quranBaseSize = { min: '1.7rem', preferred: '4.5vw', max: '2.1rem' };
      quranSmBaseSize = { min: '1.3rem', preferred: '4vw', max: '1.6rem' };
      break;
    case 'large':
      quranBaseSize = { min: '1.9rem', preferred: '5vw', max: '2.3rem' };
      quranSmBaseSize = { min: '1.5rem', preferred: '4.5vw', max: '1.8rem' };
      break;
    case 'xlarge':
      quranBaseSize = { min: '2.1rem', preferred: '5.5vw', max: '2.5rem' };
      quranSmBaseSize = { min: '1.7rem', preferred: '5vw', max: '2rem' };
      break;
    default: // كحالة افتراضية أو إذا كانت القيمة غير متوقعة
      quranBaseSize = { min: '1.7rem', preferred: '4.5vw', max: '2.1rem' }; // Medium
      quranSmBaseSize = { min: '1.3rem', preferred: '4vw', max: '1.6rem' }; // Medium
  }

  quranFont.forEach(el => el.style.fontSize = `clamp(${quranBaseSize.min}, ${quranBaseSize.preferred}, ${quranBaseSize.max})`);
  quranFontSm.forEach(el => el.style.fontSize = `clamp(${quranSmBaseSize.min}, ${quranSmBaseSize.preferred}, ${quranSmBaseSize.max})`);
}

// تطبيق السمة (داكنة أو فاتحة) - نسخة محسنة
function setTheme(isDark = true) {
  const body = document.body;
  const root = document.documentElement; // للوصول إلى :root إذا استخدمت متغيرات CSS

  if (isDark) {
    body.classList.add('dark-theme');
    body.classList.remove('light-theme');
    // يمكنك أيضًا تعيين متغيرات CSS هنا إذا كنت تستخدمها بشكل مكثف
    // root.style.setProperty('--primary-bg-color', '#0f172a');
    // root.style.setProperty('--primary-text-color', '#cbd5e1');
    // body.style.background و body.style.color يمكن أن تبقى هنا أو تنتقل بالكامل لـ CSS
    body.style.background = 'linear-gradient(to bottom right, #0f172a, #1e293b, #0f172a)';
    body.style.color = '#cbd5e1';
  } else {
    body.classList.add('light-theme');
    body.classList.remove('dark-theme');
    // root.style.setProperty('--primary-bg-color', '#f8fafc');
    // root.style.setProperty('--primary-text-color', '#334155');
    body.style.background = 'linear-gradient(to bottom right, #f8fafc, #e2e8f0, #f8fafc)';
    body.style.color = '#334155';

    // لا حاجة لتحديث الألوان للعناصر الأخرى هنا عبر JavaScript.
    // يجب أن يتم ذلك عبر CSS. مثال في CSS:
    // body.light-theme .section-card {
    //   background-color: rgba(255, 255, 255, 0.6);
    //   border-color: rgba(203, 213, 225, 0.5);
    // }
    // body.light-theme .text-slate-400 { color: #64748b; }
    // وهكذا لباقي العناصر التي تحتاج تغييرات في الوضع الفاتح.
  }

  // حفظ الإعداد في التخزين المحلي
  localStorage.setItem('quran-app-dark-mode', isDark ? 'true' : 'false');
}

// حفظ إعدادات المستخدم
async function saveUserSettings() {
  // التحقق من وجود العناصر قبل محاولة الوصول إلى خصائصها
  const darkModeElement = document.getElementById('darkMode');
  const fontSizeSelectorElement = document.getElementById('fontSizeSelector');
  const volumeSliderElement = document.getElementById('volumeSlider');
  const autoPlayElement = document.getElementById('autoPlay');

  const settings = {
    // استخدم قيمة افتراضية إذا لم يتم العثور على العنصر أو كانت currentReciter غير معرفة
    darkMode: darkModeElement ? darkModeElement.checked : true,
    fontSize: fontSizeSelectorElement ? fontSizeSelectorElement.value : 'medium',
    volume: volumeSliderElement ? volumeSliderElement.value : 80, // افترض أن 80 هو قيمة عددية
    autoPlay: autoPlayElement ? autoPlayElement.checked : false,
    reciter: typeof currentReciter !== 'undefined' ? currentReciter : 'ar.alafasy'
  };

  try {
    // تأكد أن دالة saveToIndexedDB معرفة ومتاحة
    if (typeof saveToIndexedDB === 'function') {
      await saveToIndexedDB('settings', settings);
      console.log('✅ تم حفظ إعدادات المستخدم في IndexedDB');
    } else {
      console.warn('⚠️ دالة saveToIndexedDB غير معرفة، سيتم استخدام localStorage فقط.');
      throw new Error('IndexedDB save function not available.'); // للانتقال إلى catch
    }
  } catch (error) {
    console.error('❌ خطأ في حفظ إعدادات المستخدم في IndexedDB أو الدالة غير متاحة:', error);
    try {
      localStorage.setItem('quran-app-settings', JSON.stringify(settings));
      console.log('✅ تم حفظ إعدادات المستخدم في localStorage كاحتياطي');
    } catch (localStorageError) {
      console.error('❌ خطأ في حفظ إعدادات المستخدم في localStorage:', localStorageError);
    }
  }

  return settings;
}

    // استعادة إعدادات المستخدم
    async function loadUserSettings() {
      let settings;
      
      try {
        // محاولة استرجاع الإعدادات من IndexedDB
        const savedSettings = await getFromIndexedDB('settings');
        
        if (savedSettings && savedSettings.data) {
          settings = savedSettings.data;
        } else {
          // محاولة استرجاع الإعدادات من localStorage (للتوافق مع الإصدارات السابقة)
          const localSettings = localStorage.getItem('quran-app-settings');
          
          if (localSettings) {
            settings = JSON.parse(localSettings);
            // نقل الإعدادات من localStorage إلى IndexedDB
            try {
              await saveToIndexedDB('settings', settings);
              console.log('✅ تم نقل إعدادات المستخدم من localStorage إلى IndexedDB');
            } catch (transferError) {
              console.warn('⚠️ لم يتم نقل الإعدادات إلى IndexedDB:', transferError);
            }
          } else {
            // الإعدادات الافتراضية
            settings = {
              darkMode: true,
              fontSize: 'medium',
              volume: 80,
              autoPlay: false,
              reciter: 'ar.alafasy'
            };
          }
        }
      } catch (error) {
        console.error('❌ خطأ في تحميل إعدادات المستخدم:', error);
        
        // الإعدادات الافتراضية في حالة الخطأ
        settings = {
          darkMode: true,
          fontSize: 'medium',
          volume: 80,
          autoPlay: false,
          reciter: 'ar.alafasy'
        };
      }
      
      // تطبيق الإعدادات
      const darkModeToggle = document.getElementById('darkMode');
      const fontSizeSelector = document.getElementById('fontSizeSelector');
      const volumeSlider = document.getElementById('volumeSlider');
      const autoPlayToggle = document.getElementById('autoPlay');
      
      if (darkModeToggle) darkModeToggle.checked = settings.darkMode;
      if (fontSizeSelector) fontSizeSelector.value = settings.fontSize;
      if (volumeSlider) volumeSlider.value = settings.volume;
      if (autoPlayToggle) autoPlayToggle.checked = settings.autoPlay;
      
      // تطبيق السمة
      setTheme(settings.darkMode);
      
      // تطبيق حجم الخط
      if (fontSizeSelector) {
        applyFontSize(settings.fontSize);
      }
      
      // تطبيق مستوى الصوت
      if (volumeSlider && audioPlayer) {
        audioPlayer.volume = settings.volume / 100;
      }
      
      // تعيين القارئ الحالي
      currentReciter = settings.reciter || 'ar.mahermuaiqly';
      
      // تحديث قائمة القراء إذا كانت متاحة
      const reciterSelector = document.getElementById('reciter-selector');
      if (reciterSelector) {
        // سيتم تحديث البطاقات عند استدعاء updateReciterSelector
        updateReciterSelector();
      }
      
      return settings;
    }
    
    // تحديث شكل زر التشغيل للإشارة إلى التحميل
    function setPlayButtonToLoading(button) {
      if (!button) return;
      
      button.innerHTML = `
        <div class="w-4 h-4 border-2 border-white border-b-transparent rounded-full animate-spin mr-2"></div>
        جار التحميل
      `;
      button.disabled = true;
    }

    // تحديث شكل زر التشغيل للإشارة إلى التشغيل
    function setPlayButtonToPlaying(button) {
      if (!button) return;
      
      button.innerHTML = `
        <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v14a1 1 0 002 0V3a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          <path fill-rule="evenodd" d="M13 2a1 1 0 00-1 1v14a1 1 0 002 0V3a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        إيقاف
      `;
      button.disabled = false;
      
      // تغيير وظيفة الزر ليقوم بإيقاف الصوت
      const originalClick = button.onclick;
      button.onclick = () => {
        if (audioPlayer && !audioPlayer.paused) {
          audioPlayer.pause();
        }
        resetPlayButton(button);
        // استعادة وظيفة الزر الأصلية
        setTimeout(() => {
          button.onclick = originalClick;
        }, 100);
      };
    }
    
    // إعادة زر التشغيل إلى حالته الأصلية
    function resetPlayButton(button) {
      if (!button) return;
      
        button.innerHTML = `
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
          </svg>
          استمع
        `;
        button.disabled = false;
    }

    // تحديث شكل زر التشغيل للإشارة إلى الخطأ
    function setPlayButtonToError(button) {
      if (!button) return;
      
      button.innerHTML = `
        <svg class="w-4 h-4 inline mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        خطأ
      `;
      button.disabled = false;
    }
    
    // تحميل قائمة القراء
    async function loadReciters() {
      try {
        console.log('✅ استخدام قائمة القراء المعرفة مسبقاً');
        
        // استخدام قائمة القراء المعرفة مسبقاً
        availableReciters = QURAN_READERS.readers.map(reader => ({
          id: reader.code,
          name: reader.name,
          style: ''
        }));
        
        // تحديث قائمة اختيار القارئ
        updateReciterSelector();
        
        return availableReciters;
      } catch (error) {
        console.error('❌ خطأ في تحميل قائمة القراء:', error);
        
        // استخدام قائمة احتياطية للقراء المشهورين
        availableReciters = [
          { id: 'ar.alafasy', name: 'مشاري العفاسي', style: 'مرتل' },
          { id: 'ar.mahermuaiqly', name: 'ماهر المعيقلي', style: 'مرتل' },
          { id: 'ar.hudhaify', name: 'علي الحذيفي', style: 'مرتل' },
          { id: 'ar.minshawi', name: 'محمد صديق المنشاوي', style: 'مرتل' },
          { id: 'ar.husary', name: 'محمود خليل الحصري', style: 'مرتل' }
        ];
        
        updateReciterSelector();
        return availableReciters;
      }
    }
    
    // تحديث قائمة اختيار القارئ في الواجهة
    function updateReciterSelector() {
      const reciterSelector = document.getElementById('reciter-selector');
      
      if (!reciterSelector) {
        return;
      }
      
      // تفريغ القائمة
      reciterSelector.innerHTML = '';
      
      // إنشاء عنوان للقسم
      const title = document.createElement('h3');
      title.className = 'text-xl font-semibold text-amber-400 mb-4';
      title.textContent = 'اختيار القارئ';
      reciterSelector.appendChild(title);
      
      // إنشاء حاوية للبطاقات
      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto custom-scrollbar p-2';
      
      // إضافة القراء من قائمة QURAN_READERS
      QURAN_READERS.readers.forEach(reader => {
        const card = document.createElement('div');
        card.className = `p-3 rounded-lg cursor-pointer transition-all duration-200 text-center ${reader.code === currentReciter ? 'bg-amber-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-200'}`;
        card.dataset.code = reader.code;
        card.innerHTML = `
          <div class="text-sm font-semibold">${reader.name}</div>
        `;
        
        // إضافة حدث النقر لاختيار القارئ
        card.addEventListener('click', () => {
          // إزالة التحديد من جميع البطاقات
          cardsContainer.querySelectorAll('div[data-code]').forEach(item => {
            item.className = 'p-3 rounded-lg cursor-pointer transition-all duration-200 text-center bg-slate-700 hover:bg-slate-600 text-slate-200';
          });
          
          // تحديد البطاقة المختارة
          card.className = 'p-3 rounded-lg cursor-pointer transition-all duration-200 text-center bg-amber-600 text-white';
          
          // تحديث القارئ الحالي
          currentReciter = reader.code;
          
          // حفظ الإعدادات
          saveUserSettings();
          
          // إظهار رسالة تأكيد
          const confirmMessage = document.createElement('div');
          confirmMessage.className = 'mt-3 text-center text-emerald-400 text-sm fade-in';
          confirmMessage.textContent = `تم اختيار ${reader.name} كقارئ افتراضي`;
          reciterSelector.appendChild(confirmMessage);
          
          // إخفاء رسالة التأكيد بعد 3 ثوان
          setTimeout(() => {
            confirmMessage.classList.add('fade-out');
            setTimeout(() => {
              confirmMessage.remove();
            }, 500);
          }, 3000);
        });
        
        cardsContainer.appendChild(card);
      });
      
      reciterSelector.appendChild(cardsContainer);
      
      // إضافة نص توضيحي
      const helpText = document.createElement('p');
      helpText.className = 'text-slate-400 text-sm mt-3 text-center';
      helpText.textContent = 'انقر على بطاقة القارئ لاختياره كقارئ افتراضي';
      reciterSelector.appendChild(helpText);
    }
    

// -----------------------------------------------------------------------------
// 1. دالة لتنسيق الوقت من 24 ساعة إلى 12 ساعة مع صباحًا/مساءً
// -----------------------------------------------------------------
function formatTime12Hour(time24) {
  if (!time24 || typeof time24 !== 'string') return '';
  const timeParts = time24.split(':');
  if (timeParts.length < 2) return time24; // إرجاع الوقت كما هو إذا لم يكن بالتنسيق المتوقع

  const hours = parseInt(timeParts[0], 10);
  const minutes = parseInt(timeParts[1], 10);

  if (isNaN(hours) || isNaN(minutes)) return time24; // إرجاع الوقت كما هو إذا لم تكن الأرقام صالحة

  const ampm = hours >= 12 ? 'مساءً' : 'صباحًا';
  const hours12 = hours % 12 || 12; // تحويل الساعة 0 (منتصف الليل) و 12 (الظهر) إلى 12

  const paddedMinutes = minutes < 10 ? `0${minutes}` : minutes;

  return `${hours12}:${paddedMinutes} ${ampm}`;
}

// -----------------------------------------------------------------------------
// 2. دالة عرض مواقيت الصلاة في الواجهة
// -----------------------------------------------------------------------------
function displayPrayerTimes(data, cityName = "موقعك الحالي") {
  const prayerTimesContent = document.getElementById('prayerTimesContent');

  if (!prayerTimesContent) {
    console.error("Error: prayerTimesContent element not found.");
    return;
  }
  if (!data || !data.timings) {
    showPrayerTimesError('بيانات مواقيت الصلاة غير كاملة أو غير متوفرة.');
    return;
  }

  const timings = data.timings;
  const gregorianDate = data.date.gregorian;
  const hijriDate = data.date.hijri;

  prayerTimesContent.innerHTML = `
    <div class="text-center mb-6">
      <h3 class="text-3xl font-bold text-amber-400 mb-2">
        ${cityName}
      </h3>
      <p class="text-lg text-slate-300 mb-1">مواقيت الصلاة لليوم</p>
      <div class="text-md text-amber-300 mt-1">${hijriDate.weekday.ar}، ${hijriDate.day} ${hijriDate.month.ar} ${hijriDate.year}هـ</div>
      <div class="text-sm text-slate-400">${gregorianDate.weekday.en}، ${gregorianDate.day} ${gregorianDate.month.en} ${gregorianDate.year}م</div>
    </div>
    <div class="space-y-3">
      ${Object.entries(timings).map(([prayer, time]) => {
        const prayerNamesAr = {
          Fajr: "الفجر", Sunrise: "الشروق", Dhuhr: "الظهر", Asr: "العصر",
          Sunset: "الغروب", Maghrib: "المغرب", Isha: "العشاء", Imsak: "الإمساك",
          Midnight: "منتصف الليل", Firstthird: "الثلث الأول", Lastthird: "الثلث الأخير"
        };
        const displayPrayers = ["Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
        if (displayPrayers.includes(prayer)) {
          const formattedTime = formatTime12Hour(String(time).split(' ')[0]);
          return `
            <div class="flex justify-between items-center p-4 bg-slate-700/60 rounded-xl shadow-lg hover:bg-slate-700/80 transition-colors duration-200">
              <span class="text-xl text-slate-100 font-medium">${prayerNamesAr[prayer] || prayer}</span>
              <span class="text-2xl text-amber-400 font-bold tracking-wider">${formattedTime}</span>
            </div>
          `;
        }
        return '';
      }).join('')}
    </div>
    <p class="text-xs text-center text-slate-500 mt-8">
      مواقيت الصلاة حسب تقويم أم القرى.
    </p>
  `;
}

// -----------------------------------------------------------------------------
// 3. دالة عرض رسالة خطأ في قسم مواقيت الصلاة
// -----------------------------------------------------------------------------
function showPrayerTimesError(message) {
  const prayerTimesContent = document.getElementById('prayerTimesContent');

  if (prayerTimesContent) {
    prayerTimesContent.innerHTML = `
      <div class="text-center text-red-400 p-6">
        <svg class="w-12 h-12 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v5.586L7.293 9.293a1 1 0 00-1.414 1.414L8.586 12l-2.707 2.707a1 1 0 001.414 1.414L10 13.414l2.707 2.707a1 1 0 001.414-1.414L11.414 12l2.707-2.707a1 1 0 00-1.414-1.414L10 10.586V5z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-lg">${message}</p>
        <button id="retryPrayerTimes" class="mt-6 bg-amber-600 hover:bg-amber-500 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
          إعادة المحاولة
        </button>
      </div>
    `;

    const retryButton = document.getElementById('retryPrayerTimes');
    if (retryButton) {
      if (!retryButton.hasEventListener) { // منع إضافة المستمع أكثر من مرة
        retryButton.addEventListener('click', loadPrayerTimes);
        retryButton.hasEventListener = true;
      }
    }
  } else {
    console.error("Error: prayerTimesContent element not found when trying to show error.");
  }
}

// -----------------------------------------------------------------------------
// 4. تحميل مواقيت الصلاة (مع طلب الإذن، جلب المدينة، وحساب المواقيت)
// -----------------------------------------------------------------------------
async function loadPrayerTimes() {
  const prayerTimesContent = document.getElementById('prayerTimesContent');
  if (!prayerTimesContent) {
    console.error("Critical Error: prayerTimesContent element not found at the start of loadPrayerTimes.");
    return;
  }

  // متغير لمنع تكرار ربط onchange
  let permissionChangeListenerAttached = false;

  const showLoadingMessage = (message = "جار تحميل مواقيت الصلاة...") => {
    prayerTimesContent.innerHTML = `
      <div class="text-center">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-slate-400">${message}</p>
      </div>
    `;
  };

  const processLocationAndGetTimes = async (position) => {
    showLoadingMessage("جار جلب بيانات الصلاة...");
    const { latitude, longitude } = position.coords;

    try {
      const today = new Date();
      const month = today.getMonth() + 1;
      const year = today.getFullYear();

      let cityName = "موقعك الحالي";
      try {
        showLoadingMessage("جار تحديد اسم المدينة...");
        const cityResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=ar`);
        if (cityResponse.ok) {
          const cityData = await cityResponse.json();
          if (cityData.city) {
            cityName = cityData.city;
          } else if (cityData.locality) {
            cityName = cityData.locality;
          } else if (cityData.principalSubdivision) {
            cityName = cityData.principalSubdivision;
          }
        } else {
            console.warn("فشل جلب اسم المدينة:", cityResponse.status, await cityResponse.text().catch(()=> ""));
        }
      } catch (cityError) {
        console.warn("لم يتمكن من جلب اسم المدينة:", cityError);
      }

      showLoadingMessage("جار تحميل مواقيت الصلاة...");
      const prayerApiResponse = await fetch(`https://api.aladhan.com/v1/calendar/${year}/${month}?latitude=${latitude}&longitude=${longitude}&method=4`);

      if (!prayerApiResponse.ok) {
        const errorData = await prayerApiResponse.json().catch(() => ({ data: "خطأ غير معروف من الخادم" }));
        throw new Error(`فشل تحميل مواقيت الصلاة: ${prayerApiResponse.status} - ${errorData.data || prayerApiResponse.statusText}`);
      }

      const prayerData = await prayerApiResponse.json();

      if (prayerData && prayerData.data && Array.isArray(prayerData.data)) {
        const currentDay = today.getDate();
        const todayData = prayerData.data.find(d => parseInt(d.date.gregorian.day) === currentDay);

        if (todayData) {
          displayPrayerTimes(todayData, cityName);
        } else {
          throw new Error('لم يتم العثور على بيانات مواقيت الصلاة لهذا اليوم.');
        }
      } else {
        throw new Error('تنسيق بيانات مواقيت الصلاة المستلمة غير صحيح.');
      }
    } catch (apiError) {
      console.error('Error fetching prayer times or city from API:', apiError);
      showPrayerTimesError(`خطأ في جلب البيانات: ${apiError.message}`);
    }
  };

  const handleLocationError = (error) => {
    console.error('Geolocation error object:', error);
    let message = 'فشل تحديد الموقع. ';
    if (error && error.code) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          message = "تم رفض إذن الوصول إلى الموقع من قبلك. لا يمكن عرض مواقيت الصلاة الدقيقة بدون تحديد موقعك. يرجى تفعيل الإذن من إعدادات المتصفح أو السماح به عند الطلب مرة أخرى.";
          break;
        case error.POSITION_UNAVAILABLE:
          message += "معلومات الموقع غير متاحة حاليًا.";
          break;
        case error.TIMEOUT:
          message += "انتهت مهلة طلب تحديد الموقع. قد يكون اتصال الإنترنت بطيئًا أو أن خدمات الموقع غير مستجيبة.";
          break;
        default:
          message += `حدث خطأ غير معروف (رمز: ${error.code}).`;
          break;
      }
    } else {
      message = "حدث خطأ غير متوقع أثناء محاولة تحديد الموقع.";
    }
    showPrayerTimesError(message);
  };

  const locationOptions = {
    enableHighAccuracy: true, // محاولة الحصول على أدق موقع
    timeout: 25000,          // زيادة المهلة إلى 25 ثانية
    maximumAge: 300000       // قبول موقع مخبأ عمره حتى 5 دقائق
  };
  
  const requestActualLocation = () => {
      showLoadingMessage("جار طلب إذن الموقع وتحديد الإحداثيات...");
      navigator.geolocation.getCurrentPosition(
          processLocationAndGetTimes,
          handleLocationError,
          locationOptions
      );
  };

  if (!navigator.geolocation) {
    showPrayerTimesError('لا يتوفر دعم تحديد الموقع في المتصفح الخاص بك.');
    return;
  }

  // استخدام Permissions API إذا كانت مدعومة
  if (navigator.permissions && navigator.permissions.query) {
    try {
      const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
      
      const handlePermissionStateChange = (state) => {
        console.log(`Current permission state: ${state}`);

        if (state === 'granted') {
          showLoadingMessage("تم منح الإذن. جار تحديد الموقع...");
          requestActualLocation();
        } else if (state === 'prompt') {
          prayerTimesContent.innerHTML = `
            <div class="text-center p-6">
              <svg class="w-16 h-16 mx-auto mb-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
              <h3 class="text-xl font-semibold text-slate-100 mb-2">نحتاج إلى موقعك</h3>
              <p class="text-slate-400 mb-4">لعرض مواقيت الصلاة بدقة، يرجى السماح بالوصول إلى موقعك عندما يطلب المتصفح ذلك.</p>
              <button id="requestLocationPermissionBtn" class="bg-amber-500 hover:bg-amber-600 text-slate-900 px-6 py-3 rounded-lg font-bold transition-colors">
                السماح بالوصول للموقع
              </button>
              <p class="text-xs text-slate-500 mt-3">قد تحتاج إلى الضغط على "سماح" في النافذة المنبثقة للمتصفح.</p>
            </div>
          `;
          const requestBtn = document.getElementById('requestLocationPermissionBtn');
          if (requestBtn) {
            if (!requestBtn.hasEventListener) { // منع إضافة المستمع أكثر من مرة
              requestBtn.addEventListener('click', () => {
                  showLoadingMessage("يرجى الاستجابة لطلب الإذن من المتصفح...");
                  requestActualLocation(); // هذا سيُظهر نافذة طلب الإذن الفعلية للمتصفح
              });
              requestBtn.hasEventListener = true;
            }
          }
        } else if (state === 'denied') {
          showPrayerTimesError("تم رفض إذن الوصول إلى الموقع بشكل دائم. لا يمكن عرض مواقيت الصلاة الدقيقة بدون تحديد موقعك. يرجى تفعيل الإذن من إعدادات المتصفح (عادةً من شريط العنوان أو إعدادات الموقع للصفحة).");
        }
      };

      // التعامل مع الحالة الأولية للإذن
      handlePermissionStateChange(permissionStatus.state);

      // الاستماع لتغيرات حالة الإذن (إذا لم يتم ربط المستمع من قبل)
      if (!permissionChangeListenerAttached) {
          permissionStatus.onchange = () => {
              console.log('Location permission state changed to:', permissionStatus.state);
              handlePermissionStateChange(permissionStatus.state);
          };
          permissionChangeListenerAttached = true; // تعيين العلم بعد ربط المستمع
      }

    } catch (permError) {
      // إذا فشلت Permissions API (نادر، لكن احتياطًا)
      console.warn("لا يمكن التحقق من إذن الموقع باستخدام Permissions API, سنحاول طلب الموقع مباشرة:", permError);
      showLoadingMessage("جار طلب إذن الموقع..."); // رسالة أولية قبل الطلب المباشر
      requestActualLocation();
    }
  } else {
    // إذا لم تكن Permissions API مدعومة، نطلب الموقع مباشرة
    console.warn("Permissions API غير مدعوم, سنحاول طلب الموقع مباشرة.");
    showLoadingMessage("جار طلب إذن الموقع..."); // رسالة أولية قبل الطلب المباشر
    requestActualLocation();
  }
}

// -----------------------------------------------------------------------------
// 5. تحميل وإعداد كل شيء عند تحميل الصفحة
// -----------------------------------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('prayerTimesContent')) {
    loadPrayerTimes();
  } else {
    console.error("Initial Check: prayerTimesContent element not found on DOMContentLoaded.");
  }
});

// يمكنك إضافة هذا لترى كيف يتغير `permissionChangeListenerAttached`
// window.addEventListener('focus', async () => {
//     if (navigator.permissions && navigator.permissions.query) {
//         const status = await navigator.permissions.query({name: 'geolocation'});
//         console.log("Window focused, current permission state:", status.state);
//     }
// });
   
    // تحميل السور
    async function loadSurahs() {
      const surahsGrid = document.getElementById('surahsGrid');
      
      if (!surahsGrid) return;
      
      // إذا كانت السور محملة بالفعل
      if (allSurahs.length > 0 && surahsGrid.querySelector('.surah-card')) {
        return;
      }
      
      // عرض رسالة التحميل
      surahsGrid.innerHTML = `
        <div class="text-center col-span-full">
          <div class="loader mx-auto"></div>
          <p class="mt-4 text-slate-400">جار تحميل السور...</p>
        </div>
      `;
      
      try {
        // التحقق مما إذا كانت السور محملة بالفعل
        if (allSurahs.length === 0) {
          await loadQuranData();
        }
        
        // عرض السور
        displaySurahs(allSurahs);
        
        // إضافة مستمعات أحداث تصفية السور
        initSurahFilters();
      } catch (error) {
        console.error('Error loading surahs:', error);
        surahsGrid.innerHTML = `
          <div class="text-center col-span-full text-red-400 p-6">
            <svg class="w-12 h-12 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <p>حدث خطأ أثناء تحميل السور. يرجى إعادة المحاولة.</p>
            <button id="retrySurahs" class="mt-4 bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg">
              إعادة المحاولة
            </button>
          </div>
        `;
        
        // إضافة حدث إعادة المحاولة
        document.getElementById('retrySurahs').addEventListener('click', loadSurahs);
      }
    }
    
    // عرض السور في الواجهة
    function displaySurahs(surahs) {
      const surahsGrid = document.getElementById('surahsGrid');
      
      if (!surahsGrid || !Array.isArray(surahs)) {
        return;
      }

      surahsGrid.innerHTML = '';
      
      surahs.forEach(surah => {
        const surahCard = document.createElement('div');
        surahCard.className = 'surah-card fade-in';
        surahCard.setAttribute('data-surah', surah.number);
        surahCard.setAttribute('data-revelation', surah.revelationType.toLowerCase());
        
        surahCard.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <span class="bg-amber-500/20 text-amber-400 px-2 py-1 rounded-lg text-sm">${surah.number}</span>
              <h3 class="text-xl font-semibold text-amber-400 mt-2">${surah.name}</h3>
              <p class="text-slate-400 text-sm">${surah.englishName}</p>
            </div>
            <div class="text-right">
              <span class="text-xs text-slate-500 block">${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'}</span>
              <span class="text-slate-400 block mt-1">${surah.ayahs.length} آية</span>
            </div>
          </div>
        `;
        
        surahCard.addEventListener('click', () => {
          showSurahModal(surah.number);
        });
        
        surahsGrid.appendChild(surahCard);
      });
    }
    
    // تهيئة تصفية السور
    function initSurahFilters() {
      const filterButtons = document.querySelectorAll('.surah-filter-btn');
      const surahCards = document.querySelectorAll('.surah-card');
      
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          const filter = button.getAttribute('data-filter');
          
          // تحديث حالة الأزرار
          filterButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // تصفية السور
          surahCards.forEach(card => {
            if (filter === 'all') {
              card.style.display = '';
            } else if (filter === 'makkah' && card.getAttribute('data-revelation') === 'meccan') {
              card.style.display = '';
            } else if (filter === 'madinah' && card.getAttribute('data-revelation') === 'medinan') {
              card.style.display = '';
        } else {
              card.style.display = 'none';
            }
          });
        });
      });
    }
    
    // عرض تفاصيل السورة
    async function showSurahModal(surahNumber) {
      const surahModal = document.getElementById('surahModal');
      const surahModalTitle = document.getElementById('surahModalTitle');
      const surahContent = document.getElementById('surahContent');
      
      if (!surahModal || !surahModalTitle || !surahContent) {
        return;
      }
      
      // إظهار النافذة
      surahModal.classList.remove('hidden');
      setTimeout(() => {
        surahModal.classList.remove('opacity-0');
      }, 10);
      
      // عرض رسالة التحميل
      surahContent.innerHTML = `
        <div class="text-center p-6">
          <div class="loader mx-auto"></div>
          <p class="mt-4 text-slate-400">جار تحميل السورة...</p>
        </div>
      `;
      
      try {
        // التحقق مما إذا كانت السور محملة بالفعل
        if (allSurahs.length === 0) {
          await loadQuranData();
        }
        
        // البحث عن السورة المطلوبة
        const surah = allSurahs.find(s => s.number == surahNumber);
        
        if (!surah) {
          throw new Error(`السورة رقم ${surahNumber} غير موجودة`);
        }
        
        // تحديث عنوان النافذة
        surahModalTitle.textContent = `سورة ${surah.name}`;
        
        // عرض محتوى السورة
        let content = `
          <div class="text-center mb-6">
            <h2 class="text-2xl font-semibold text-amber-400">سورة ${surah.name}</h2>
            <p class="text-slate-400">${surah.ayahs.length} آية - ${surah.revelationType === 'Meccan' ? 'مكية' : 'مدنية'}</p>
            ${surah.number !== 9 ? '<div class="font-quran mt-4 text-amber-400">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>' : ''}
          </div>
          <div class="font-quran mb-8 leading-loose">
        `;
        
        // إضافة الآيات
        surah.ayahs.forEach(ayah => {
          content += `
            <span class="ayah-text" data-ayah="${ayah.number}">${ayah.text} 
              <span class="text-amber-500 text-lg mx-1">${getArabicNumber(ayah.numberInSurah)}</span>
            </span>
          `;
        });
        
        content += `</div>`;
        
        surahContent.innerHTML = content;
        
        // إضافة مستمعات أحداث للآيات
        surahContent.querySelectorAll('.ayah-text').forEach(ayahElement => {
          ayahElement.addEventListener('click', () => {
            const ayahNumber = ayahElement.getAttribute('data-ayah');
            if (ayahNumber) {
              playAyah(ayahNumber, ayahElement);
            }
        });
      });
        
        // إضافة مستمع حدث لزر تشغيل السورة
        const playSurahBtn = document.getElementById('playSurahBtn');
        if (playSurahBtn) {
          playSurahBtn.onclick = () => playSurah(surah);
        }
      } catch (error) {
        console.error('Error showing surah:', error);
        surahContent.innerHTML = `
          <div class="text-center text-red-400 p-6">
            <svg class="w-12 h-12 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <p>${error.message || 'حدث خطأ أثناء تحميل السورة'}</p>
            <button id="retrySurah" class="mt-4 bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded-lg">
              إعادة المحاولة
            </button>
          </div>
        `;
        
        // إضافة حدث إعادة المحاولة
        document.getElementById('retrySurah').addEventListener('click', () => showSurahModal(surahNumber));
      }
    }
    
    // تشغيل السورة كاملة
    function playSurah(surah) {
      if (!surah || !surah.ayahs || surah.ayahs.length === 0) {
        return;
      }
      
      // الحصول على رمز القارئ الحالي
      const readerCode = currentReciter || 'ar.alafasy';
      
      const playNextAyah = (index) => {
        if (index >= surah.ayahs.length) {
          return; // انتهت السورة
        }
        
        const ayah = surah.ayahs[index];
        const ayahElement = document.querySelector(`.ayah-text[data-ayah="${ayah.number}"]`);
        
        // تحديث شريط التقدم
        const progress = ((index + 1) / surah.ayahs.length) * 100;
        document.getElementById('surahProgress').style.width = `${progress}%`;
        
        // توليد عنوان الصوت باستخدام القالب الجديد
        const audioUrl = QURAN_READERS.url_template
          .replace('{code}', readerCode)
          .replace('{ayah_number}', ayah.number);
        
        audioPlayer.src = audioUrl;
        audioPlayer.onended = () => {
          playNextAyah(index + 1);
        };
        
        audioPlayer.onerror = () => {
          console.error(`Error playing ayah ${ayah.number}`);
          playNextAyah(index + 1); // تخطي الآية التي لا يمكن تشغيلها
        };
        
        // تمرير إلى الآية الحالية
        if (ayahElement) {
          ayahElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // إزالة التمييز من الآية السابقة
          document.querySelectorAll('.ayah-text').forEach(el => el.classList.remove('bg-amber-500/20'));
          
          // تمييز الآية الحالية
          ayahElement.classList.add('bg-amber-500/20');
        }
        
        audioPlayer.play().catch(error => {
          console.error('Error playing audio:', error);
          playNextAyah(index + 1); // تخطي الآية التي لا يمكن تشغيلها
        });
      };
      
      // بدء تشغيل السورة من الآية الأولى
      playNextAyah(0);
    }
    
    // تحويل الأرقام الإنجليزية إلى أرقام عربية
    function getArabicNumber(num) {
      const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
      return String(num).replace(/[0-9]/g, (d) => arabicNumbers[parseInt(d)]);
    }
    
    // إنشاء قائمة اختيار القارئ المضمنة
    // إنشاء واجهات API محلية لمعالجة أخطاء 404
   // داخل (function setupMockAPIs() { ... })();
(function setupMockAPIs() {
  console.log('🔧 إعداد واجهات API محلية...');
  const originalFetch = window.fetch;

  window.fetch = function(url, options) {
    let urlToFetch = url; // استخدم متغيرًا جديدًا لتجنب تعديل url الأصلية بشكل غير متوقع

    if (typeof url === 'string') {
        const urlObj = new URL(url, window.location.origin);
        const pathname = urlObj.pathname;

        // تغيير المنفذ فقط لطلبات API المحددة التي تحتاج لذلك
        if (urlObj.hostname === '127.0.0.1' && pathname.startsWith('/api/')) { // مثال: فقط طلبات /api/
            // افترض أن خادم الواجهة الأمامية على 3000 والخادم الخلفي للـ API على 3002
            if (window.location.port === '3000') { // تأكد أنك على خادم الواجهة الأمامية
                 urlObj.port = '3002';
                 urlToFetch = urlObj.toString();
                 console.log(`🔄 توجيه طلب API ${pathname} إلى المنفذ 3002: ${urlToFetch}`);
            }
        }

        // اعتراض طلبات API المحددة للـ Mock (إذا لم يتم توجيهها بالفعل)
        if (pathname === '/api/health' && urlObj.port !== '3002') { // تحقق أنه ليس الطلب الموجه
          console.log('🔄 استخدام واجهة API محلية: /api/health');
          return Promise.resolve({ /* ... mock response ... */ });
        }
    }
    // استخدام fetch الأصلي
    return originalFetch(urlToFetch, options);
  };
})()
     
    // إضافة وظيفة لعرض آية اليوم عند فتح الصفحة
    function showDailyVerse() {
      // التحقق مما إذا تم عرض آية اليوم من قبل في نفس اليوم
      const today = new Date().toDateString();
      const lastShown = localStorage.getItem('quran-daily-verse-date');
      
      if (lastShown === today && !window.location.search.includes('force_daily=true')) {
        console.log('تم عرض آية اليوم بالفعل');
        return;
      }
      
      // الحصول على آية عشوائية من القرآن
      if (!allAyahs || allAyahs.length === 0) {
        console.log('لا توجد آيات متاحة لعرض آية اليوم');
        setTimeout(showDailyVerse, 2000); // إعادة المحاولة بعد 2 ثانية
        return;
      }
      
      // اختيار آية عشوائية
      const randomIndex = Math.floor(Math.random() * allAyahs.length);
      const dailyVerse = allAyahs[randomIndex];
      const surah = allSurahs.find(s => s.number === dailyVerse.surahNumber);
      
      if (!dailyVerse || !surah) {
        console.log('خطأ في اختيار آية اليوم');
        return;
      }
      
      // إنشاء عنصر لعرض آية اليوم
      const dailyVerseElement = document.createElement('div');
      dailyVerseElement.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
      dailyVerseElement.id = 'daily-verse-modal';
      
      dailyVerseElement.innerHTML = `
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl w-full max-w-2xl p-6 relative border border-amber-500/30 shadow-2xl fade-in">
          <button id="close-daily-verse" class="absolute top-4 right-4 text-slate-400 hover:text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          
          <h2 class="text-center text-2xl text-amber-400 mb-2">آية اليوم</h2>
          <div class="text-center text-slate-400 mb-6">${today}</div>
          
          <div class="text-center font-quran-sm leading-relaxed mb-4 text-slate-200">${dailyVerse.text}</div>
          
          <div class="text-center text-amber-400 mb-4">
            سورة ${surah.name} - الآية ${dailyVerse.numberInSurah}
          </div>
          
          <div class="flex justify-center space-x-4 rtl:space-x-reverse">
            <button id="listen-daily-verse" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg transition-colors">
              <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
              </svg>
              استمع
            </button>
            <button id="share-daily-verse" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg transition-colors">
              <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
              </svg>
              مشاركة
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(dailyVerseElement);
      
      // إضافة مستمعات الأحداث
      document.getElementById('close-daily-verse').addEventListener('click', () => {
        dailyVerseElement.remove();
        // حفظ تاريخ العرض
        localStorage.setItem('quran-daily-verse-date', today);
      });
      
      document.getElementById('listen-daily-verse').addEventListener('click', () => {
        playAyah(dailyVerse.ayahGlobalNumber, document.getElementById('listen-daily-verse'));
      });
      
      document.getElementById('share-daily-verse').addEventListener('click', () => {
        try {
          const shareText = `"${dailyVerse.text}"\n\nسورة ${surah.name} - الآية ${dailyVerse.numberInSurah}\n\nتطبيق القرآن الكريم`;
          
          if (navigator.share) {
            navigator.share({
              title: 'آية اليوم من القرآن الكريم',
              text: shareText
            });
          } else {
            // نسخ النص إلى الحافظة
            const textArea = document.createElement('textarea');
            textArea.value = shareText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // إظهار رسالة التأكيد
            alert('تم نسخ الآية إلى الحافظة');
          }
        } catch (error) {
          console.error('خطأ في مشاركة الآية:', error);
        }
      });
    }

    // Start the application
    init();
    
    // عرض آية اليوم بعد تحميل الصفحة
    window.addEventListener('load', () => {
      setTimeout(showDailyVerse, 1500);
    });
// تم نقل هذه المتغيرات إلى الأعلى - 
// تم نقل هذه المتغيرات إلى الأعلى - //     // متغيرات عامة لنظام التحميل الكسول
// تم نقل هذه المتغيرات إلى الأعلى - //     let allSearchResults = [];
// تم نقل هذه المتغيرات إلى الأعلى - //     let currentDisplayedResults = 0;
// تم نقل هذه المتغيرات إلى الأعلى - //     const resultsPerPage = 5;
// تم نقل هذه المتغيرات إلى الأعلى - //     let isLoadingMore = false;
// تم نقل هذه المتغيرات إلى الأعلى - //     let searchResultsObserver = null;

    // تحميل المزيد من نتائج البحث
    function loadMoreResults() {
      // التأكد من وجود نتائج للتحميل
      if (!allSearchResults || currentDisplayedResults >= allSearchResults.length) {
        return;
      }
      
      // إظهار مؤشر التحميل
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.classList.remove('hidden');
      }
      
      // تعطيل زر التحميل مؤقتاً
      const loadMoreButton = document.getElementById('loadMoreButton');
      if (loadMoreButton) {
        loadMoreButton.disabled = true;
        loadMoreButton.textContent = 'جار التحميل...';
      }
      
      // تأخير قصير لإظهار مؤشر التحميل (تحسين تجربة المستخدم)
      setTimeout(() => {
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        
        if (!searchResultsContainer || !loadMoreContainer) {
          return;
        }
        
        // تحديد النتائج التي سيتم تحميلها
        const startIndex = currentDisplayedResults;
        const endIndex = Math.min(startIndex + 5, allSearchResults.length);
        const nextBatch = allSearchResults.slice(startIndex, endIndex);
        
        // إضافة البطاقات الجديدة
        nextBatch.forEach((result, index) => {
          const card = createResultCard(result, '', startIndex + index);
          searchResultsContainer.insertBefore(card, loadMoreContainer);
          
          // تطبيق تأثير الظهور التدريجي
          setTimeout(() => {
            card.classList.add('opacity-100', 'translate-y-0');
          }, 10 * index);
        });
        
        // تحديث عدد النتائج المعروضة
        currentDisplayedResults = endIndex;
        
        // إخفاء مؤشر التحميل
        if (loadingIndicator) {
          loadingIndicator.classList.add('hidden');
        }
        
        // تحديث زر التحميل
        if (loadMoreButton) {
          loadMoreButton.disabled = false;
          
          if (currentDisplayedResults >= allSearchResults.length) {
            // إزالة زر التحميل إذا تم عرض جميع النتائج
            loadMoreContainer.remove();
          } else {
            // تحديث نص الزر
            loadMoreButton.textContent = `تحميل المزيد من النتائج (${allSearchResults.length - currentDisplayedResults})`;
          }
        }
      }, 300);
    }
    
    // إعداد مراقب التمرير للتحميل التلقائي
    function setupScrollObserver() {
      // إلغاء المراقب السابق إذا كان موجوداً
      if (searchResultsObserver) {
        searchResultsObserver.disconnect();
      }
      
      const loadMoreContainer = document.getElementById('loadMoreContainer');
      
      if (!loadMoreContainer) {
        return;
      }
      
      // إنشاء مراقب جديد
      searchResultsObserver = new IntersectionObserver((entries) => {
        // التحقق من ظهور عنصر التحميل في الشاشة
        if (entries[0].isIntersecting && !isLoadingMore) {
          // تعيين علم التحميل
          isLoadingMore = true;
          
          // تحميل المزيد من النتائج
          loadMoreResults();
          
          // إعادة تعيين علم التحميل بعد فترة
          setTimeout(() => {
            isLoadingMore = false;
          }, 1000);
        }
      }, {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      });
      
      // بدء مراقبة عنصر التحميل
      searchResultsObserver.observe(loadMoreContainer);
    }

    // إعادة زر التشغيل إلى حالته الأصلية
    function resetPlayButton(button) {
      if (!button) return;
      
        button.innerHTML = `
          <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
          </svg>
          استمع
        `;
        button.disabled = false;
    }

    // عرض نافذة اختيار القارئ
    function showReciterModal() {
      // إنشاء نافذة منبثقة
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm fade-in';
      
      // إنشاء محتوى النافذة
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-slate-800 rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto fade-in';
      
      // إنشاء عنوان النافذة
      const title = document.createElement('div');
      title.className = 'flex justify-between items-center mb-4';
      title.innerHTML = `
        <h3 class="text-xl font-semibold text-amber-400">اختيار القارئ</h3>
        <button id="close-reciter-modal" class="text-slate-400 hover:text-amber-400">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      
      // إنشاء حاوية البطاقات
      const cardsContainer = document.createElement('div');
      cardsContainer.className = 'grid grid-cols-2 gap-3 mt-4 max-h-[60vh] overflow-y-auto custom-scrollbar p-2';
      
      // إضافة القراء من قائمة QURAN_READERS
      QURAN_READERS.readers.forEach(reader => {
        const card = document.createElement('div');
        card.className = `p-3 rounded-lg cursor-pointer transition-all duration-200 text-center ${reader.code === currentReciter ? 'bg-amber-600 text-white' : 'bg-slate-700 hover:bg-slate-600 text-slate-200'}`;
        card.dataset.code = reader.code;
        card.innerHTML = `
          <div class="text-sm font-semibold">${reader.name}</div>
        `;
        
        // إضافة حدث النقر لاختيار القارئ
        card.addEventListener('click', () => {
          // إزالة التحديد من جميع البطاقات
          cardsContainer.querySelectorAll('div[data-code]').forEach(item => {
            item.className = 'p-3 rounded-lg cursor-pointer transition-all duration-200 text-center bg-slate-700 hover:bg-slate-600 text-slate-200';
          });
          
          // تحديد البطاقة المختارة
          card.className = 'p-3 rounded-lg cursor-pointer transition-all duration-200 text-center bg-amber-600 text-white';
          
          // تحديث القارئ الحالي
          currentReciter = reader.code;
          
          // حفظ الإعدادات
          saveUserSettings();
          
          // إظهار رسالة تأكيد
          const confirmMessage = document.createElement('div');
          confirmMessage.className = 'mt-3 text-center text-emerald-400 text-sm fade-in';
          confirmMessage.textContent = `تم اختيار ${reader.name} كقارئ افتراضي`;
          modalContent.appendChild(confirmMessage);
          
          // إغلاق النافذة بعد 1.5 ثانية
          setTimeout(() => {
            modal.classList.add('fade-out');
            setTimeout(() => {
              document.body.removeChild(modal);
            }, 500);
          }, 1500);
        });
        
        cardsContainer.appendChild(card);
      });
      
      // إضافة العناصر إلى النافذة
      modalContent.appendChild(title);
      modalContent.appendChild(cardsContainer);
      modal.appendChild(modalContent);
      
      // إضافة النافذة إلى الصفحة
      document.body.appendChild(modal);
      
      // إضافة حدث إغلاق النافذة
      document.getElementById('close-reciter-modal').addEventListener('click', () => {
        modal.classList.add('fade-out');
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 500);
      });
      
      // إغلاق النافذة عند النقر خارجها
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.add('fade-out');
          setTimeout(() => {
            document.body.removeChild(modal);
          }, 500);
        }
      });
    }

    // تحديث شكل زر التشغيل للإشارة إلى الخطأ
    function setPlayButtonToError(button) {
      if (!button) return;
      
      button.innerHTML = `
        <svg class="w-4 h-4 inline mr-2 text-red-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        خطأ
      `;
      button.disabled = false;
    }
    
    // تسجيل Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker مسجل بنجاح:', registration.scope);
          })
          .catch(error => {
            console.error('فشل تسجيل Service Worker:', error);
          });
      });
    }

    // كشف حالة الاتصال بالإنترنت
    function updateOnlineStatus() {
      let offlineMessage = document.getElementById('offlineMessage');
      
      // إنشاء عنصر الرسالة إذا لم يكن موجوداً
      if (!offlineMessage) {
        offlineMessage = document.createElement('div');
        offlineMessage.id = 'offlineMessage';
        offlineMessage.className = 'fixed bottom-0 left-0 right-0 p-2 bg-red-900 text-white text-center transform transition-transform duration-300 translate-y-full';
        offlineMessage.style.zIndex = '9999';
        offlineMessage.textContent = 'أنت غير متصل بالإنترنت. بعض الميزات قد لا تعمل.';
        document.body.appendChild(offlineMessage);
      }
      
      // تحديث حالة الرسالة بناءً على حالة الاتصال
      if (navigator.onLine) {
        offlineMessage.classList.add('translate-y-full');
      } else {
        offlineMessage.classList.remove('translate-y-full');
      }
    }

    // إضافة دالة للتحقق من الاتصال الفعلي بالإنترنت
    function checkRealConnection() {
      return new Promise((resolve) => {
        const timeoutId = setTimeout(() => {
          // إذا لم يتم الرد خلال الوقت المحدد، نفترض أن الاتصال غير موجود
          resolve(false);
        }, 3000);

        fetch('https://www.google.com/favicon.ico', { 
          mode: 'no-cors',
          cache: 'no-store'
        })
        .then(() => {
          clearTimeout(timeoutId);
          resolve(true);
        })
        .catch(() => {
          clearTimeout(timeoutId);
          resolve(false);
        });
      });
    }

    // دالة محسنة للتحقق من حالة الاتصال وتحديث الواجهة
    async function checkConnectionAndUpdate() {
      const isReallyOnline = await checkRealConnection();
      const offlineMessage = document.getElementById('offlineMessage');
      
      if (!offlineMessage) {
        updateOnlineStatus(); // إنشاء العنصر أولاً
        return checkConnectionAndUpdate(); // إعادة المحاولة بعد إنشاء العنصر
      }
      
      if (isReallyOnline) {
        offlineMessage.classList.add('translate-y-full');
      } else {
        offlineMessage.classList.remove('translate-y-full');
      }
    }

    // استدعاء الدالة المحسنة عند تغير حالة الاتصال
    window.addEventListener('online', checkConnectionAndUpdate);
    window.addEventListener('offline', checkConnectionAndUpdate);
    window.addEventListener('load', () => {
      updateOnlineStatus(); // إنشاء العنصر
      checkConnectionAndUpdate(); // التحقق من حالة الاتصال الفعلية
    });
    
    // التحقق من حالة الاتصال بشكل دوري
    setInterval(checkConnectionAndUpdate, 30000); // التحقق كل 30 ثانية
  </script>

  <!-- زر اختيار القارئ الثابت -->
  <div id="floating-reciter-button" class="fixed bottom-6 left-6 bg-amber-600 hover:bg-amber-500 text-white rounded-full p-3 shadow-lg cursor-pointer z-40 transition-all duration-300 transform hover:scale-110" title="اختيار القارئ">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
    </svg>
  </div>
</body>
</html>
